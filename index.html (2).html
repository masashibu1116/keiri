<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¨ãƒ ã‚ºã‚¤ãƒ³ãƒ†ãƒªã‚¢ çµŒç†ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic Pro', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro W3', 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 20px;
            background: #fff;
            border: none;
            border-right: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
            position: relative;
            min-width: 120px;
        }

        .tab:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .content {
            padding: 30px;
            min-height: 600px;
            background: #fff;
        }

        .sheet {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .sheet.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .form-col {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-not-invoiced {
            background: #e9ecef;
            color: #495057;
        }

        .status-unpaid {
            background: #ffebee;
            color: #c62828;
        }

        .status-partial {
            background: #fff3e0;
            color: #ef6c00;
        }

        .status-paid {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .summary-card {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid;
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card h3 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 1.1rem;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .summary-card.primary { border-left-color: #667eea; }
        .summary-card.success { border-left-color: #56ab2f; }
        .summary-card.warning { border-left-color: #f093fb; }
        .summary-card.danger { border-left-color: #ff6b6b; }

        .summary-card.primary .summary-value { color: #667eea; }
        .summary-card.success .summary-value { color: #56ab2f; }
        .summary-card.warning .summary-value { color: #f093fb; }
        .summary-card.danger .summary-value { color: #ff6b6b; }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .payment-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }

        .aging-30 { background-color: #ffebee !important; }
        .aging-15 { background-color: #fff3e0 !important; }
        .aging-current { background-color: #e8f5e8 !important; }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .content {
                padding: 15px;
            }

            .form-row {
                flex-direction: column;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                min-width: auto;
                text-align: center;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                font-size: 0.9rem;
            }

            th, td {
                padding: 10px 5px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            input, select, textarea, .btn {
                font-size: 14px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  ã‚¨ãƒ ã‚ºã‚¤ãƒ³ãƒ†ãƒªã‚¢ çµŒç†ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>å·¥äº‹ç®¡ç†ãƒ»çµŒè²»ãƒ»è«‹æ±‚æ›¸ãƒ»å…¥é‡‘ç®¡ç†ã‚’ä¸€å…ƒåŒ–</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showSheet('construction')">ğŸ—ï¸ å·¥äº‹å°å¸³</button>
            <button class="tab" onclick="showSheet('expenses')">ğŸ’° çµŒè²»ç®¡ç†</button>
            <button class="tab" onclick="showSheet('purchases')">ğŸ›’ ä»•å…¥ã‚Œç®¡ç†</button>
            <button class="tab" onclick="showSheet('invoices')">ğŸ“‹ è«‹æ±‚æ›¸</button>
            <button class="tab" onclick="showSheet('payments')">ğŸ’³ å…¥é‡‘è¨˜éŒ²</button>
            <button class="tab" onclick="showSheet('receivables')">ğŸ“Š å£²æ›é‡‘ç®¡ç†</button>
            <button class="tab" onclick="showSheet('cashflow')">ğŸ’¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼</button>
            <button class="tab" onclick="showSheet('monthly')">ğŸ“ˆ æœˆæ¬¡æç›Š</button>
            <button class="tab" onclick="showSheet('yearly')">ğŸ“… å¹´æ¬¡åˆ†æ</button>
            <button class="tab" onclick="showSheet('tax')">ğŸ§¾ ç¨å‹™è³‡æ–™</button>
            <button class="tab" onclick="showSheet('manual')">ğŸ“– ä½¿ã„æ–¹</button>
        </div>
        <div class="content">
            <!-- å·¥äº‹å°å¸³ -->
            <div id="construction-sheet" class="sheet active">
                <h2>ğŸ—ï¸ å·¥äº‹å°å¸³ç®¡ç†</h2>

                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="projectName">å·¥äº‹å *</label>
                            <input type="text" id="projectName" required>
                        </div>
                        <div class="form-col">
                            <label for="clientName">é¡§å®¢å *</label>
                            <input type="text" id="clientName" required>
                        </div>
                        <div class="form-col">
                            <label for="projectDate">å·¥äº‹é–‹å§‹æ—¥</label>
                            <input type="date" id="projectDate">
                        </div>
                        <div class="form-col">
                            <label for="completionDate">å®Œäº†äºˆå®šæ—¥</label>
                            <input type="date" id="completionDate">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="contractAmount">å¥‘ç´„é‡‘é¡ï¼ˆå††ï¼‰</label>
                            <input type="number" id="contractAmount" min="0">
                        </div>
                        <div class="form-col">
                            <label for="projectStatus">å·¥äº‹çŠ¶æ³</label>
                            <select id="projectStatus">
                                <option value="è¨ˆç”»ä¸­">è¨ˆç”»ä¸­</option>
                                <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
                                <option value="å®Œäº†">å®Œäº†</option>
                                <option value="ä¸­æ–­">ä¸­æ–­</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="projectLocation">å·¥äº‹å ´æ‰€</label>
                            <input type="text" id="projectLocation">
                        </div>
                        <div class="form-col">
                            <label for="projectManager">æ‹…å½“è€…</label>
                            <input type="text" id="projectManager">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="projectNotes">å‚™è€ƒ</label>
                        <textarea id="projectNotes" placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="addProject()">å·¥äº‹ã‚’ç™»éŒ²</button>
                    <button class="btn btn-info" onclick="exportProjectsCSV()">CSVå‡ºåŠ›</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>å·¥äº‹å</th>
                                <th>é¡§å®¢å</th>
                                <th>å¥‘ç´„é‡‘é¡</th>
                                <th>é–‹å§‹æ—¥</th>
                                <th>å®Œäº†äºˆå®š</th>
                                <th>çŠ¶æ³</th>
                                <th>å…¥é‡‘çŠ¶æ³</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- çµŒè²»ç®¡ç† -->
            <div id="expenses-sheet" class="sheet">
                <h2>ğŸ’° çµŒè²»ç®¡ç†</h2>

                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="expenseProject">é–¢é€£å·¥äº‹</label>
                            <select id="expenseProject">
                                <option value="">å·¥äº‹ã‚’é¸æŠ</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="expenseDate">æ”¯å‡ºæ—¥ *</label>
                            <input type="date" id="expenseDate" required>
                        </div>
                        <div class="form-col">
                            <label for="expenseCategory">è²»ç›® *</label>
                            <select id="expenseCategory" required>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="ææ–™è²»">ææ–™è²»</option>
                                <option value="å¤–æ³¨è²»">å¤–æ³¨è²»</option>
                                <option value="äº¤é€šè²»">äº¤é€šè²»</option>
                                <option value="å·¥å…·è³¼å…¥è²»">å·¥å…·è³¼å…¥è²»</option>
                                <option value="æ¶ˆè€—å“è²»">æ¶ˆè€—å“è²»</option>
                                <option value="é€šä¿¡è²»">é€šä¿¡è²»</option>
                                <option value="åºƒå‘Šå®£ä¼è²»">åºƒå‘Šå®£ä¼è²»</option>
                                <option value="æ¥å¾…äº¤éš›è²»">æ¥å¾…äº¤éš›è²»</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="expenseAmount">é‡‘é¡ï¼ˆå††ï¼‰ *</label>
                            <input type="number" id="expenseAmount" min="0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="expenseSupplier">å–å¼•å…ˆ</label>
                            <input type="text" id="expenseSupplier">
                        </div>
                        <div class="form-col">
                            <label for="expensePayment">æ”¯æ‰•æ–¹æ³•</label>
                            <select id="expensePayment">
                                <option value="ç¾é‡‘">ç¾é‡‘</option>
                                <option value="éŠ€è¡ŒæŒ¯è¾¼">éŠ€è¡ŒæŒ¯è¾¼</option>
                                <option value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</option>
                                <option value="å°åˆ‡æ‰‹">å°åˆ‡æ‰‹</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="expenseReceipt">é ˜åæ›¸ç•ªå·</label>
                            <input type="text" id="expenseReceipt">
                        </div>
                        <div class="form-col">
                            <label for="taxDeductible">ç¨å‹™åŒºåˆ†</label>
                            <select id="taxDeductible">
                                <option value="èª²ç¨">èª²ç¨</option>
                                <option value="éèª²ç¨">éèª²ç¨</option>
                                <option value="ä¸èª²ç¨">ä¸èª²ç¨</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="expenseDescription">æ‘˜è¦ãƒ»è©³ç´°</label>
                        <textarea id="expenseDescription" placeholder="æ”¯å‡ºå†…å®¹ã®è©³ç´°ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="addExpense()">çµŒè²»ã‚’ç™»éŒ²</button>
                    <button class="btn btn-info" onclick="exportExpensesCSV()">CSVå‡ºåŠ›</button>
                </div>

                <div class="summary-grid">
                    <div class="summary-card primary">
                        <h3>ä»Šæœˆã®ç·çµŒè²»</h3>
                        <div class="summary-value" id="monthlyExpenses">Â¥0</div>
                        <p>å‰æœˆæ¯”è¼ƒã‚‚è¡¨ç¤ºäºˆå®š</p>
                    </div>
                    <div class="summary-card warning">
                        <h3>æœ€å¤šè²»ç›®</h3>
                        <div class="summary-value" id="topExpenseCategory">-</div>
                        <p>ä»Šæœˆã®çµŒè²»åˆ†æ</p>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>é–¢é€£å·¥äº‹</th>
                                <th>è²»ç›®</th>
                                <th>é‡‘é¡</th>
                                <th>å–å¼•å…ˆ</th>
                                <th>æ”¯æ‰•æ–¹æ³•</th>
                                <th>æ‘˜è¦</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ä»•å…¥ã‚Œç®¡ç† -->
            <div id="purchases-sheet" class="sheet">
                <h2>ğŸ›’ ä»•å…¥ã‚Œç®¡ç†</h2>

                <div class="alert alert-info" style="background: #e3f2fd; color: #01579b; border: 1px solid #81d4fa; margin-bottom: 20px;">
                    <strong>ğŸ’¡ ä»•å…¥ã‚Œç®¡ç†ã®æµã‚Œ</strong><br>
                    â‘  ç¾å ´ã”ã¨ã«ç™ºæ³¨ã—ãŸä»•å…¥ã‚Œã‚’è¨˜éŒ² â†’ â‘¡ æœˆæœ«ã«ä»•å…¥å…ˆã‹ã‚‰è«‹æ±‚æ›¸ãŒå±Šã â†’ â‘¢ ç¿Œæœˆã«æ”¯æ‰•ã†<br>
                    ã€Œè«‹æ±‚æœˆã€ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€æœˆã”ã¨ã®æ”¯æ‰•äºˆå®šã‚’ç®¡ç†ã§ãã¾ã™ã€‚
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="purchaseProject">é–¢é€£å·¥äº‹</label>
                            <select id="purchaseProject">
                                <option value="">å·¥äº‹ã‚’é¸æŠ</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="purchaseDate">ä»•å…¥æ—¥ *</label>
                            <input type="date" id="purchaseDate" required>
                        </div>
                        <div class="form-col">
                            <label for="purchaseCategory">ä»•å…¥ã‚Œç¨®åˆ¥ *</label>
                            <select id="purchaseCategory" required>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="ææ–™ãƒ»è³‡æ">ææ–™ãƒ»è³‡æ</option>
                                <option value="å•†å“">å•†å“</option>
                                <option value="è¨­å‚™æ©Ÿå™¨">è¨­å‚™æ©Ÿå™¨</option>
                                <option value="éƒ¨å“">éƒ¨å“</option>
                                <option value="ä»€å™¨">ä»€å™¨</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="purchaseAmount">ä»•å…¥ã‚Œé‡‘é¡ï¼ˆå††ï¼‰ *</label>
                            <input type="number" id="purchaseAmount" min="0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="purchaseSupplier">ä»•å…¥ã‚Œå…ˆ *</label>
                            <input type="text" id="purchaseSupplier" required>
                        </div>
                        <div class="form-col">
                            <label for="purchaseBillingMonth">è«‹æ±‚æœˆï¼ˆæœˆæœ«ç· ã‚ï¼‰</label>
                            <input type="month" id="purchaseBillingMonth" placeholder="ä¾‹: 2024-11">
                            <small style="color: #666;">ä»•å…¥å…ˆã‹ã‚‰è«‹æ±‚ãŒæ¥ã‚‹æœˆã‚’æŒ‡å®š</small>
                        </div>
                        <div class="form-col">
                            <label for="purchasePaymentMonth">æ”¯æ‰•äºˆå®šæœˆï¼ˆç¿Œæœˆæ‰•ã„ï¼‰</label>
                            <input type="month" id="purchasePaymentMonth" placeholder="ä¾‹: 2024-12">
                            <small style="color: #666;">å®Ÿéš›ã«æ”¯æ‰•ã†æœˆã‚’æŒ‡å®š</small>
                        </div>
                        <div class="form-col">
                            <label for="purchasePaymentStatus">æ”¯æ‰•çŠ¶æ³</label>
                            <select id="purchasePaymentStatus">
                                <option value="æœªè«‹æ±‚">æœªè«‹æ±‚ï¼ˆç™ºæ³¨ã®ã¿ï¼‰</option>
                                <option value="è«‹æ±‚æ¸ˆãƒ»æœªæ‰•ã„">è«‹æ±‚æ¸ˆãƒ»æœªæ‰•ã„</option>
                                <option value="æ”¯æ‰•æ¸ˆ">æ”¯æ‰•æ¸ˆ</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="purchasePaymentMethod">æ”¯æ‰•æ–¹æ³•</label>
                            <select id="purchasePaymentMethod">
                                <option value="éŠ€è¡ŒæŒ¯è¾¼">éŠ€è¡ŒæŒ¯è¾¼</option>
                                <option value="ç¾é‡‘">ç¾é‡‘</option>
                                <option value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</option>
                                <option value="æ‰‹å½¢">æ‰‹å½¢</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="purchaseActualPaymentDate">å®Ÿéš›ã®æ”¯æ‰•æ—¥</label>
                            <input type="date" id="purchaseActualPaymentDate">
                            <small style="color: #666;">æ”¯æ‰•ã„å®Œäº†å¾Œã«è¨˜éŒ²</small>
                        </div>
                        <div class="form-col">
                            <label for="purchaseInvoiceNumber">ä»•å…¥å…ˆä¼ç¥¨ç•ªå·</label>
                            <input type="text" id="purchaseInvoiceNumber">
                        </div>
                        <div class="form-col">
                            <label for="purchaseTax">ç¨å‹™åŒºåˆ†</label>
                            <select id="purchaseTax">
                                <option value="èª²ç¨">èª²ç¨ï¼ˆ10%ï¼‰</option>
                                <option value="è»½æ¸›ç¨ç‡">è»½æ¸›ç¨ç‡ï¼ˆ8%ï¼‰</option>
                                <option value="éèª²ç¨">éèª²ç¨</option>
                                <option value="ä¸èª²ç¨">ä¸èª²ç¨</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="purchaseQuantity">æ•°é‡</label>
                            <input type="number" id="purchaseQuantity" min="0" step="0.01">
                        </div>
                        <div class="form-col">
                            <label for="purchaseUnit">å˜ä½</label>
                            <input type="text" id="purchaseUnit" placeholder="ä¾‹: å€‹ã€mã€kgã€å¼">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="purchaseDescription">å•†å“åãƒ»è©³ç´°</label>
                        <textarea id="purchaseDescription" placeholder="ä»•å…¥ã‚ŒãŸå•†å“ãƒ»ææ–™ã®è©³ç´°ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="addPurchase()">ä»•å…¥ã‚Œã‚’ç™»éŒ²</button>
                    <button class="btn btn-info" onclick="exportPurchasesCSV()">CSVå‡ºåŠ›</button>
                </div>

                <div class="summary-grid">
                    <div class="summary-card primary">
                        <h3>ä»Šæœˆã®ç™ºæ³¨ç·é¡</h3>
                        <div class="summary-value" id="monthlyPurchases">Â¥0</div>
                        <p>å½“æœˆã®ä»•å…¥ã‚Œï¼ˆç™ºæ³¨ï¼‰åˆè¨ˆ</p>
                    </div>
                    <div class="summary-card warning">
                        <h3>ä»Šæœˆã®æ”¯æ‰•äºˆå®šé¡</h3>
                        <div class="summary-value" id="currentMonthPayment">Â¥0</div>
                        <p>ä»Šæœˆæ”¯æ‰•ã†äºˆå®šã®é‡‘é¡</p>
                    </div>
                    <div class="summary-card danger">
                        <h3>æœªæ‰•ã„ç·é¡</h3>
                        <div class="summary-value" id="unpaidPurchases">Â¥0</div>
                        <p>è«‹æ±‚æ¸ˆã¿ã§æœªæ‰•ã„ã®é‡‘é¡</p>
                    </div>
                    <div class="summary-card success">
                        <h3>æ¥æœˆã®æ”¯æ‰•äºˆå®šé¡</h3>
                        <div class="summary-value" id="nextMonthPayment">Â¥0</div>
                        <p>æ¥æœˆæ”¯æ‰•ã†äºˆå®šã®é‡‘é¡</p>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ä»•å…¥æ—¥</th>
                                <th>é–¢é€£å·¥äº‹</th>
                                <th>ä»•å…¥ã‚Œç¨®åˆ¥</th>
                                <th>å•†å“åãƒ»è©³ç´°</th>
                                <th>ä»•å…¥ã‚Œå…ˆ</th>
                                <th>é‡‘é¡</th>
                                <th>è«‹æ±‚æœˆ</th>
                                <th>æ”¯æ‰•äºˆå®šæœˆ</th>
                                <th>æ”¯æ‰•çŠ¶æ³</th>
                                <th>å®Ÿæ”¯æ‰•æ—¥</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="purchasesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- è«‹æ±‚æ›¸ç®¡ç† -->
            <div id="invoices-sheet" class="sheet">
                <h2>ğŸ“‹ è«‹æ±‚æ›¸ç®¡ç†</h2>

                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="invoiceProject">å¯¾è±¡å·¥äº‹ *</label>
                            <select id="invoiceProject" required>
                                <option value="">å·¥äº‹ã‚’é¸æŠ</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="invoiceDate">è«‹æ±‚æ›¸ç™ºè¡Œæ—¥ *</label>
                            <input type="date" id="invoiceDate" required>
                        </div>
                        <div class="form-col">
                            <label for="invoiceDueDate">å…¥é‡‘äºˆå®šæ—¥</label>
                            <input type="date" id="invoiceDueDate">
                        </div>
                        <div class="form-col">
                            <label for="invoiceAmount">è«‹æ±‚é‡‘é¡ï¼ˆå††ï¼‰ *</label>
                            <input type="number" id="invoiceAmount" min="0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="invoiceNumber">è«‹æ±‚æ›¸ç•ªå·</label>
                            <input type="text" id="invoiceNumber" placeholder="è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™">
                        </div>
                        <div class="form-col">
                            <label for="taxAmount">æ¶ˆè²»ç¨é¡ï¼ˆå††ï¼‰</label>
                            <input type="number" id="taxAmount" min="0">
                        </div>
                        <div class="form-col">
                            <label for="invoiceStatus">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                            <select id="invoiceStatus">
                                <option value="ä¸‹æ›¸ã">ä¸‹æ›¸ã</option>
                                <option value="ç™ºè¡Œæ¸ˆ">ç™ºè¡Œæ¸ˆ</option>
                                <option value="é€ä»˜æ¸ˆ">é€ä»˜æ¸ˆ</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="paymentTerms">æ”¯æ‰•æ¡ä»¶</label>
                            <select id="paymentTerms">
                                <option value="æœˆæœ«ç· ç¿Œæœˆæœ«æ‰•">æœˆæœ«ç· ç¿Œæœˆæœ«æ‰•</option>
                                <option value="å½“æœˆæœ«æ‰•">å½“æœˆæœ«æ‰•</option>
                                <option value="ç¿Œæœˆ20æ—¥æ‰•">ç¿Œæœˆ20æ—¥æ‰•</option>
                                <option value="ç¾é‡‘">ç¾é‡‘</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="invoiceNotes">è«‹æ±‚æ›¸å‚™è€ƒ</label>
                        <textarea id="invoiceNotes" placeholder="è«‹æ±‚æ›¸ã«è¨˜è¼‰ã™ã‚‹ç‰¹è¨˜äº‹é …"></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="addInvoice()">è«‹æ±‚æ›¸ã‚’ç™ºè¡Œ</button>
                    <button class="btn btn-info" onclick="exportInvoicesCSV()">CSVå‡ºåŠ›</button>
                </div>

                <div class="summary-grid">
                    <div class="summary-card success">
                        <h3>ä»Šæœˆã®è«‹æ±‚é¡</h3>
                        <div class="summary-value" id="monthlyInvoices">Â¥0</div>
                        <p>ç™ºè¡Œæ¸ˆã¿è«‹æ±‚æ›¸ã®åˆè¨ˆ</p>
                    </div>
                    <div class="summary-card warning">
                        <h3>æœªå›åè«‹æ±‚é¡</h3>
                        <div class="summary-value" id="unpaidInvoices">Â¥0</div>
                        <p>æœªå…¥é‡‘ãƒ»ä¸€éƒ¨å…¥é‡‘ã®åˆè¨ˆ</p>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>è«‹æ±‚æ›¸ç•ªå·</th>
                                <th>å·¥äº‹å</th>
                                <th>é¡§å®¢å</th>
                                <th>ç™ºè¡Œæ—¥</th>
                                <th>è«‹æ±‚é¡</th>
                                <th>å…¥é‡‘çŠ¶æ³</th>
                                <th>å…¥é‡‘é¡/è«‹æ±‚é¡</th>
                                <th>å…¥é‡‘äºˆå®šæ—¥</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å…¥é‡‘è¨˜éŒ² -->
            <div id="payments-sheet" class="sheet">
                <h2>ğŸ’³ å…¥é‡‘è¨˜éŒ²ãƒ»ç®¡ç†</h2>

                <div class="payment-form">
                    <h3>ğŸ”¹ å…¥é‡‘ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="paymentInvoice">è«‹æ±‚æ›¸ç•ªå· *</label>
                            <select id="paymentInvoice" required>
                                <option value="">æœªå…¥é‡‘ãƒ»ä¸€éƒ¨å…¥é‡‘ã®è«‹æ±‚æ›¸ã‚’é¸æŠ</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="paymentDate">å…¥é‡‘æ—¥ *</label>
                            <input type="date" id="paymentDate" required>
                        </div>
                        <div class="form-col">
                            <label for="paymentAmount">å…¥é‡‘é¡ï¼ˆå††ï¼‰ *</label>
                            <input type="number" id="paymentAmount" min="1" required>
                        </div>
                        <div class="form-col">
                            <label for="paymentMethod">å…¥é‡‘æ–¹æ³•</label>
                            <select id="paymentMethod">
                                <option value="æŒ¯è¾¼">æŒ¯è¾¼</option>
                                <option value="ç¾é‡‘">ç¾é‡‘</option>
                                <option value="æ‰‹å½¢">æ‰‹å½¢</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="paymentPayer">æŒ¯è¾¼åç¾©äººï¼ˆç•°ãªã‚‹å ´åˆï¼‰</label>
                            <input type="text" id="paymentPayer" placeholder="é¡§å®¢åã¨ç•°ãªã‚‹å ´åˆã®ã¿å…¥åŠ›">
                        </div>
                        <div class="form-col">
                            <label for="paymentMemo">ãƒ¡ãƒ¢æ¬„</label>
                            <textarea id="paymentMemo" placeholder="å…¥é‡‘ã«é–¢ã™ã‚‹ç‰¹è¨˜äº‹é …"></textarea>
                        </div>
                    </div>

                    <button class="btn btn-success" onclick="addPayment()">ğŸ’° å…¥é‡‘ã‚’ç™»éŒ²</button>
                </div>

                <div class="summary-grid">
                    <div class="summary-card success">
                        <h3>ä»Šæœˆã®å…¥é‡‘é¡</h3>
                        <div class="summary-value" id="monthlyPayments">Â¥0</div>
                        <p>å½“æœˆå…¥é‡‘å®Ÿç¸¾</p>
                    </div>
                    <div class="summary-card danger">
                        <h3>æœªå›åé‡‘é¡</h3>
                        <div class="summary-value" id="totalReceivables">Â¥0</div>
                        <p>å…¨è«‹æ±‚æ›¸ã®æœªå›ååˆ†</p>
                    </div>
                    <div class="summary-card primary">
                        <h3>å…¥é‡‘äºˆå®šé¡ï¼ˆä»Šæœˆï¼‰</h3>
                        <div class="summary-value" id="expectedPayments">Â¥0</div>
                        <p>ä»Šæœˆå…¥é‡‘äºˆå®šã®é‡‘é¡</p>
                    </div>
                </div>

                <h3>ğŸ“‹ å…¥é‡‘å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>å…¥é‡‘æ—¥</th>
                                <th>è«‹æ±‚æ›¸ç•ªå·</th>
                                <th>å·¥äº‹å</th>
                                <th>é¡§å®¢å</th>
                                <th>å…¥é‡‘é¡</th>
                                <th>å…¥é‡‘æ–¹æ³•</th>
                                <th>æ®‹é¡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- å£²æ›é‡‘ç®¡ç† -->
            <div id="receivables-sheet" class="sheet">
                <h2>ğŸ“Š å£²æ›é‡‘ç®¡ç†</h2>

                <div class="summary-grid">
                    <div class="summary-card danger">
                        <h3>ç·å£²æ›é‡‘æ®‹é«˜</h3>
                        <div class="summary-value" id="totalReceivablesAmount">Â¥0</div>
                        <p>å…¨æœªå›åé‡‘é¡ã®åˆè¨ˆ</p>
                    </div>
                    <div class="summary-card warning">
                        <h3>30æ—¥ä»¥ä¸ŠçµŒé</h3>
                        <div class="summary-value" id="overdue30">Â¥0</div>
                        <p>å›åè¦æ³¨æ„æ¡ˆä»¶</p>
                    </div>
                </div>

                <h3>ğŸ“‹ æœªå›åè«‹æ±‚æ›¸ä¸€è¦§</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>è«‹æ±‚æ›¸ç•ªå·</th>
                                <th>ç™ºè¡Œæ—¥</th>
                                <th>é¡§å®¢å</th>
                                <th>è«‹æ±‚é¡</th>
                                <th>å…¥é‡‘é¡</th>
                                <th>æ®‹é¡</th>
                                <th>å…¥é‡‘äºˆå®šæ—¥</th>
                                <th>çµŒéæ—¥æ•°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="receivablesTableBody">
                        </tbody>
                    </table>
                </div>

                <h3>ğŸ‘¥ é¡§å®¢åˆ¥å£²æ›é‡‘ã‚µãƒãƒªãƒ¼</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>é¡§å®¢å</th>
                                <th>æœªå›åä»¶æ•°</th>
                                <th>æœªå›åé‡‘é¡</th>
                                <th>æœ€å¤è«‹æ±‚æ—¥</th>
                                <th>é€£çµ¡çŠ¶æ³</th>
                            </tr>
                        </thead>
                        <tbody id="customerReceivablesBody">
                        </tbody>
                    </table>
                </div>

                <h3>ğŸ“… å…¥é‡‘äºˆå®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
                <div class="alert alert-info">
                    <strong>ä»Šé€±ã®å…¥é‡‘äºˆå®šï¼š</strong> <span id="thisWeekExpected">Â¥0</span><br>
                    <strong>æ¥é€±ã®å…¥é‡‘äºˆå®šï¼š</strong> <span id="nextWeekExpected">Â¥0</span><br>
                    <strong>ä»Šæœˆã®å…¥é‡‘äºˆå®šï¼š</strong> <span id="thisMonthExpected">Â¥0</span>
                </div>
            </div>

            <!-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ†æ -->
            <div id="cashflow-sheet" class="sheet">
                <h2>ğŸ’¹ æœˆæ¬¡ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ†æ</h2>

                <div class="summary-grid">
                    <div class="summary-card success">
                        <h3>ä»Šæœˆã®å£²ä¸Šï¼ˆè«‹æ±‚é¡ï¼‰</h3>
                        <div class="summary-value" id="monthlySales">Â¥0</div>
                        <p>è«‹æ±‚æ›¸ãƒ™ãƒ¼ã‚¹ã®å£²ä¸Š</p>
                    </div>
                    <div class="summary-card primary">
                        <h3>ä»Šæœˆã®å…¥é‡‘é¡</h3>
                        <div class="summary-value" id="monthlyReceipts">Â¥0</div>
                        <p>å®Ÿéš›ã®å…¥é‡‘ãƒ™ãƒ¼ã‚¹</p>
                    </div>
                    <div class="summary-card warning">
                        <h3>å…¥é‡‘ç‡</h3>
                        <div class="summary-value" id="paymentRate">0%</div>
                        <p>å£²ä¸Šã«å¯¾ã™ã‚‹å…¥é‡‘å‰²åˆ</p>
                    </div>
                    <div class="summary-card danger">
                        <h3>æœªå›åé‡‘é¡</h3>
                        <div class="summary-value" id="outstandingAmount">Â¥0</div>
                        <p>å›åå¾…ã¡ã®ç·é¡</p>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="cashflowChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>å…¥é‡‘äºˆå®š vs å®Ÿç¸¾ã®æ¯”è¼ƒ</h3>
                    <canvas id="forecastChart"></canvas>
                </div>
            </div>

            <!-- æœˆæ¬¡æç›Šè¨ˆç®—æ›¸ -->
            <div id="monthly-sheet" class="sheet">
                <h2>ğŸ“ˆ æœˆæ¬¡æç›Šè¨ˆç®—æ›¸</h2>

                <div class="form-row">
                    <div class="form-col">
                        <label for="monthlyYear">å¹´</label>
                        <select id="monthlyYear">
                            <option value="2025">2025å¹´</option>
                            <option value="2024">2024å¹´</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label for="monthlyMonth">æœˆ</label>
                        <select id="monthlyMonth">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <button class="btn btn-primary" onclick="generateMonthlyReport()">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
                        <button class="btn btn-info" onclick="exportMonthlyCSV()">CSVå‡ºåŠ›</button>
                    </div>
                </div>

                <div id="monthlyReport">
                    <h3>ğŸ“Š ç™ºç”Ÿä¸»ç¾©æç›Š vs ç¾é‡‘ä¸»ç¾©æç›Š</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>é …ç›®</th>
                                    <th>ç™ºç”Ÿä¸»ç¾©ï¼ˆè«‹æ±‚ãƒ™ãƒ¼ã‚¹ï¼‰</th>
                                    <th>ç¾é‡‘ä¸»ç¾©ï¼ˆå…¥é‡‘ãƒ™ãƒ¼ã‚¹ï¼‰</th>
                                    <th>å·®é¡</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyReportBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- å¹´æ¬¡åˆ†æ -->
            <div id="yearly-sheet" class="sheet">
                <h2>ğŸ“… å¹´æ¬¡åˆ†æ</h2>

                <div class="form-row">
                    <div class="form-col">
                        <label for="yearlyAnalysisYear">åˆ†æå¹´åº¦</label>
                        <select id="yearlyAnalysisYear">
                            <option value="2025">2025å¹´</option>
                            <option value="2024">2024å¹´</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <button class="btn btn-primary" onclick="generateYearlyReport()">å¹´æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="yearlyChart"></canvas>
                </div>

                <div id="yearlyReport">
                    <div class="summary-grid">
                        <div class="summary-card primary">
                            <h3>å¹´é–“å£²ä¸Šé«˜</h3>
                            <div class="summary-value" id="yearlySales">Â¥0</div>
                            <p>è«‹æ±‚æ›¸ãƒ™ãƒ¼ã‚¹</p>
                        </div>
                        <div class="summary-card success">
                            <h3>å¹´é–“çµŒè²»</h3>
                            <div class="summary-value" id="yearlyExpenses">Â¥0</div>
                            <p>æ”¯å‡ºãƒ™ãƒ¼ã‚¹</p>
                        </div>
                        <div class="summary-card warning">
                            <h3>å¹´é–“åˆ©ç›Š</h3>
                            <div class="summary-value" id="yearlyProfit">Â¥0</div>
                            <p>å£²ä¸Š - çµŒè²»</p>
                        </div>
                        <div class="summary-card danger">
                            <h3>åˆ©ç›Šç‡</h3>
                            <div class="summary-value" id="yearlyMargin">0%</div>
                            <p>åˆ©ç›Š Ã· å£²ä¸Š</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¨å‹™è³‡æ–™ -->
            <div id="tax-sheet" class="sheet">
                <h2>ğŸ§¾ ç¨å‹™è³‡æ–™ä½œæˆ</h2>

                <div class="alert alert-info">
                    <strong>ğŸ“‹ ç¨ç†å£«æå‡ºç”¨è³‡æ–™ã®æº–å‚™</strong><br>
                    ç¢ºå®šç”³å‘Šã‚„ç¨å‹™èª¿æŸ»ã«å¿…è¦ãªè³‡æ–™ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label for="taxYear">å¯¾è±¡å¹´åº¦</label>
                        <select id="taxYear">
                            <option value="2025">2025å¹´</option>
                            <option value="2024">2024å¹´</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <button class="btn btn-success" onclick="generateTaxReports()">ğŸ“Š ç¨å‹™è³‡æ–™ä¸€æ‹¬ç”Ÿæˆ</button>
                    </div>
                </div>

                <div class="summary-grid">
                    <div class="summary-card primary">
                        <h3>å£²ä¸Šå°å¸³</h3>
                        <div class="summary-value">ğŸ“‹</div>
                        <button class="btn btn-info" onclick="exportSalesLedger()">å£²ä¸Šå°å¸³CSV</button>
                    </div>
                    <div class="summary-card success">
                        <h3>çµŒè²»å°å¸³</h3>
                        <div class="summary-value">ğŸ’°</div>
                        <button class="btn btn-info" onclick="exportExpenseLedger()">çµŒè²»å°å¸³CSV</button>
                    </div>
                    <div class="summary-card warning">
                        <h3>å…¥é‡‘ç®¡ç†å°å¸³</h3>
                        <div class="summary-value">ğŸ’³</div>
                        <button class="btn btn-info" onclick="exportPaymentLedger()">å…¥é‡‘å°å¸³CSV</button>
                    </div>
                    <div class="summary-card danger">
                        <h3>å¹´é–“æç›Šè¨ˆç®—æ›¸</h3>
                        <div class="summary-value">ğŸ“ˆ</div>
                        <button class="btn btn-info" onclick="exportProfitLoss()">æç›Šè¨ˆç®—æ›¸CSV</button>
                    </div>
                </div>

                <div id="taxDocuments">
                    <h3>ğŸ“„ ç”Ÿæˆã•ã‚ŒãŸç¨å‹™æ›¸é¡</h3>
                    <div id="taxDocumentsList">
                        <p>ç¨å‹™è³‡æ–™ã‚’ç”Ÿæˆã™ã‚‹ã¨ã€ã“ã“ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                </div>
            </div>

            <!-- ä½¿ã„æ–¹ãƒãƒ‹ãƒ¥ã‚¢ãƒ« -->
            <div id="manual-sheet" class="sheet">
                <h2>ğŸ“– ã‚¨ãƒ ã‚ºã‚¤ãƒ³ãƒ†ãƒªã‚¢çµŒç†ã‚·ã‚¹ãƒ†ãƒ  ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h2>

                <div class="alert alert-success">
                    <strong>ğŸ‰ ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦</strong><br>
                    å·¥äº‹ç®¡ç†ã‹ã‚‰å…¥é‡‘ç®¡ç†ã¾ã§ã€å»ºè¨­æ¥­ã®çµŒç†æ¥­å‹™ã‚’ä¸€å…ƒç®¡ç†ã§ãã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚
                </div>

                <h3>ğŸš€ åŸºæœ¬çš„ãªä½¿ã„æ–¹ã®æµã‚Œ</h3>

                <div class="summary-grid">
                    <div class="summary-card primary">
                        <h3>1. ğŸ—ï¸ å·¥äº‹å°å¸³</h3>
                        <p><strong>æ–°è¦å·¥äº‹ã®ç™»éŒ²</strong></p>
                        <ul>
                            <li>å·¥äº‹åã€é¡§å®¢åã‚’å…¥åŠ›</li>
                            <li>å¥‘ç´„é‡‘é¡ã¨å·¥æœŸã‚’è¨­å®š</li>
                            <li>æ‹…å½“è€…ã¨å ´æ‰€ã‚’è¨˜éŒ²</li>
                        </ul>
                    </div>

                    <div class="summary-card success">
                        <h3>2. ğŸ’° çµŒè²»ç®¡ç†</h3>
                        <p><strong>å·¥äº‹é–¢é€£çµŒè²»ã®è¨˜éŒ²</strong></p>
                        <ul>
                            <li>ææ–™è²»ã€å¤–æ³¨è²»ç­‰ã‚’åˆ†é¡</li>
                            <li>é ˜åæ›¸ç•ªå·ã‚‚ç®¡ç†</li>
                            <li>ç¨å‹™åŒºåˆ†ã‚’æ­£ç¢ºã«è¨­å®š</li>
                        </ul>
                    </div>

                    <div class="summary-card warning">
                        <h3>3. ğŸ“‹ è«‹æ±‚æ›¸ç™ºè¡Œ</h3>
                        <p><strong>å®Œäº†å·¥äº‹ã®è«‹æ±‚å‡¦ç†</strong></p>
                        <ul>
                            <li>å·¥äº‹å®Œäº†å¾Œã«è«‹æ±‚æ›¸ä½œæˆ</li>
                            <li>å…¥é‡‘äºˆå®šæ—¥ã‚’è¨­å®š</li>
                            <li>æ¶ˆè²»ç¨ã®è‡ªå‹•è¨ˆç®—</li>
                        </ul>
                    </div>

                    <div class="summary-card danger">
                        <h3>4. ğŸ’³ å…¥é‡‘ç®¡ç†</h3>
                        <p><strong>NEW! å…¥é‡‘ç¢ºèªæ©Ÿèƒ½</strong></p>
                        <ul>
                            <li>è«‹æ±‚æ›¸ã¨å…¥é‡‘ã‚’ç´ä»˜ã‘</li>
                            <li>éƒ¨åˆ†å…¥é‡‘ã«ã‚‚å¯¾å¿œ</li>
                            <li>å£²æ›é‡‘ã‚’è‡ªå‹•è¨ˆç®—</li>
                        </ul>
                    </div>
                </div>

                <h3>ğŸ“Š æ–°æ©Ÿèƒ½ï¼šå…¥é‡‘ç®¡ç†ã®è©³ç´°</h3>
                <div class="alert alert-warning">
                    <strong>ğŸ’¡ å…¥é‡‘ç®¡ç†æ©Ÿèƒ½ã®ãƒã‚¤ãƒ³ãƒˆ</strong>
                    <ul>
                        <li><strong>è‡ªå‹•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼š</strong> å…¥é‡‘ç™»éŒ²ã§è«‹æ±‚æ›¸çŠ¶æ³ãŒè‡ªå‹•æ›´æ–°</li>
                        <li><strong>éƒ¨åˆ†å…¥é‡‘å¯¾å¿œï¼š</strong> è¤‡æ•°å›ã«åˆ†ã‘ãŸå…¥é‡‘ã‚‚æ­£ç¢ºã«ç®¡ç†</li>
                        <li><strong>å£²æ›é‡‘ç®¡ç†ï¼š</strong> æœªå›åé‡‘é¡ã‚’è‡ªå‹•è¨ˆç®—ãƒ»è¡¨ç¤º</li>
                        <li><strong>å…¥é‡‘é…å»¶ã‚¢ãƒ©ãƒ¼ãƒˆï¼š</strong> å…¥é‡‘äºˆå®šæ—¥ã‚’éããŸæ¡ˆä»¶ã‚’å¼·èª¿è¡¨ç¤º</li>
                        <li><strong>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ†æï¼š</strong> å£²ä¸Šã¨å…¥é‡‘ã®å·®ã‚’å¯è¦–åŒ–</li>
                    </ul>
                </div>

                <h3>ğŸ” å„ã‚¿ãƒ–ã®æ©Ÿèƒ½è©³ç´°</h3>

                <div style="margin: 20px 0;">
                    <h4>ğŸ“Š å£²æ›é‡‘ç®¡ç†ã‚¿ãƒ–</h4>
                    <ul>
                        <li>æœªå›åè«‹æ±‚æ›¸ã‚’ä¸€è¦§è¡¨ç¤º</li>
                        <li>çµŒéæ—¥æ•°ã«ã‚ˆã‚‹è‰²åˆ†ã‘ï¼ˆ30æ—¥ä»¥ä¸Š=èµ¤ã€15-29æ—¥=é»„ã€14æ—¥ä»¥å†…=ç·‘ï¼‰</li>
                        <li>é¡§å®¢åˆ¥ã®å£²æ›é‡‘ã‚µãƒãƒªãƒ¼</li>
                        <li>å…¥é‡‘äºˆå®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½</li>
                    </ul>
                </div>

                <div style="margin: 20px 0;">
                    <h4>ğŸ’¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã‚¿ãƒ–</h4>
                    <ul>
                        <li>æœˆåˆ¥å…¥é‡‘å®Ÿç¸¾ã‚’ã‚°ãƒ©ãƒ•è¡¨ç¤º</li>
                        <li>å…¥é‡‘äºˆå®š vs å®Ÿç¸¾ã®æ¯”è¼ƒåˆ†æ</li>
                        <li>å£²ä¸Šï¼ˆè«‹æ±‚ãƒ™ãƒ¼ã‚¹ï¼‰ã¨å…¥é‡‘ï¼ˆç¾é‡‘ãƒ™ãƒ¼ã‚¹ï¼‰ã®å·®ç•°åˆ†æ</li>
                    </ul>
                </div>

                <div style="margin: 20px 0;">
                    <h4>ğŸ“ˆ æœˆæ¬¡æç›Šè¨ˆç®—æ›¸ã®æ”¹è‰¯</h4>
                    <ul>
                        <li>ç™ºç”Ÿä¸»ç¾©ï¼ˆè«‹æ±‚ãƒ™ãƒ¼ã‚¹ï¼‰ã®æç›Š</li>
                        <li>ç¾é‡‘ä¸»ç¾©ï¼ˆå…¥é‡‘ãƒ™ãƒ¼ã‚¹ï¼‰ã®æç›Š</li>
                        <li>ä¸¡è€…ã®å·®é¡åˆ†æã§è³‡é‡‘ç¹°ã‚ŠçŠ¶æ³ã‚’æŠŠæ¡</li>
                    </ul>
                </div>

                <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«ã¤ã„ã¦</h3>
                <div class="alert alert-info">
                    <ul>
                        <li><strong>è‡ªå‹•ä¿å­˜ï¼š</strong> å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™</li>
                        <li><strong>ãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼š</strong> CSVå‡ºåŠ›æ©Ÿèƒ½ã§ä»–ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚‚å¯èƒ½</li>
                        <li><strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼š</strong> å®šæœŸçš„ãªCSVå‡ºåŠ›ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ¨å¥¨</li>
                    </ul>
                </div>

                <h3>ğŸ“± ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ</h3>
                <p>iPhoneãƒ»iPadç­‰ã®ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã‚‚ä½¿ã„ã‚„ã™ã„ã‚ˆã†æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚ç¾å ´ã§ã®çµŒè²»å…¥åŠ›ã‚„å…¥é‡‘ç¢ºèªã‚‚ç°¡å˜ã«è¡Œãˆã¾ã™ã€‚</p>

                <div class="alert alert-success">
                    <strong>ğŸ¯ ãŠã™ã™ã‚é‹ç”¨ãƒ•ãƒ­ãƒ¼</strong><br>
                    <ol>
                        <li>å·¥äº‹å—æ³¨æ™‚ã«ã€Œå·¥äº‹å°å¸³ã€ã§ç™»éŒ²</li>
                        <li>ææ–™è³¼å…¥ç­‰ã®éƒ½åº¦ã€ŒçµŒè²»ç®¡ç†ã€ã§è¨˜éŒ²</li>
                        <li>å·¥äº‹å®Œäº†æ™‚ã«ã€Œè«‹æ±‚æ›¸ç®¡ç†ã€ã§è«‹æ±‚æ›¸ç™ºè¡Œ</li>
                        <li>å…¥é‡‘ç¢ºèªæ™‚ã«ã€Œå…¥é‡‘è¨˜éŒ²ã€ã§å…¥é‡‘ç™»éŒ²</li>
                        <li>æœˆæœ«ã«ã€Œå£²æ›é‡‘ç®¡ç†ã€ã§æœªå›åã‚’ãƒã‚§ãƒƒã‚¯</li>
                        <li>å››åŠæœŸã”ã¨ã«ã€Œç¨å‹™è³‡æ–™ã€ã§CSVå‡ºåŠ›ã—ç¨ç†å£«ã«æå‡º</li>
                    </ol>
                </div>
            </div>
        </div>
    <script>
        // Global Data Storage
        let projects = JSON.parse(localStorage.getItem('msinterior_projects') || '[]');
        let expenses = JSON.parse(localStorage.getItem('msinterior_expenses') || '[]');
        let invoices = JSON.parse(localStorage.getItem('msinterior_invoices') || '[]');
        let payments = JSON.parse(localStorage.getItem('msinterior_payments') || '[]');

        // Initialize system on load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        function initializeSystem() {
            // Set current date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('projectDate').value = today;
            document.getElementById('expenseDate').value = today;
            document.getElementById('invoiceDate').value = today;
            document.getElementById('paymentDate').value = today;
            document.getElementById('purchaseDate').value = today;

            // Set current month in monthly report
            const currentDate = new Date();
            document.getElementById('monthlyMonth').value = currentDate.getMonth() + 1;
            document.getElementById('monthlyYear').value = currentDate.getFullYear();
            document.getElementById('yearlyAnalysisYear').value = currentDate.getFullYear();
            document.getElementById('taxYear').value = currentDate.getFullYear();

            // Load sample data if no data exists
            if (projects.length === 0) {
                loadSampleData();
            }

            // Refresh all displays
            refreshAllDisplays();
        }

        function loadSampleData() {
            const sampleProjects = [
                {
                    id: 'PRJ-2025-001',
                    name: 'ç”°ä¸­æ§˜é‚¸ã‚­ãƒƒãƒãƒ³ãƒªãƒ•ã‚©ãƒ¼ãƒ ',
                    client: 'ç”°ä¸­å¤ªéƒ',
                    startDate: '2025-01-15',
                    completionDate: '2025-02-15',
                    contractAmount: 1200000,
                    status: 'é€²è¡Œä¸­',
                    location: 'æ±äº¬éƒ½å“å·åŒº',
                    manager: 'ä½è—¤',
                    notes: 'ã‚·ã‚¹ãƒ†ãƒ ã‚­ãƒƒãƒãƒ³äº¤æ›ãƒ»å†…è£…å·¥äº‹',
                    timestamp: new Date().toISOString()
                },
                {
                    id: 'PRJ-2025-002',
                    name: 'å±±ç”°å•†åº—äº‹å‹™æ‰€æ”¹è£…',
                    client: 'å±±ç”°å•†åº—',
                    startDate: '2025-01-10',
                    completionDate: '2025-01-25',
                    contractAmount: 800000,
                    status: 'å®Œäº†',
                    location: 'æ±äº¬éƒ½æ¸‹è°·åŒº',
                    manager: 'éˆ´æœ¨',
                    notes: 'ã‚ªãƒ•ã‚£ã‚¹å†…è£…ãƒ»é›»æ°—å·¥äº‹',
                    timestamp: new Date().toISOString()
                }
            ];

            const sampleExpenses = [
                {
                    id: 'EXP-2025-001',
                    projectId: 'PRJ-2025-001',
                    date: '2025-01-16',
                    category: 'ææ–™è²»',
                    amount: 450000,
                    supplier: 'ã‚¿ã‚«ãƒ©ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰',
                    paymentMethod: 'éŠ€è¡ŒæŒ¯è¾¼',
                    receiptNumber: 'R-20250116-001',
                    taxType: 'èª²ç¨',
                    description: 'ã‚·ã‚¹ãƒ†ãƒ ã‚­ãƒƒãƒãƒ³æœ¬ä½“ãƒ»éƒ¨æ',
                    timestamp: new Date().toISOString()
                },
                {
                    id: 'EXP-2025-002',
                    projectId: 'PRJ-2025-002',
                    date: '2025-01-12',
                    category: 'ææ–™è²»',
                    amount: 120000,
                    supplier: 'å†…è£…è³‡æå•†äº‹',
                    paymentMethod: 'ç¾é‡‘',
                    receiptNumber: 'R-20250112-001',
                    taxType: 'èª²ç¨',
                    description: 'å£ç´™ãƒ»åºŠæ',
                    timestamp: new Date().toISOString()
                }
            ];

            const sampleInvoices = [
                {
                    id: 'SEI-2025-001',
                    invoiceNumber: 'INV-2025-001',
                    projectId: 'PRJ-2025-002',
                    issueDate: '2025-01-26',
                    dueDate: '2025-02-26',
                    totalAmount: 880000,
                    taxAmount: 80000,
                    status: 'ç™ºè¡Œæ¸ˆ',
                    paymentTerms: 'æœˆæœ«ç· ç¿Œæœˆæœ«æ‰•',
                    notes: 'å±±ç”°å•†åº—æ§˜äº‹å‹™æ‰€æ”¹è£…å·¥äº‹ä¸€å¼',
                    timestamp: new Date().toISOString()
                }
            ];

            const samplePayments = [
                {
                    id: 'PAY-2025-001',
                    invoiceId: 'SEI-2025-001',
                    paymentDate: '2025-02-20',
                    amount: 400000,
                    method: 'æŒ¯è¾¼',
                    payer: '',
                    memo: 'éƒ¨åˆ†å…¥é‡‘',
                    timestamp: new Date().toISOString()
                }
            ];

            projects = sampleProjects;
            expenses = sampleExpenses;
            invoices = sampleInvoices;
            payments = samplePayments;

            saveAllData();
        }

        // Data Management Functions
        function saveAllData() {
            localStorage.setItem('msinterior_projects', JSON.stringify(projects));
            localStorage.setItem('msinterior_expenses', JSON.stringify(expenses));
            localStorage.setItem('msinterior_invoices', JSON.stringify(invoices));
            localStorage.setItem('msinterior_payments', JSON.stringify(payments));
        }

        function generateId(prefix) {
            const year = new Date().getFullYear();
            const count = (prefix === 'PRJ' ? projects.length : 
                          prefix === 'EXP' ? expenses.length : 
                          prefix === 'SEI' ? invoices.length :
                          prefix === 'PAY' ? payments.length : 0) + 1;
            return `${prefix}-${year}-${String(count).padStart(3, '0')}`;
        }

        // Payment Status Calculation
        function calculatePaymentStatus(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return { status: 'æœªè«‹æ±‚', paidAmount: 0, remainingAmount: 0 };

            const relatedPayments = payments.filter(pay => pay.invoiceId === invoiceId);
            const paidAmount = relatedPayments.reduce((sum, pay) => sum + Number(pay.amount), 0);
            const invoiceAmount = Number(invoice.totalAmount);
            const remainingAmount = invoiceAmount - paidAmount;

            let status;
            if (paidAmount === 0) {
                status = 'æœªå…¥é‡‘';
            } else if (remainingAmount <= 0) {
                status = 'å…¥é‡‘æ¸ˆ';
            } else {
                status = 'ä¸€éƒ¨å…¥é‡‘';
            }

            return { status, paidAmount, remainingAmount };
        }

        // Tab Navigation
        function showSheet(sheetName) {
            // Hide all sheets
            const sheets = document.querySelectorAll('.sheet');
            sheets.forEach(sheet => sheet.classList.remove('active'));

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected sheet
            const selectedSheet = document.getElementById(sheetName + '-sheet');
            if (selectedSheet) {
                selectedSheet.classList.add('active');
            }

            // Add active class to clicked tab
            event.target.classList.add('active');

            // Refresh data for the selected sheet
            refreshSheetData(sheetName);
        }

        function refreshSheetData(sheetName) {
            switch(sheetName) {
                case 'construction':
                    displayProjects();
                    updateProjectDropdowns();
                    break;
                case 'expenses':
                    displayExpenses();
                    updateExpenseSummary();
                    break;
                case 'invoices':
                    displayInvoices();
                    updateInvoiceSummary();
                    break;
                case 'payments':
                    displayPayments();
                    updatePaymentSummary();
                    updatePaymentInvoiceDropdown();
                    break;
                case 'receivables':
                    displayReceivables();
                    updateReceivableSummary();
                    break;
                case 'cashflow':
                    updateCashflowAnalysis();
                    break;
            }
        }

        function refreshAllDisplays() {
            displayProjects();
            displayExpenses();
            displayInvoices();
            displayPayments();
            displayReceivables();
            updateAllSummaries();
            updateAllDropdowns();
        }

        function updateAllSummaries() {
            updateExpenseSummary();
            updateInvoiceSummary();
            updatePaymentSummary();
            updateReceivableSummary();
        }

        function updateAllDropdowns() {
            updateProjectDropdowns();
            updatePaymentInvoiceDropdown();
        }

        // Project Management
        function addProject() {
            const name = document.getElementById('projectName').value.trim();
            const client = document.getElementById('clientName').value.trim();

            if (!name || !client) {
                alert('å·¥äº‹åã¨é¡§å®¢åã¯å¿…é ˆé …ç›®ã§ã™ã€‚');
                return;
            }

            if (editingProjectId) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šæ—¢å­˜ã®å·¥äº‹ã‚’æ›´æ–°
                const index = projects.findIndex(p => p.id === editingProjectId);
                if (index !== -1) {
                    projects[index] = {
                        ...projects[index],
                        name: name,
                        client: client,
                        startDate: document.getElementById('projectDate').value,
                        completionDate: document.getElementById('completionDate').value,
                        contractAmount: Number(document.getElementById('contractAmount').value) || 0,
                        status: document.getElementById('projectStatus').value,
                        location: document.getElementById('projectLocation').value,
                        manager: document.getElementById('projectManager').value,
                        notes: document.getElementById('projectNotes').value,
                        updatedAt: new Date().toISOString()
                    };
                }
                editingProjectId = null;
                alert('å·¥äº‹æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
            } else {
                // æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰
                const project = {
                    id: generateId('PRJ'),
                    name: name,
                    client: client,
                    startDate: document.getElementById('projectDate').value,
                    completionDate: document.getElementById('completionDate').value,
                    contractAmount: Number(document.getElementById('contractAmount').value) || 0,
                    status: document.getElementById('projectStatus').value,
                    location: document.getElementById('projectLocation').value,
                    manager: document.getElementById('projectManager').value,
                    notes: document.getElementById('projectNotes').value,
                    timestamp: new Date().toISOString()
                };
                projects.push(project);
                alert('å·¥äº‹ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚');
            }

            saveAllData();
            clearProjectForm();
            refreshAllDisplays();
            alert('å·¥äº‹ãŒæ­£å¸¸ã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸã€‚');
        }

        function clearProjectForm() {
            document.getElementById('projectName').value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('projectDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('completionDate').value = '';
            document.getElementById('contractAmount').value = '';
            document.getElementById('projectStatus').value = 'è¨ˆç”»ä¸­';
            document.getElementById('projectLocation').value = '';
            document.getElementById('projectManager').value = '';
            document.getElementById('projectNotes').value = '';
        }

        function displayProjects() {
            const tbody = document.getElementById('projectsTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            projects.forEach(project => {
                const paymentStatus = getProjectPaymentStatus(project.id);
                const row = `
                    <tr>
                        <td>${project.name}</td>
                        <td>${project.client}</td>
                        <td>Â¥${project.contractAmount.toLocaleString()}</td>
                        <td>${project.startDate || '-'}</td>
                        <td>${project.completionDate || '-'}</td>
                        <td><span class="status status-${project.status}">${project.status}</span></td>
                        <td><span class="status status-${paymentStatus.statusClass}">${paymentStatus.status}</span></td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editProject('${project.id}')">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProject('${project.id}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function getProjectPaymentStatus(projectId) {
            const projectInvoices = invoices.filter(inv => inv.projectId === projectId);
            if (projectInvoices.length === 0) {
                return { status: 'æœªè«‹æ±‚', statusClass: 'not-invoiced' };
            }

            let totalInvoiceAmount = 0;
            let totalPaidAmount = 0;

            projectInvoices.forEach(invoice => {
                totalInvoiceAmount += Number(invoice.totalAmount);
                const paymentStatus = calculatePaymentStatus(invoice.id);
                totalPaidAmount += paymentStatus.paidAmount;
            });

            if (totalPaidAmount === 0) {
                return { status: 'æœªå…¥é‡‘', statusClass: 'unpaid' };
            } else if (totalPaidAmount >= totalInvoiceAmount) {
                return { status: 'å…¥é‡‘æ¸ˆ', statusClass: 'paid' };
            } else {
                return { status: 'ä¸€éƒ¨å…¥é‡‘', statusClass: 'partial' };
            }
        }

        function updateProjectDropdowns() {
            const expenseProject = document.getElementById('expenseProject');
            const invoiceProject = document.getElementById('invoiceProject');
            const purchaseProject = document.getElementById('purchaseProject');

            if (expenseProject) {
                if (projects.length === 0) {
                    expenseProject.innerHTML = '<option value="">å·¥äº‹ãŒæœªç™»éŒ²ã§ã™ã€‚å…ˆã«å·¥äº‹å°å¸³ã§å·¥äº‹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</option>';
                } else {
                    expenseProject.innerHTML = '<option value="">å·¥äº‹ã‚’é¸æŠ</option>';
                    projects.forEach(project => {
                        expenseProject.innerHTML += `<option value="${project.id}">${project.name} (${project.client})</option>`;
                    });
                }
            }

            if (invoiceProject) {
                if (projects.length === 0) {
                    invoiceProject.innerHTML = '<option value="">å·¥äº‹ãŒæœªç™»éŒ²ã§ã™ã€‚å…ˆã«å·¥äº‹å°å¸³ã§å·¥äº‹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</option>';
                } else {
                    invoiceProject.innerHTML = '<option value="">å·¥äº‹ã‚’é¸æŠ</option>';
                    projects.forEach(project => {
                        invoiceProject.innerHTML += `<option value="${project.id}">${project.name} (${project.client})</option>`;
                    });
                }
            }

            if (purchaseProject) {
                if (projects.length === 0) {
                    purchaseProject.innerHTML = '<option value="">å·¥äº‹ãŒæœªç™»éŒ²ã§ã™ã€‚å…ˆã«å·¥äº‹å°å¸³ã§å·¥äº‹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</option>';
                } else {
                    purchaseProject.innerHTML = '<option value="">å·¥äº‹ã‚’é¸æŠ</option>';
                    projects.forEach(project => {
                        purchaseProject.innerHTML += `<option value="${project.id}">${project.name} (${project.client})</option>`;
                    });
                }
            }
        }

        // Expense Management  
        function addExpense() {
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const amount = document.getElementById('expenseAmount').value;

            if (!date || !category || !amount) {
                alert('æ”¯å‡ºæ—¥ã€è²»ç›®ã€é‡‘é¡ã¯å¿…é ˆé …ç›®ã§ã™ã€‚');
                return;
            }

            if (editingExpenseId) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šæ—¢å­˜ã®çµŒè²»ã‚’æ›´æ–°
                const index = expenses.findIndex(e => e.id === editingExpenseId);
                if (index !== -1) {
                    expenses[index] = {
                        ...expenses[index],
                        projectId: document.getElementById('expenseProject').value,
                        date: date,
                        category: category,
                        amount: Number(amount),
                        supplier: document.getElementById('expenseSupplier').value,
                        paymentMethod: document.getElementById('expensePaymentMethod').value,
                        receiptNumber: document.getElementById('expenseReceipt').value,
                        taxType: document.getElementById('expenseTax').value,
                        description: document.getElementById('expenseDescription').value,
                        updatedAt: new Date().toISOString()
                    };
                }
                editingExpenseId = null;
                alert('çµŒè²»æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
            } else {
                // æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰
                const expense = {
                    id: generateId('EXP'),
                    projectId: document.getElementById('expenseProject').value,
                    date: date,
                    category: category,
                    amount: Number(amount),
                    supplier: document.getElementById('expenseSupplier').value,
                    paymentMethod: document.getElementById('expensePaymentMethod').value,
                    receiptNumber: document.getElementById('expenseReceipt').value,
                    taxType: document.getElementById('expenseTax').value,
                    description: document.getElementById('expenseDescription').value,
                    timestamp: new Date().toISOString()
                };
                expenses.push(expense);
                alert('çµŒè²»ãŒæ­£å¸¸ã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸã€‚');
            }

            saveAllData();
            clearExpenseForm();
            refreshAllDisplays();
        }

        function clearExpenseForm() {
            document.getElementById('expenseProject').value = '';
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expenseCategory').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseSupplier').value = '';
            document.getElementById('expensePayment').value = 'ç¾é‡‘';
            document.getElementById('expenseReceipt').value = '';
            document.getElementById('taxDeductible').value = 'èª²ç¨';
            document.getElementById('expenseDescription').value = '';
        }

        function displayExpenses() {
            const tbody = document.getElementById('expensesTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            expenses.forEach(expense => {
                const project = projects.find(p => p.id === expense.projectId);
                const projectName = project ? project.name : 'ä¸€èˆ¬çµŒè²»';

                const row = `
                    <tr>
                        <td>${expense.date}</td>
                        <td>${projectName}</td>
                        <td>${expense.category}</td>
                        <td>Â¥${expense.amount.toLocaleString()}</td>
                        <td>${expense.supplier || '-'}</td>
                        <td>${expense.paymentMethod}</td>
                        <td>${expense.description || '-'}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editExpense('${expense.id}')">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteExpense('${expense.id}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateExpenseSummary() {
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            const monthlyExpenseTotal = expenses
                .filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate.getMonth() + 1 === currentMonth && expDate.getFullYear() === currentYear;
                })
                .reduce((sum, exp) => sum + Number(exp.amount), 0);

            const monthlyExpenseElement = document.getElementById('monthlyExpenses');
            if (monthlyExpenseElement) {
                monthlyExpenseElement.textContent = `Â¥${monthlyExpenseTotal.toLocaleString()}`;
            }

            // Calculate top expense category
            const categoryTotals = {};
            expenses.forEach(exp => {
                const expDate = new Date(exp.date);
                if (expDate.getMonth() + 1 === currentMonth && expDate.getFullYear() === currentYear) {
                    categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + Number(exp.amount);
                }
            });

            let topCategory = '-';
            let maxAmount = 0;
            Object.entries(categoryTotals).forEach(([category, total]) => {
                if (total > maxAmount) {
                    maxAmount = total;
                    topCategory = category;
                }
            });

            const topCategoryElement = document.getElementById('topExpenseCategory');
            if (topCategoryElement) {
                topCategoryElement.textContent = topCategory;
            }
        }
        // Invoice Management
        function addInvoice() {
            const projectId = document.getElementById('invoiceProject').value;
            const issueDate = document.getElementById('invoiceDate').value;
            const totalAmount = document.getElementById('invoiceAmount').value;

            if (!projectId || !issueDate || !totalAmount) {
                alert('å¯¾è±¡å·¥äº‹ã€ç™ºè¡Œæ—¥ã€è«‹æ±‚é‡‘é¡ã¯å¿…é ˆé …ç›®ã§ã™ã€‚');
                return;
            }

            if (editingInvoiceId) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šæ—¢å­˜ã®è«‹æ±‚æ›¸ã‚’æ›´æ–°
                const index = invoices.findIndex(i => i.id === editingInvoiceId);
                if (index !== -1) {
                    invoices[index] = {
                        ...invoices[index],
                        projectId: projectId,
                        issueDate: issueDate,
                        dueDate: document.getElementById('invoiceDueDate').value,
                        totalAmount: Number(totalAmount),
                        taxAmount: Number(document.getElementById('taxAmount').value) || 0,
                        status: document.getElementById('invoiceStatus').value,
                        paymentTerms: document.getElementById('paymentTerms').value,
                        notes: document.getElementById('invoiceNotes').value,
                        updatedAt: new Date().toISOString()
                    };
                }
                editingInvoiceId = null;
                alert('è«‹æ±‚æ›¸æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
            } else {
                // æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰
                const invoiceNumber = document.getElementById('invoiceNumber').value || generateInvoiceNumber();

                const invoice = {
                    id: generateId('SEI'),
                    invoiceNumber: invoiceNumber,
                    projectId: projectId,
                    issueDate: issueDate,
                    dueDate: document.getElementById('invoiceDueDate').value,
                    totalAmount: Number(totalAmount),
                    taxAmount: Number(document.getElementById('taxAmount').value) || 0,
                    status: document.getElementById('invoiceStatus').value,
                    paymentTerms: document.getElementById('paymentTerms').value,
                    notes: document.getElementById('invoiceNotes').value,
                    timestamp: new Date().toISOString()
                };

                invoices.push(invoice);
                alert('è«‹æ±‚æ›¸ãŒæ­£å¸¸ã«ç™ºè¡Œã•ã‚Œã¾ã—ãŸã€‚');
            }

            saveAllData();
            clearInvoiceForm();
            refreshAllDisplays();
        }

        function generateInvoiceNumber() {
            const year = new Date().getFullYear();
            const month = String(new Date().getMonth() + 1).padStart(2, '0');
            const count = invoices.length + 1;
            return `INV-${year}${month}-${String(count).padStart(3, '0')}`;
        }

        function clearInvoiceForm() {
            document.getElementById('invoiceProject').value = '';
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDueDate').value = '';
            document.getElementById('invoiceAmount').value = '';
            document.getElementById('invoiceNumber').value = '';
            document.getElementById('taxAmount').value = '';
            document.getElementById('invoiceStatus').value = 'ä¸‹æ›¸ã';
            document.getElementById('paymentTerms').value = 'æœˆæœ«ç· ç¿Œæœˆæœ«æ‰•';
            document.getElementById('invoiceNotes').value = '';
        }

        function displayInvoices() {
            const tbody = document.getElementById('invoicesTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            invoices.forEach(invoice => {
                const project = projects.find(p => p.id === invoice.projectId);
                const paymentStatus = calculatePaymentStatus(invoice.id);
                const statusClass = paymentStatus.status === 'å…¥é‡‘æ¸ˆ' ? 'paid' : 
                                   paymentStatus.status === 'ä¸€éƒ¨å…¥é‡‘' ? 'partial' : 'unpaid';

                // Check for overdue
                const today = new Date();
                const dueDate = new Date(invoice.dueDate);
                const isOverdue = invoice.dueDate && dueDate < today && paymentStatus.status !== 'å…¥é‡‘æ¸ˆ';

                const row = `
                    <tr ${isOverdue ? 'class="aging-30"' : ''}>
                        <td>${invoice.invoiceNumber}</td>
                        <td>${project ? project.name : 'ä¸æ˜ãªå·¥äº‹'}</td>
                        <td>${project ? project.client : 'ä¸æ˜ãªé¡§å®¢'}</td>
                        <td>${invoice.issueDate}</td>
                        <td>Â¥${invoice.totalAmount.toLocaleString()}</td>
                        <td><span class="status status-${statusClass}">${paymentStatus.status}</span></td>
                        <td>Â¥${paymentStatus.paidAmount.toLocaleString()} / Â¥${invoice.totalAmount.toLocaleString()}</td>
                        <td>${invoice.dueDate || '-'}${isOverdue ? ' âš ï¸' : ''}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="registerPayment('${invoice.id}')">å…¥é‡‘ç™»éŒ²</button>
                            <button class="btn btn-warning btn-sm" onclick="editInvoice('${invoice.id}')">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice.id}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateInvoiceSummary() {
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            // Monthly invoices
            const monthlyInvoiceTotal = invoices
                .filter(inv => {
                    const invDate = new Date(inv.issueDate);
                    return invDate.getMonth() + 1 === currentMonth && invDate.getFullYear() === currentYear;
                })
                .reduce((sum, inv) => sum + Number(inv.totalAmount), 0);

            const monthlyInvoicesElement = document.getElementById('monthlyInvoices');
            if (monthlyInvoicesElement) {
                monthlyInvoicesElement.textContent = `Â¥${monthlyInvoiceTotal.toLocaleString()}`;
            }

            // Unpaid invoices
            let unpaidTotal = 0;
            invoices.forEach(invoice => {
                const paymentStatus = calculatePaymentStatus(invoice.id);
                unpaidTotal += paymentStatus.remainingAmount;
            });

            const unpaidInvoicesElement = document.getElementById('unpaidInvoices');
            if (unpaidInvoicesElement) {
                unpaidInvoicesElement.textContent = `Â¥${unpaidTotal.toLocaleString()}`;
            }
        }

        // Payment Management
        function addPayment() {
            const invoiceId = document.getElementById('paymentInvoice').value;
            const paymentDate = document.getElementById('paymentDate').value;
            const amount = document.getElementById('paymentAmount').value;

            if (!invoiceId || !paymentDate || !amount) {
                alert('è«‹æ±‚æ›¸ç•ªå·ã€å…¥é‡‘æ—¥ã€å…¥é‡‘é¡ã¯å¿…é ˆé …ç›®ã§ã™ã€‚');
                return;
            }

            if (editingPaymentId) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šæ—¢å­˜ã®å…¥é‡‘ã‚’æ›´æ–°
                const index = payments.findIndex(p => p.id === editingPaymentId);
                if (index !== -1) {
                    payments[index] = {
                        ...payments[index],
                        invoiceId: invoiceId,
                        paymentDate: paymentDate,
                        amount: Number(amount),
                        method: document.getElementById('paymentMethod').value,
                        payer: document.getElementById('payerName').value,
                        memo: document.getElementById('paymentMemo').value,
                        updatedAt: new Date().toISOString()
                    };
                }
                editingPaymentId = null;
                alert('å…¥é‡‘æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
            } else {
                // æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰
                const invoice = invoices.find(inv => inv.id === invoiceId);
                if (!invoice) {
                    alert('é¸æŠã•ã‚ŒãŸè«‹æ±‚æ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }

                const currentPaymentStatus = calculatePaymentStatus(invoiceId);
                const remainingAmount = currentPaymentStatus.remainingAmount;

                if (Number(amount) > remainingAmount) {
                    alert(`å…¥é‡‘é¡ãŒæ®‹é¡ï¼ˆÂ¥${remainingAmount.toLocaleString()}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
                    return;
                }

                const payment = {
                    id: generateId('PAY'),
                    invoiceId: invoiceId,
                    paymentDate: paymentDate,
                    amount: Number(amount),
                    method: document.getElementById('paymentMethod').value,
                    payer: document.getElementById('payerName').value,
                    memo: document.getElementById('paymentMemo').value,
                    timestamp: new Date().toISOString()
                };

                payments.push(payment);
                
                const newPaymentStatus = calculatePaymentStatus(invoiceId);
                const statusMessage = newPaymentStatus.status === 'å…¥é‡‘æ¸ˆ' ? 
                    'å…¥é‡‘ãŒå®Œäº†ã—ã¾ã—ãŸã€‚' : `éƒ¨åˆ†å…¥é‡‘ãŒç™»éŒ²ã•ã‚Œã¾ã—ãŸã€‚æ®‹é¡ï¼šÂ¥${newPaymentStatus.remainingAmount.toLocaleString()}`;
                alert(statusMessage);
            }

            saveAllData();
            clearPaymentForm();
            refreshAllDisplays();
        }

        function clearPaymentForm() {
            document.getElementById('paymentInvoice').value = '';
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentMethod').value = 'æŒ¯è¾¼';
            document.getElementById('paymentPayer').value = '';
            document.getElementById('paymentMemo').value = '';
        }

        function displayPayments() {
            const tbody = document.getElementById('paymentsTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            payments.forEach(payment => {
                const invoice = invoices.find(inv => inv.id === payment.invoiceId);
                const project = invoice ? projects.find(p => p.id === invoice.projectId) : null;
                const paymentStatus = calculatePaymentStatus(payment.invoiceId);

                const row = `
                    <tr>
                        <td>${payment.paymentDate}</td>
                        <td>${invoice ? invoice.invoiceNumber : 'ä¸æ˜'}</td>
                        <td>${project ? project.name : 'ä¸æ˜ãªå·¥äº‹'}</td>
                        <td>${project ? project.client : 'ä¸æ˜ãªé¡§å®¢'}</td>
                        <td>Â¥${payment.amount.toLocaleString()}</td>
                        <td>${payment.method}</td>
                        <td>Â¥${paymentStatus.remainingAmount.toLocaleString()}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editPayment('${payment.id}')">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deletePayment('${payment.id}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updatePaymentSummary() {
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            // Monthly payments
            const monthlyPaymentTotal = payments
                .filter(pay => {
                    const payDate = new Date(pay.paymentDate);
                    return payDate.getMonth() + 1 === currentMonth && payDate.getFullYear() === currentYear;
                })
                .reduce((sum, pay) => sum + Number(pay.amount), 0);

            const monthlyPaymentsElement = document.getElementById('monthlyPayments');
            if (monthlyPaymentsElement) {
                monthlyPaymentsElement.textContent = `Â¥${monthlyPaymentTotal.toLocaleString()}`;
            }

            // Total receivables
            let totalReceivables = 0;
            invoices.forEach(invoice => {
                const paymentStatus = calculatePaymentStatus(invoice.id);
                totalReceivables += paymentStatus.remainingAmount;
            });

            const totalReceivablesElement = document.getElementById('totalReceivables');
            if (totalReceivablesElement) {
                totalReceivablesElement.textContent = `Â¥${totalReceivables.toLocaleString()}`;
            }

            // Expected payments (current month)
            const expectedPayments = invoices
                .filter(inv => {
                    if (!inv.dueDate) return false;
                    const dueDate = new Date(inv.dueDate);
                    return dueDate.getMonth() + 1 === currentMonth && dueDate.getFullYear() === currentYear;
                })
                .reduce((sum, inv) => {
                    const paymentStatus = calculatePaymentStatus(inv.id);
                    return sum + paymentStatus.remainingAmount;
                }, 0);

            const expectedPaymentsElement = document.getElementById('expectedPayments');
            if (expectedPaymentsElement) {
                expectedPaymentsElement.textContent = `Â¥${expectedPayments.toLocaleString()}`;
            }
        }

        function updatePaymentInvoiceDropdown() {
            const paymentInvoice = document.getElementById('paymentInvoice');
            if (!paymentInvoice) return;

            paymentInvoice.innerHTML = '<option value="">æœªå…¥é‡‘ãƒ»ä¸€éƒ¨å…¥é‡‘ã®è«‹æ±‚æ›¸ã‚’é¸æŠ</option>';

            invoices.forEach(invoice => {
                const paymentStatus = calculatePaymentStatus(invoice.id);
                if (paymentStatus.status !== 'å…¥é‡‘æ¸ˆ') {
                    const project = projects.find(p => p.id === invoice.projectId);
                    const projectName = project ? project.name : 'ä¸æ˜ãªå·¥äº‹';
                    const clientName = project ? project.client : 'ä¸æ˜ãªé¡§å®¢';
                    const remainingAmount = paymentStatus.remainingAmount;

                    paymentInvoice.innerHTML += `
                        <option value="${invoice.id}">
                            ${invoice.invoiceNumber} - ${projectName} (${clientName}) - æ®‹é¡:Â¥${remainingAmount.toLocaleString()}
                        </option>
                    `;
                }
            });
        }

        function registerPayment(invoiceId) {
            document.getElementById('paymentInvoice').value = invoiceId;
            showSheet('payments');
        }

        // Receivables Management
        function displayReceivables() {
            const tbody = document.getElementById('receivablesTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            const unpaidInvoices = invoices.filter(invoice => {
                const paymentStatus = calculatePaymentStatus(invoice.id);
                return paymentStatus.remainingAmount > 0;
            });

            unpaidInvoices.forEach(invoice => {
                const project = projects.find(p => p.id === invoice.projectId);
                const paymentStatus = calculatePaymentStatus(invoice.id);

                // Calculate aging
                const today = new Date();
                const issueDate = new Date(invoice.issueDate);
                const daysPassed = Math.floor((today - issueDate) / (1000 * 60 * 60 * 24));

                let agingClass = '';
                if (daysPassed >= 30) agingClass = 'aging-30';
                else if (daysPassed >= 15) agingClass = 'aging-15';
                else agingClass = 'aging-current';

                const row = `
                    <tr class="${agingClass}">
                        <td>${invoice.invoiceNumber}</td>
                        <td>${invoice.issueDate}</td>
                        <td>${project ? project.client : 'ä¸æ˜ãªé¡§å®¢'}</td>
                        <td>Â¥${invoice.totalAmount.toLocaleString()}</td>
                        <td>Â¥${paymentStatus.paidAmount.toLocaleString()}</td>
                        <td>Â¥${paymentStatus.remainingAmount.toLocaleString()}</td>
                        <td>${invoice.dueDate || '-'}</td>
                        <td>${daysPassed}æ—¥</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="registerPayment('${invoice.id}')">å…¥é‡‘ç™»éŒ²</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Update customer receivables summary
            updateCustomerReceivables();
        }

        function updateCustomerReceivables() {
            const tbody = document.getElementById('customerReceivablesBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            const customerSummary = {};

            invoices.forEach(invoice => {
                const project = projects.find(p => p.id === invoice.projectId);
                const clientName = project ? project.client : 'ä¸æ˜ãªé¡§å®¢';
                const paymentStatus = calculatePaymentStatus(invoice.id);

                if (paymentStatus.remainingAmount > 0) {
                    if (!customerSummary[clientName]) {
                        customerSummary[clientName] = {
                            count: 0,
                            amount: 0,
                            oldestDate: invoice.issueDate
                        };
                    }

                    customerSummary[clientName].count++;
                    customerSummary[clientName].amount += paymentStatus.remainingAmount;

                    if (new Date(invoice.issueDate) < new Date(customerSummary[clientName].oldestDate)) {
                        customerSummary[clientName].oldestDate = invoice.issueDate;
                    }
                }
            });

            Object.entries(customerSummary).forEach(([client, summary]) => {
                const row = `
                    <tr>
                        <td>${client}</td>
                        <td>${summary.count}ä»¶</td>
                        <td>Â¥${summary.amount.toLocaleString()}</td>
                        <td>${summary.oldestDate}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="contactCustomer('${client}')">é€£çµ¡</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateReceivableSummary() {
            // Total receivables amount
            let totalReceivablesAmount = 0;
            let overdue30Amount = 0;

            invoices.forEach(invoice => {
                const paymentStatus = calculatePaymentStatus(invoice.id);
                totalReceivablesAmount += paymentStatus.remainingAmount;

                const today = new Date();
                const issueDate = new Date(invoice.issueDate);
                const daysPassed = Math.floor((today - issueDate) / (1000 * 60 * 60 * 24));

                if (daysPassed >= 30 && paymentStatus.remainingAmount > 0) {
                    overdue30Amount += paymentStatus.remainingAmount;
                }
            });

            const totalReceivablesAmountElement = document.getElementById('totalReceivablesAmount');
            if (totalReceivablesAmountElement) {
                totalReceivablesAmountElement.textContent = `Â¥${totalReceivablesAmount.toLocaleString()}`;
            }

            const overdue30Element = document.getElementById('overdue30');
            if (overdue30Element) {
                overdue30Element.textContent = `Â¥${overdue30Amount.toLocaleString()}`;
            }

            // Update expected payments calendar
            updateExpectedPaymentsCalendar();
        }

        function updateExpectedPaymentsCalendar() {
            const today = new Date();
            const thisWeekEnd = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            const nextWeekEnd = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000);
            const thisMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            let thisWeekExpected = 0;
            let nextWeekExpected = 0;
            let thisMonthExpected = 0;

            invoices.forEach(invoice => {
                if (!invoice.dueDate) return;

                const dueDate = new Date(invoice.dueDate);
                const paymentStatus = calculatePaymentStatus(invoice.id);
                const remaining = paymentStatus.remainingAmount;

                if (remaining > 0) {
                    if (dueDate <= thisWeekEnd) {
                        thisWeekExpected += remaining;
                    } else if (dueDate <= nextWeekEnd) {
                        nextWeekExpected += remaining;
                    }

                    if (dueDate <= thisMonthEnd) {
                        thisMonthExpected += remaining;
                    }
                }
            });

            const thisWeekElement = document.getElementById('thisWeekExpected');
            const nextWeekElement = document.getElementById('nextWeekExpected');
            const thisMonthElement = document.getElementById('thisMonthExpected');

            if (thisWeekElement) thisWeekElement.textContent = `Â¥${thisWeekExpected.toLocaleString()}`;
            if (nextWeekElement) nextWeekElement.textContent = `Â¥${nextWeekExpected.toLocaleString()}`;
            if (thisMonthElement) thisMonthElement.textContent = `Â¥${thisMonthExpected.toLocaleString()}`;
        }
        // Cash Flow Analysis
        function updateCashflowAnalysis() {
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            // Calculate current month data
            const monthlySales = invoices
                .filter(inv => {
                    const invDate = new Date(inv.issueDate);
                    return invDate.getMonth() + 1 === currentMonth && invDate.getFullYear() === currentYear;
                })
                .reduce((sum, inv) => sum + Number(inv.totalAmount), 0);

            const monthlyReceipts = payments
                .filter(pay => {
                    const payDate = new Date(pay.paymentDate);
                    return payDate.getMonth() + 1 === currentMonth && payDate.getFullYear() === currentYear;
                })
                .reduce((sum, pay) => sum + Number(pay.amount), 0);

            const paymentRate = monthlySales > 0 ? Math.round((monthlyReceipts / monthlySales) * 100) : 0;

            let outstandingAmount = 0;
            invoices.forEach(invoice => {
                const paymentStatus = calculatePaymentStatus(invoice.id);
                outstandingAmount += paymentStatus.remainingAmount;
            });

            // Update summary cards
            updateElement('monthlySales', `Â¥${monthlySales.toLocaleString()}`);
            updateElement('monthlyReceipts', `Â¥${monthlyReceipts.toLocaleString()}`);
            updateElement('paymentRate', `${paymentRate}%`);
            updateElement('outstandingAmount', `Â¥${outstandingAmount.toLocaleString()}`);

            // Generate charts
            generateCashflowChart();
            generateForecastChart();
        }

        function generateCashflowChart() {
            const ctx = document.getElementById('cashflowChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (window.cashflowChartInstance) {
                window.cashflowChartInstance.destroy();
            }

            // Get monthly data for the past 12 months
            const monthlyData = getMonthlyAnalysisData();

            window.cashflowChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.labels,
                    datasets: [
                        {
                            label: 'è«‹æ±‚é¡ï¼ˆå£²ä¸Šï¼‰',
                            data: monthlyData.invoiceAmounts,
                            backgroundColor: 'rgba(102, 126, 234, 0.6)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'å…¥é‡‘é¡',
                            data: monthlyData.paymentAmounts,
                            backgroundColor: 'rgba(86, 171, 47, 0.6)',
                            borderColor: 'rgba(86, 171, 47, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æœˆåˆ¥å…¥é‡‘å®Ÿç¸¾ã‚°ãƒ©ãƒ•ï¼ˆéå»12ãƒ¶æœˆï¼‰'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateForecastChart() {
            const ctx = document.getElementById('forecastChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (window.forecastChartInstance) {
                window.forecastChartInstance.destroy();
            }

            const forecastData = getForecastData();

            window.forecastChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: forecastData.labels,
                    datasets: [
                        {
                            label: 'å…¥é‡‘äºˆå®š',
                            data: forecastData.expected,
                            borderColor: 'rgba(240, 147, 251, 1)',
                            backgroundColor: 'rgba(240, 147, 251, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'å…¥é‡‘å®Ÿç¸¾',
                            data: forecastData.actual,
                            borderColor: 'rgba(79, 172, 254, 1)',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'å…¥é‡‘äºˆå®š vs å®Ÿç¸¾ã®æ¯”è¼ƒ'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function getMonthlyAnalysisData() {
            const data = {
                labels: [],
                invoiceAmounts: [],
                paymentAmounts: []
            };

            const now = new Date();

            for (let i = 11; i >= 0; i--) {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const month = targetDate.getMonth() + 1;
                const year = targetDate.getFullYear();

                data.labels.push(`${year}/${month}`);

                // Calculate invoice amounts for this month
                const monthlyInvoices = invoices
                    .filter(inv => {
                        const invDate = new Date(inv.issueDate);
                        return invDate.getMonth() + 1 === month && invDate.getFullYear() === year;
                    })
                    .reduce((sum, inv) => sum + Number(inv.totalAmount), 0);

                // Calculate payment amounts for this month
                const monthlyPayments = payments
                    .filter(pay => {
                        const payDate = new Date(pay.paymentDate);
                        return payDate.getMonth() + 1 === month && payDate.getFullYear() === year;
                    })
                    .reduce((sum, pay) => sum + Number(pay.amount), 0);

                data.invoiceAmounts.push(monthlyInvoices);
                data.paymentAmounts.push(monthlyPayments);
            }

            return data;
        }

        function getForecastData() {
            const data = {
                labels: [],
                expected: [],
                actual: []
            };

            const now = new Date();

            for (let i = 5; i >= 0; i--) {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const month = targetDate.getMonth() + 1;
                const year = targetDate.getFullYear();

                data.labels.push(`${year}/${month}`);

                // Calculate expected payments (due dates in this month)
                const expectedAmount = invoices
                    .filter(inv => {
                        if (!inv.dueDate) return false;
                        const dueDate = new Date(inv.dueDate);
                        return dueDate.getMonth() + 1 === month && dueDate.getFullYear() === year;
                    })
                    .reduce((sum, inv) => {
                        const paymentStatus = calculatePaymentStatus(inv.id);
                        return sum + paymentStatus.remainingAmount;
                    }, 0);

                // Calculate actual payments
                const actualAmount = payments
                    .filter(pay => {
                        const payDate = new Date(pay.paymentDate);
                        return payDate.getMonth() + 1 === month && payDate.getFullYear() === year;
                    })
                    .reduce((sum, pay) => sum + Number(pay.amount), 0);

                data.expected.push(expectedAmount);
                data.actual.push(actualAmount);
            }

            return data;
        }

        // Monthly Report Generation
        function generateMonthlyReport() {
            const year = Number(document.getElementById('monthlyYear').value);
            const month = Number(document.getElementById('monthlyMonth').value);

            const monthlyData = calculateMonthlyData(year, month);
            displayMonthlyReport(monthlyData);
        }

        function calculateMonthlyData(year, month) {
            // Accrual basis (invoice-based)
            const accrualRevenue = invoices
                .filter(inv => {
                    const invDate = new Date(inv.issueDate);
                    return invDate.getMonth() + 1 === month && invDate.getFullYear() === year;
                })
                .reduce((sum, inv) => sum + Number(inv.totalAmount), 0);

            const accrualExpenses = expenses
                .filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate.getMonth() + 1 === month && expDate.getFullYear() === year;
                })
                .reduce((sum, exp) => sum + Number(exp.amount), 0);

            // Cash basis (payment-based)
            const cashRevenue = payments
                .filter(pay => {
                    const payDate = new Date(pay.paymentDate);
                    return payDate.getMonth() + 1 === month && payDate.getFullYear() === year;
                })
                .reduce((sum, pay) => sum + Number(pay.amount), 0);

            const cashExpenses = accrualExpenses; // Assuming expenses are paid when recorded

            return {
                accrualRevenue,
                accrualExpenses,
                accrualProfit: accrualRevenue - accrualExpenses,
                cashRevenue,
                cashExpenses,
                cashProfit: cashRevenue - cashExpenses
            };
        }

        function displayMonthlyReport(data) {
            const tbody = document.getElementById('monthlyReportBody');
            if (!tbody) return;

            tbody.innerHTML = `
                <tr>
                    <td><strong>å£²ä¸Š</strong></td>
                    <td>Â¥${data.accrualRevenue.toLocaleString()}</td>
                    <td>Â¥${data.cashRevenue.toLocaleString()}</td>
                    <td>Â¥${(data.cashRevenue - data.accrualRevenue).toLocaleString()}</td>
                </tr>
                <tr>
                    <td><strong>çµŒè²»</strong></td>
                    <td>Â¥${data.accrualExpenses.toLocaleString()}</td>
                    <td>Â¥${data.cashExpenses.toLocaleString()}</td>
                    <td>Â¥${(data.cashExpenses - data.accrualExpenses).toLocaleString()}</td>
                </tr>
                <tr>
                    <td><strong>åˆ©ç›Š</strong></td>
                    <td>Â¥${data.accrualProfit.toLocaleString()}</td>
                    <td>Â¥${data.cashProfit.toLocaleString()}</td>
                    <td>Â¥${(data.cashProfit - data.accrualProfit).toLocaleString()}</td>
                </tr>
            `;
        }

        // Yearly Report Generation
        function generateYearlyReport() {
            const year = Number(document.getElementById('yearlyAnalysisYear').value);
            const yearlyData = calculateYearlyData(year);
            displayYearlyReport(yearlyData);
            generateYearlyChart(year);
        }

        function calculateYearlyData(year) {
            const yearlySales = invoices
                .filter(inv => new Date(inv.issueDate).getFullYear() === year)
                .reduce((sum, inv) => sum + Number(inv.totalAmount), 0);

            const yearlyExpenses = expenses
                .filter(exp => new Date(exp.date).getFullYear() === year)
                .reduce((sum, exp) => sum + Number(exp.amount), 0);

            const yearlyProfit = yearlySales - yearlyExpenses;
            const yearlyMargin = yearlySales > 0 ? Math.round((yearlyProfit / yearlySales) * 100) : 0;

            return { yearlySales, yearlyExpenses, yearlyProfit, yearlyMargin };
        }

        function displayYearlyReport(data) {
            updateElement('yearlySales', `Â¥${data.yearlySales.toLocaleString()}`);
            updateElement('yearlyExpenses', `Â¥${data.yearlyExpenses.toLocaleString()}`);
            updateElement('yearlyProfit', `Â¥${data.yearlyProfit.toLocaleString()}`);
            updateElement('yearlyMargin', `${data.yearlyMargin}%`);
        }

        function generateYearlyChart(year) {
            const ctx = document.getElementById('yearlyChart');
            if (!ctx) return;

            if (window.yearlyChartInstance) {
                window.yearlyChartInstance.destroy();
            }

            const monthlyData = [];
            const labels = [];

            for (let month = 1; month <= 12; month++) {
                labels.push(`${month}æœˆ`);
                const monthlyProfit = calculateMonthlyData(year, month);
                monthlyData.push(monthlyProfit.accrualProfit);
            }

            window.yearlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æœˆæ¬¡åˆ©ç›Š',
                        data: monthlyData,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}å¹´ æœˆæ¬¡åˆ©ç›Šæ¨ç§»`
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Tax Report Functions
        function generateTaxReports() {
            alert('ç¨å‹™è³‡æ–™ã®ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™ã€‚å„ç¨®å°å¸³ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã§ãã¾ã™ã€‚');
        }

        // CSV Export Functions
        function exportProjectsCSV() {
            const headers = ['å·¥äº‹ID', 'å·¥äº‹å', 'é¡§å®¢å', 'å¥‘ç´„é‡‘é¡', 'é–‹å§‹æ—¥', 'å®Œäº†äºˆå®šæ—¥', 'çŠ¶æ³', 'å ´æ‰€', 'æ‹…å½“è€…', 'å‚™è€ƒ'];
            const rows = projects.map(p => [
                p.id, p.name, p.client, p.contractAmount, p.startDate || '', 
                p.completionDate || '', p.status, p.location || '', p.manager || '', p.notes || ''
            ]);
            downloadCSV(headers, rows, 'projects.csv');
        }

        function exportExpensesCSV() {
            const headers = ['çµŒè²»ID', 'é–¢é€£å·¥äº‹', 'æ—¥ä»˜', 'è²»ç›®', 'é‡‘é¡', 'å–å¼•å…ˆ', 'æ”¯æ‰•æ–¹æ³•', 'é ˜åæ›¸ç•ªå·', 'ç¨å‹™åŒºåˆ†', 'æ‘˜è¦'];
            const rows = expenses.map(e => {
                const project = projects.find(p => p.id === e.projectId);
                return [
                    e.id, project ? project.name : 'ä¸€èˆ¬çµŒè²»', e.date, e.category, e.amount,
                    e.supplier || '', e.paymentMethod, e.receiptNumber || '', e.taxType, e.description || ''
                ];
            });
            downloadCSV(headers, rows, 'expenses.csv');
        }

        function exportInvoicesCSV() {
            const headers = ['è«‹æ±‚æ›¸ID', 'è«‹æ±‚æ›¸ç•ªå·', 'å·¥äº‹å', 'é¡§å®¢å', 'ç™ºè¡Œæ—¥', 'è«‹æ±‚é‡‘é¡', 'æ¶ˆè²»ç¨', 'å…¥é‡‘äºˆå®šæ—¥', 'çŠ¶æ³', 'å‚™è€ƒ'];
            const rows = invoices.map(i => {
                const project = projects.find(p => p.id === i.projectId);
                return [
                    i.id, i.invoiceNumber, project ? project.name : 'ä¸æ˜', project ? project.client : 'ä¸æ˜',
                    i.issueDate, i.totalAmount, i.taxAmount, i.dueDate || '', i.status, i.notes || ''
                ];
            });
            downloadCSV(headers, rows, 'invoices.csv');
        }

        function exportPaymentLedger() {
            const headers = ['å…¥é‡‘ID', 'è«‹æ±‚æ›¸ç•ªå·', 'å·¥äº‹å', 'é¡§å®¢å', 'å…¥é‡‘æ—¥', 'å…¥é‡‘é¡', 'å…¥é‡‘æ–¹æ³•', 'åç¾©äºº', 'ãƒ¡ãƒ¢'];
            const rows = payments.map(p => {
                const invoice = invoices.find(i => i.id === p.invoiceId);
                const project = invoice ? projects.find(pr => pr.id === invoice.projectId) : null;
                return [
                    p.id, invoice ? invoice.invoiceNumber : 'ä¸æ˜', 
                    project ? project.name : 'ä¸æ˜', project ? project.client : 'ä¸æ˜',
                    p.paymentDate, p.amount, p.method, p.payer || '', p.memo || ''
                ];
            });
            downloadCSV(headers, rows, 'payments.csv');
        }

        function exportSalesLedger() {
            const headers = ['è«‹æ±‚æ›¸ç•ªå·', 'ç™ºè¡Œæ—¥', 'é¡§å®¢å', 'å·¥äº‹å', 'è«‹æ±‚é¡', 'å…¥é‡‘é¡', 'æ®‹é¡', 'å…¥é‡‘çŠ¶æ³'];
            const rows = invoices.map(i => {
                const project = projects.find(p => p.id === i.projectId);
                const paymentStatus = calculatePaymentStatus(i.id);
                return [
                    i.invoiceNumber, i.issueDate, project ? project.client : 'ä¸æ˜',
                    project ? project.name : 'ä¸æ˜', i.totalAmount,
                    paymentStatus.paidAmount, paymentStatus.remainingAmount, paymentStatus.status
                ];
            });
            downloadCSV(headers, rows, 'sales_ledger.csv');
        }

        function exportExpenseLedger() {
            exportExpensesCSV(); // Same as expense export
        }

        function exportProfitLoss() {
            const currentYear = new Date().getFullYear();
            const headers = ['æœˆ', 'å£²ä¸Šï¼ˆè«‹æ±‚ãƒ™ãƒ¼ã‚¹ï¼‰', 'å£²ä¸Šï¼ˆå…¥é‡‘ãƒ™ãƒ¼ã‚¹ï¼‰', 'çµŒè²»', 'åˆ©ç›Šï¼ˆè«‹æ±‚ãƒ™ãƒ¼ã‚¹ï¼‰', 'åˆ©ç›Šï¼ˆå…¥é‡‘ãƒ™ãƒ¼ã‚¹ï¼‰'];
            const rows = [];

            for (let month = 1; month <= 12; month++) {
                const monthlyData = calculateMonthlyData(currentYear, month);
                rows.push([
                    `${month}æœˆ`, monthlyData.accrualRevenue, monthlyData.cashRevenue,
                    monthlyData.accrualExpenses, monthlyData.accrualProfit, monthlyData.cashProfit
                ]);
            }
            downloadCSV(headers, rows, 'profit_loss.csv');
        }

        function exportMonthlyCSV() {
            const year = Number(document.getElementById('monthlyYear').value);
            const month = Number(document.getElementById('monthlyMonth').value);
            const monthlyData = calculateMonthlyData(year, month);

            const headers = ['é …ç›®', 'ç™ºç”Ÿä¸»ç¾©', 'ç¾é‡‘ä¸»ç¾©', 'å·®é¡'];
            const rows = [
                ['å£²ä¸Š', monthlyData.accrualRevenue, monthlyData.cashRevenue, monthlyData.cashRevenue - monthlyData.accrualRevenue],
                ['çµŒè²»', monthlyData.accrualExpenses, monthlyData.cashExpenses, monthlyData.cashExpenses - monthlyData.accrualExpenses],
                ['åˆ©ç›Š', monthlyData.accrualProfit, monthlyData.cashProfit, monthlyData.cashProfit - monthlyData.accrualProfit]
            ];
            downloadCSV(headers, rows, `monthly_report_${year}_${month}.csv`);
        }

        // Utility Functions
        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        }

        function downloadCSV(headers, rows, filename) {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += headers.join(",") + "\n";
            rows.forEach(row => {
                csvContent += row.map(field => `"${field}"`).join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function contactCustomer(customerName) {
            alert(`${customerName}æ§˜ã¸ã®é€£çµ¡æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™ã€‚`);
        }

        // å·¥äº‹ç·¨é›†æ©Ÿèƒ½
        let editingProjectId = null;
        
        function editProject(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;
            
            editingProjectId = id;
            
            document.getElementById('projectName').value = project.name;
            document.getElementById('clientName').value = project.client;
            document.getElementById('projectDate').value = project.startDate || '';
            document.getElementById('completionDate').value = project.completionDate || '';
            document.getElementById('contractAmount').value = project.contractAmount || '';
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('projectLocation').value = project.location || '';
            document.getElementById('projectManager').value = project.manager || '';
            document.getElementById('projectNotes').value = project.notes || '';
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
            document.getElementById('construction-sheet').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('projectName').focus();
            
            alert('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ä¿®æ­£å¾Œã€Œå·¥äº‹ã‚’ç™»éŒ²ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
        }
        function deleteProject(id) { 
            if (confirm('ã“ã®å·¥äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                projects = projects.filter(p => p.id !== id);
                saveAllData();
                refreshAllDisplays();
            }
        }
        // çµŒè²»ç·¨é›†æ©Ÿèƒ½
        let editingExpenseId = null;
        
        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            
            editingExpenseId = id;
            
            document.getElementById('expenseProject').value = expense.projectId || '';
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseCategory').value = expense.category;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseSupplier').value = expense.supplier;
            document.getElementById('expensePaymentMethod').value = expense.paymentMethod;
            document.getElementById('expenseReceipt').value = expense.receiptNumber || '';
            document.getElementById('expenseTax').value = expense.taxType;
            document.getElementById('expenseDescription').value = expense.description || '';
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
            document.getElementById('expenses-sheet').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('expenseDate').focus();
            
            alert('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ä¿®æ­£å¾Œã€ŒçµŒè²»ã‚’ç™»éŒ²ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
        }
        function deleteExpense(id) { 
            if (confirm('ã“ã®çµŒè²»ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                expenses = expenses.filter(e => e.id !== id);
                saveAllData();
                refreshAllDisplays();
            }
        }
        // è«‹æ±‚æ›¸ç·¨é›†æ©Ÿèƒ½
        let editingInvoiceId = null;
        
        function editInvoice(id) {
            const invoice = invoices.find(i => i.id === id);
            if (!invoice) return;
            
            editingInvoiceId = id;
            
            document.getElementById('invoiceProject').value = invoice.projectId;
            document.getElementById('invoiceDate').value = invoice.issueDate;
            document.getElementById('invoiceDueDate').value = invoice.dueDate || '';
            document.getElementById('invoiceAmount').value = invoice.totalAmount;
            document.getElementById('invoiceNumber').value = invoice.invoiceNumber || '';
            document.getElementById('taxAmount').value = invoice.taxAmount || '';
            document.getElementById('invoiceStatus').value = invoice.status;
            document.getElementById('paymentTerms').value = invoice.paymentTerms;
            document.getElementById('invoiceNotes').value = invoice.notes || '';
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
            document.getElementById('invoices-sheet').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('invoiceDate').focus();
            
            alert('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ä¿®æ­£å¾Œã€Œè«‹æ±‚æ›¸ã‚’ç™ºè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
        }
        function deleteInvoice(id) { 
            if (confirm('ã“ã®è«‹æ±‚æ›¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                invoices = invoices.filter(i => i.id !== id);
                payments = payments.filter(p => p.invoiceId !== id);
                saveAllData();
                refreshAllDisplays();
            }
        }
        // å…¥é‡‘ç·¨é›†æ©Ÿèƒ½
        let editingPaymentId = null;
        
        function editPayment(id) {
            const payment = payments.find(p => p.id === id);
            if (!payment) return;
            
            editingPaymentId = id;
            
            document.getElementById('paymentInvoice').value = payment.invoiceId;
            document.getElementById('paymentDate').value = payment.paymentDate;
            document.getElementById('paymentAmount').value = payment.amount;
            document.getElementById('paymentMethod').value = payment.method;
            document.getElementById('payerName').value = payment.payer || '';
            document.getElementById('paymentMemo').value = payment.memo || '';
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
            document.getElementById('payments-sheet').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('paymentDate').focus();
            
            alert('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ä¿®æ­£å¾Œã€Œå…¥é‡‘ã‚’è¨˜éŒ²ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
        }
        function deletePayment(id) { 
            if (confirm('ã“ã®å…¥é‡‘è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                payments = payments.filter(p => p.id !== id);
                saveAllData();
                refreshAllDisplays();
            }
        }

        // ==================== ä»•å…¥ã‚Œç®¡ç†æ©Ÿèƒ½ ====================
        function addPurchase() {
            const purchaseDate = document.getElementById('purchaseDate').value;
            const purchaseProject = document.getElementById('purchaseProject').value;
            const purchaseCategory = document.getElementById('purchaseCategory').value;
            const purchaseAmount = parseFloat(document.getElementById('purchaseAmount').value);
            const purchaseSupplier = document.getElementById('purchaseSupplier').value;
            const purchaseBillingMonth = document.getElementById('purchaseBillingMonth').value;
            const purchasePaymentMonth = document.getElementById('purchasePaymentMonth').value;
            const purchasePaymentStatus = document.getElementById('purchasePaymentStatus').value;
            const purchasePaymentMethod = document.getElementById('purchasePaymentMethod').value;
            const purchaseActualPaymentDate = document.getElementById('purchaseActualPaymentDate').value;
            const purchaseInvoiceNumber = document.getElementById('purchaseInvoiceNumber').value;
            const purchaseQuantity = document.getElementById('purchaseQuantity').value;
            const purchaseUnit = document.getElementById('purchaseUnit').value;
            const purchaseTax = document.getElementById('purchaseTax').value;
            const purchaseDescription = document.getElementById('purchaseDescription').value;

            if (!purchaseDate || !purchaseCategory || !purchaseAmount || !purchaseSupplier) {
                alert('âš ï¸ å¿…é ˆé …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // è«‹æ±‚æœˆãŒæœªå…¥åŠ›ã®å ´åˆã€ä»•å…¥æ—¥ã‹ã‚‰è‡ªå‹•è¨ˆç®—ï¼ˆåŒæœˆã®æœˆæœ«ç· ã‚ï¼‰
            let billingMonth = purchaseBillingMonth;
            if (!billingMonth && purchaseDate) {
                const date = new Date(purchaseDate);
                billingMonth = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
            }

            // æ”¯æ‰•äºˆå®šæœˆãŒæœªå…¥åŠ›ã®å ´åˆã€è«‹æ±‚æœˆã®ç¿Œæœˆã‚’è‡ªå‹•è¨ˆç®—
            let paymentMonth = purchasePaymentMonth;
            if (!paymentMonth && billingMonth) {
                const [year, month] = billingMonth.split('-').map(Number);
                const nextMonth = new Date(year, month, 1); // ç¿Œæœˆã®1æ—¥
                paymentMonth = nextMonth.getFullYear() + '-' + String(nextMonth.getMonth() + 1).padStart(2, '0');
            }

            const purchase = {
                id: Date.now(),
                date: purchaseDate,
                project: purchaseProject,
                category: purchaseCategory,
                amount: purchaseAmount,
                supplier: purchaseSupplier,
                billingMonth: billingMonth,
                paymentMonth: paymentMonth,
                paymentStatus: purchasePaymentStatus,
                paymentMethod: purchasePaymentMethod,
                actualPaymentDate: purchaseActualPaymentDate,
                invoiceNumber: purchaseInvoiceNumber,
                quantity: purchaseQuantity,
                unit: purchaseUnit,
                tax: purchaseTax,
                description: purchaseDescription
            };

            purchases.push(purchase);
            localStorage.setItem('purchases', JSON.stringify(purchases));
            updatePurchasesTable();
            updatePurchaseSummary();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('purchaseDate').value = '';
            document.getElementById('purchaseProject').value = '';
            document.getElementById('purchaseCategory').value = '';
            document.getElementById('purchaseAmount').value = '';
            document.getElementById('purchaseSupplier').value = '';
            document.getElementById('purchaseBillingMonth').value = '';
            document.getElementById('purchasePaymentMonth').value = '';
            document.getElementById('purchasePaymentStatus').value = 'æœªè«‹æ±‚';
            document.getElementById('purchasePaymentMethod').value = 'éŠ€è¡ŒæŒ¯è¾¼';
            document.getElementById('purchaseActualPaymentDate').value = '';
            document.getElementById('purchaseInvoiceNumber').value = '';
            document.getElementById('purchaseQuantity').value = '';
            document.getElementById('purchaseUnit').value = '';
            document.getElementById('purchaseTax').value = 'èª²ç¨';
            document.getElementById('purchaseDescription').value = '';

            alert('âœ… ä»•å…¥ã‚Œã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
        }

        function updatePurchasesTable() {
            const tbody = document.getElementById('purchasesTableBody');
            tbody.innerHTML = '';

            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            const sortedPurchases = [...purchases].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedPurchases.forEach(purchase => {
                const projectName = projects.find(p => p.id == purchase.project)?.name || '-';
                
                let statusClass = 'status-not-invoiced';
                if (purchase.paymentStatus === 'æ”¯æ‰•æ¸ˆ') statusClass = 'status-paid';
                else if (purchase.paymentStatus === 'è«‹æ±‚æ¸ˆãƒ»æœªæ‰•ã„') statusClass = 'status-unpaid';
                else if (purchase.paymentStatus === 'æœªè«‹æ±‚') statusClass = 'status-not-invoiced';

                // è«‹æ±‚æœˆã¨æ”¯æ‰•äºˆå®šæœˆã®è¡¨ç¤º
                const billingMonthDisplay = purchase.billingMonth ? formatYearMonth(purchase.billingMonth) : '-';
                const paymentMonthDisplay = purchase.paymentMonth ? formatYearMonth(purchase.paymentMonth) : '-';

                const row = `
                    <tr>
                        <td>${purchase.date}</td>
                        <td>${projectName}</td>
                        <td>${purchase.category}</td>
                        <td>${purchase.description || '-'}</td>
                        <td>${purchase.supplier}</td>
                        <td style="text-align: right; font-weight: 600;">Â¥${purchase.amount.toLocaleString()}</td>
                        <td>${billingMonthDisplay}</td>
                        <td>${paymentMonthDisplay}</td>
                        <td><span class="status ${statusClass}">${purchase.paymentStatus}</span></td>
                        <td>${purchase.actualPaymentDate || '-'}</td>
                        <td>
                            <button class="btn btn-warning" onclick="editPurchase(${purchase.id})">ç·¨é›†</button>
                            <button class="btn btn-danger" onclick="deletePurchase(${purchase.id})">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // YYYY-MMå½¢å¼ã‚’YYYYå¹´MMæœˆã«å¤‰æ›
        function formatYearMonth(yearMonth) {
            if (!yearMonth) return '-';
            const [year, month] = yearMonth.split('-');
            return `${year}å¹´${month}æœˆ`;
        }

        function updatePurchaseSummary() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const currentYearMonth = currentYear + '-' + String(currentMonth + 1).padStart(2, '0');
            
            const nextMonth = new Date(currentYear, currentMonth + 1, 1);
            const nextYearMonth = nextMonth.getFullYear() + '-' + String(nextMonth.getMonth() + 1).padStart(2, '0');

            // ä»Šæœˆã®ç™ºæ³¨ç·é¡ï¼ˆä»•å…¥æ—¥ãƒ™ãƒ¼ã‚¹ï¼‰
            const monthlyTotal = purchases
                .filter(p => {
                    const pDate = new Date(p.date);
                    return pDate.getMonth() === currentMonth && pDate.getFullYear() === currentYear;
                })
                .reduce((sum, p) => sum + p.amount, 0);

            document.getElementById('monthlyPurchases').textContent = 'Â¥' + monthlyTotal.toLocaleString();

            // ä»Šæœˆã®æ”¯æ‰•äºˆå®šé¡
            const currentMonthPaymentTotal = purchases
                .filter(p => p.paymentMonth === currentYearMonth && p.paymentStatus !== 'æ”¯æ‰•æ¸ˆ')
                .reduce((sum, p) => sum + p.amount, 0);

            document.getElementById('currentMonthPayment').textContent = 'Â¥' + currentMonthPaymentTotal.toLocaleString();

            // æœªæ‰•ã„ç·é¡ï¼ˆè«‹æ±‚æ¸ˆã¿ã§æœªæ‰•ã„ï¼‰
            const unpaidTotal = purchases
                .filter(p => p.paymentStatus === 'è«‹æ±‚æ¸ˆãƒ»æœªæ‰•ã„')
                .reduce((sum, p) => sum + p.amount, 0);

            document.getElementById('unpaidPurchases').textContent = 'Â¥' + unpaidTotal.toLocaleString();

            // æ¥æœˆã®æ”¯æ‰•äºˆå®šé¡
            const nextMonthPaymentTotal = purchases
                .filter(p => p.paymentMonth === nextYearMonth && p.paymentStatus !== 'æ”¯æ‰•æ¸ˆ')
                .reduce((sum, p) => sum + p.amount, 0);

            document.getElementById('nextMonthPayment').textContent = 'Â¥' + nextMonthPaymentTotal.toLocaleString();
        }

        function deletePurchase(id) {
            if (confirm('ã“ã®ä»•å…¥ã‚Œè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                purchases = purchases.filter(p => p.id !== id);
                localStorage.setItem('purchases', JSON.stringify(purchases));
                updatePurchasesTable();
                updatePurchaseSummary();
                alert('å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        function editPurchase(id) {
            const purchase = purchases.find(p => p.id === id);
            if (!purchase) return;

            document.getElementById('purchaseDate').value = purchase.date;
            document.getElementById('purchaseProject').value = purchase.project || '';
            document.getElementById('purchaseCategory').value = purchase.category;
            document.getElementById('purchaseAmount').value = purchase.amount;
            document.getElementById('purchaseSupplier').value = purchase.supplier;
            document.getElementById('purchaseBillingMonth').value = purchase.billingMonth || '';
            document.getElementById('purchasePaymentMonth').value = purchase.paymentMonth || '';
            document.getElementById('purchasePaymentStatus').value = purchase.paymentStatus;
            document.getElementById('purchasePaymentMethod').value = purchase.paymentMethod;
            document.getElementById('purchaseActualPaymentDate').value = purchase.actualPaymentDate || '';
            document.getElementById('purchaseInvoiceNumber').value = purchase.invoiceNumber || '';
            document.getElementById('purchaseQuantity').value = purchase.quantity || '';
            document.getElementById('purchaseUnit').value = purchase.unit || '';
            document.getElementById('purchaseTax').value = purchase.tax;
            document.getElementById('purchaseDescription').value = purchase.description || '';

            deletePurchase(id);
            alert('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ä¿®æ­£å¾Œã€Œä»•å…¥ã‚Œã‚’ç™»éŒ²ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
        }

        function exportPurchasesCSV() {
            let csv = 'ID,ä»•å…¥æ—¥,é–¢é€£å·¥äº‹,ä»•å…¥ã‚Œç¨®åˆ¥,å•†å“åãƒ»è©³ç´°,ä»•å…¥ã‚Œå…ˆ,é‡‘é¡,è«‹æ±‚æœˆ,æ”¯æ‰•äºˆå®šæœˆ,æ”¯æ‰•çŠ¶æ³,å®Ÿæ”¯æ‰•æ—¥,æ”¯æ‰•æ–¹æ³•,ä¼ç¥¨ç•ªå·,æ•°é‡,å˜ä½,ç¨å‹™åŒºåˆ†\n';
            
            purchases.forEach(purchase => {
                const projectName = projects.find(p => p.id == purchase.project)?.name || '';
                csv += `${purchase.id},"${purchase.date}","${projectName}","${purchase.category}","${purchase.description || ''}","${purchase.supplier}",${purchase.amount},"${purchase.billingMonth || ''}","${purchase.paymentMonth || ''}","${purchase.paymentStatus}","${purchase.actualPaymentDate || ''}","${purchase.paymentMethod}","${purchase.invoiceNumber || ''}","${purchase.quantity || ''}","${purchase.unit || ''}","${purchase.tax}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ä»•å…¥ã‚Œè¨˜éŒ²_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

    </script>
</body>
</html>