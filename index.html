<!DOCTYPE html>
<!-- saved from url=(0072)file:///C:/Users/msint/Downloads/msinterior_system_v3_1763278910787.html -->
<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¨ãƒ ã‚ºã‚¤ãƒ³ãƒ†ãƒªã‚¢ çµŒç†ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v3.0</title>
    <script src="./index_files/chart.js.ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic Pro', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro W3', 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 20px;
            background: #fff;
            border: none;
            border-right: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
            position: relative;
            min-width: 120px;
        }

        .tab:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .content {
            padding: 30px;
            min-height: 600px;
            background: #fff;
        }

        .sheet {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .sheet.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .form-col {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-not-invoiced {
            background: #e9ecef;
            color: #495057;
        }

        .status-unpaid {
            background: #ffebee;
            color: #c62828;
        }

        .status-partial {
            background: #fff3e0;
            color: #ef6c00;
        }

        .status-paid {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .summary-card {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid;
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card h3 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 1.1rem;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .summary-card.primary { border-left-color: #667eea; }
        .summary-card.success { border-left-color: #56ab2f; }
        .summary-card.warning { border-left-color: #f093fb; }
        .summary-card.danger { border-left-color: #ff6b6b; }

        .summary-card.primary .summary-value { color: #667eea; }
        .summary-card.success .summary-value { color: #56ab2f; }
        .summary-card.warning .summary-value { color: #f093fb; }
        .summary-card.danger .summary-value { color: #ff6b6b; }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .payment-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }

        .aging-30 { background-color: #ffebee !important; }
        .aging-15 { background-color: #fff3e0 !important; }
        .aging-current { background-color: #e8f5e8 !important; }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .content {
                padding: 15px;
            }

            .form-row {
                flex-direction: column;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                min-width: auto;
                text-align: center;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                font-size: 0.9rem;
            }

            th, td {
                padding: 10px 5px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            input, select, textarea, .btn {
                font-size: 14px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  ã‚¨ãƒ ã‚ºã‚¤ãƒ³ãƒ†ãƒªã‚¢ çµŒç†ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>å·¥äº‹ç®¡ç†ãƒ»çµŒè²»ãƒ»è«‹æ±‚æ›¸ãƒ»å…¥é‡‘ç®¡ç†ã‚’ä¸€å…ƒåŒ–</p>
        </div>

                <div class="tabs">
            <button class="tab active" onclick="showSheet(&#39;construction&#39;)">ğŸ—ï¸ å·¥äº‹å°å¸³</button>
            <button class="tab" onclick="showSheet(&#39;clients&#39;)">ğŸ‘¥ é¡§å®¢å°å¸³</button>
            <button class="tab" onclick="showSheet(&#39;suppliers&#39;)">ğŸ¢ ä»•å…¥å…ˆå°å¸³</button>
            <button class="tab" onclick="showSheet(&#39;expenses&#39;)">ğŸ’° çµŒè²»ç®¡ç†</button>
            <button class="tab" onclick="showSheet(&#39;payables&#39;)">ğŸ“‹ è²·æ›é‡‘ç®¡ç†</button>
            <button class="tab" onclick="showSheet(&#39;invoices&#39;)">ğŸ“‹ è«‹æ±‚æ›¸</button>
            <button class="tab" onclick="showSheet(&#39;payments&#39;)">ğŸ’³ å…¥é‡‘è¨˜éŒ²</button>
            <button class="tab" onclick="showSheet(&#39;receivables&#39;)">ğŸ“Š å£²æ›é‡‘ç®¡ç†</button>
            <button class="tab" onclick="showSheet(&#39;cashflow&#39;)">ğŸ’¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼</button>
            <button class="tab" onclick="showSheet(&#39;monthly&#39;)">ğŸ“ˆ æœˆæ¬¡æç›Š</button>
            <button class="tab" onclick="showSheet(&#39;yearly&#39;)">ğŸ“… å¹´æ¬¡åˆ†æ</button>
            <button class="tab" onclick="showSheet(&#39;tax&#39;)">ğŸ§¾ ç¨å‹™è³‡æ–™</button>
            <button class="tab" onclick="showSheet(&#39;manual&#39;)">ğŸ“– ä½¿ã„æ–¹</button>
        </div>
        <div class="content">
            <!-- å·¥äº‹å°å¸³ -->
            <div id="construction-sheet" class="sheet active">
                <h2>ğŸ—ï¸ å·¥äº‹å°å¸³ç®¡ç†</h2>

                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="projectName">å·¥äº‹å *</label>
                            <input type="text" id="projectName" required="">
                        </div>
                        <div class="form-col">
                            <label for="clientName">é¡§å®¢å *</label>
                            <input type="text" id="clientName" required="">
                        </div>
                        <div class="form-col">
                            <label for="projectDate">å·¥äº‹é–‹å§‹æ—¥</label>
                            <input type="date" id="projectDate">
                        </div>
                        <div class="form-col">
                            <label for="completionDate">å®Œäº†äºˆå®šæ—¥</label>
                            <input type="date" id="completionDate">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="contractAmount">å¥‘ç´„é‡‘é¡ï¼ˆå††ï¼‰</label>
                            <input type="number" id="contractAmount" min="0">
                        </div>
                        <div class="form-col">
                            <label for="projectStatus">å·¥äº‹çŠ¶æ³</label>
                            <select id="projectStatus">
                                <option value="è¨ˆç”»ä¸­">è¨ˆç”»ä¸­</option>
                                <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
                                <option value="å®Œäº†">å®Œäº†</option>
                                <option value="ä¸­æ–­">ä¸­æ–­</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="projectLocation">å·¥äº‹å ´æ‰€</label>
                            <input type="text" id="projectLocation">
                        </div>
                        <div class="form-col">
                            <label for="projectManager">æ‹…å½“è€…</label>
                            <input type="text" id="projectManager">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="projectNotes">å‚™è€ƒ</label>
                        <textarea id="projectNotes" placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="addProject()">å·¥äº‹ã‚’ç™»éŒ²</button>
                    <button class="btn btn-info" onclick="exportProjectsCSV()">CSVå‡ºåŠ›</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>å·¥äº‹å</th>
                                <th>é¡§å®¢å</th>
                                <th>å¥‘ç´„é‡‘é¡</th>
                                <th>é–‹å§‹æ—¥</th>
                                <th>å®Œäº†äºˆå®š</th>
                                <th>çŠ¶æ³</th>
                                <th>å…¥é‡‘çŠ¶æ³</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                    <tr>
                        <td>ç”°ä¸­æ§˜é‚¸ã‚­ãƒƒãƒãƒ³ãƒªãƒ•ã‚©ãƒ¼ãƒ </td>
                        <td>ç”°ä¸­å¤ªéƒ</td>
                        <td>Â¥1,200,000</td>
                        <td>2025-01-15</td>
                        <td>2025-02-15</td>
                        <td><span class="status status-é€²è¡Œä¸­">é€²è¡Œä¸­</span></td>
                        <td><span class="status status-not-invoiced">æœªè«‹æ±‚</span></td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editProject(&#39;PRJ-2025-001&#39;)">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProject(&#39;PRJ-2025-001&#39;)">å‰Šé™¤</button>
                        </td>
                    </tr>
                
                    <tr>
                        <td>å±±ç”°å•†åº—äº‹å‹™æ‰€æ”¹è£…</td>
                        <td>å±±ç”°å•†åº—</td>
                        <td>Â¥800,000</td>
                        <td>2025-01-10</td>
                        <td>2025-01-25</td>
                        <td><span class="status status-å®Œäº†">å®Œäº†</span></td>
                        <td><span class="status status-partial">ä¸€éƒ¨å…¥é‡‘</span></td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editProject(&#39;PRJ-2025-002&#39;)">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProject(&#39;PRJ-2025-002&#39;)">å‰Šé™¤</button>
                        </td>
                    </tr>
                </tbody>
                    </table>
                </div>
            </div>


            <!-- é¡§å®¢å°å¸³ -->
            <div id="clients-sheet" class="sheet">
                <h2>ğŸ‘¥ é¡§å®¢å°å¸³ç®¡ç†</h2>

                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="clientCode">é¡§å®¢ã‚³ãƒ¼ãƒ‰</label>
                            <input type="text" id="clientCode" placeholder="è‡ªå‹•ç”Ÿæˆ">
                        </div>
                        <div class="form-col">
                            <label for="clientRegName">é¡§å®¢å *</label>
                            <input type="text" id="clientRegName" required="">
                        </div>
                        <div class="form-col">
                            <label for="clientKana">ãƒ•ãƒªã‚¬ãƒŠ</label>
                            <input type="text" id="clientKana">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="clientPostal">éƒµä¾¿ç•ªå·</label>
                            <input type="text" id="clientPostal" placeholder="000-0000">
                        </div>
                        <div class="form-col">
                            <label for="clientAddress">ä½æ‰€</label>
                            <input type="text" id="clientAddress">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="clientPhone">é›»è©±ç•ªå·</label>
                            <input type="tel" id="clientPhone">
                        </div>
                        <div class="form-col">
                            <label for="clientEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                            <input type="email" id="clientEmail">
                        </div>
                        <div class="form-col">
                            <label for="clientContact">æ‹…å½“è€…å</label>
                            <input type="text" id="clientContact">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="clientStartDate">å–å¼•é–‹å§‹æ—¥</label>
                            <input type="date" id="clientStartDate">
                        </div>
                        <div class="form-col">
                            <label for="clientCategory">é¡§å®¢åˆ†é¡</label>
                            <select id="clientCategory">
                                <option value="å€‹äºº">å€‹äºº</option>
                                <option value="æ³•äºº">æ³•äºº</option>
                                <option value="ä¸å‹•ç”£ä¼šç¤¾">ä¸å‹•ç”£ä¼šç¤¾</option>
                                <option value="å»ºè¨­ä¼šç¤¾">å»ºè¨­ä¼šç¤¾</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="clientNotes">å‚™è€ƒ</label>
                            <textarea id="clientNotes" rows="3"></textarea>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="addClient()">âœ… é¡§å®¢ã‚’ç™»éŒ²</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>é¡§å®¢ã‚³ãƒ¼ãƒ‰</th>
                                <th>é¡§å®¢å</th>
                                <th>ãƒ•ãƒªã‚¬ãƒŠ</th>
                                <th>é›»è©±ç•ªå·</th>
                                <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                <th>ä½æ‰€</th>
                                <th>æ‹…å½“è€…</th>
                                <th>åˆ†é¡</th>
                                <th>å–å¼•é–‹å§‹æ—¥</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ä»•å…¥å…ˆå°å¸³ -->
            <div id="suppliers-sheet" class="sheet">
                <h2>ğŸ¢ ä»•å…¥å…ˆå°å¸³ç®¡ç†</h2>

                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="supplierCode">ä»•å…¥å…ˆã‚³ãƒ¼ãƒ‰</label>
                            <input type="text" id="supplierCode" placeholder="è‡ªå‹•ç”Ÿæˆ">
                        </div>
                        <div class="form-col">
                            <label for="supplierRegName">ä»•å…¥å…ˆå *</label>
                            <input type="text" id="supplierRegName" required="">
                        </div>
                        <div class="form-col">
                            <label for="supplierKana">ãƒ•ãƒªã‚¬ãƒŠ</label>
                            <input type="text" id="supplierKana">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="supplierPostal">éƒµä¾¿ç•ªå·</label>
                            <input type="text" id="supplierPostal" placeholder="000-0000">
                        </div>
                        <div class="form-col">
                            <label for="supplierAddress">ä½æ‰€</label>
                            <input type="text" id="supplierAddress">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="supplierPhone">é›»è©±ç•ªå·</label>
                            <input type="tel" id="supplierPhone">
                        </div>
                        <div class="form-col">
                            <label for="supplierEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                            <input type="email" id="supplierEmail">
                        </div>
                        <div class="form-col">
                            <label for="supplierContact">æ‹…å½“è€…å</label>
                            <input type="text" id="supplierContact">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="supplierStartDate">å–å¼•é–‹å§‹æ—¥</label>
                            <input type="date" id="supplierStartDate">
                        </div>
                        <div class="form-col">
                            <label for="supplierCategory">ä»•å…¥å…ˆåˆ†é¡</label>
                            <select id="supplierCategory">
                                <option value="ææ–™æ¥­è€…">ææ–™æ¥­è€…</option>
                                <option value="å¤–æ³¨æ¥­è€…">å¤–æ³¨æ¥­è€…</option>
                                <option value="è¨­å‚™æ¥­è€…">è¨­å‚™æ¥­è€…</option>
                                <option value="é‹é€æ¥­è€…">é‹é€æ¥­è€…</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="supplierPaymentTerms">æ”¯æ‰•æ¡ä»¶</label>
                            <input type="text" id="supplierPaymentTerms" placeholder="ä¾‹: æœˆæœ«ç· ã‚ç¿Œæœˆæœ«æ‰•ã„">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="supplierNotes">å‚™è€ƒ</label>
                            <textarea id="supplierNotes" rows="3"></textarea>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="addSupplier()">âœ… ä»•å…¥å…ˆã‚’ç™»éŒ²</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ä»•å…¥å…ˆã‚³ãƒ¼ãƒ‰</th>
                                <th>ä»•å…¥å…ˆå</th>
                                <th>ãƒ•ãƒªã‚¬ãƒŠ</th>
                                <th>é›»è©±ç•ªå·</th>
                                <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                <th>ä½æ‰€</th>
                                <th>æ‹…å½“è€…</th>
                                <th>åˆ†é¡</th>
                                <th>æ”¯æ‰•æ¡ä»¶</th>
                                <th>å–å¼•é–‹å§‹æ—¥</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="suppliersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- è²·æ›é‡‘ç®¡ç† -->
            <div id="payables-sheet" class="sheet">
                <h2>ğŸ“‹ è²·æ›é‡‘ç®¡ç†</h2>

                <div class="form-group">
                    <h3>ğŸ†• ç™ºæ³¨ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="payableDate">ç™ºæ³¨æ—¥ *</label>
                            <input type="date" id="payableDate" required="">
                        </div>
                        <div class="form-col">
                            <label for="payableSupplier">ä»•å…¥å…ˆ *</label>
                            <select id="payableSupplier" required=""><option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option></select>
                        </div>
                        <div class="form-col">
                            <label for="payableProject">é–¢é€£å·¥äº‹</label>
                            <select id="payableProject"><option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option><option value="PRJ-2025-001">ç”°ä¸­æ§˜é‚¸ã‚­ãƒƒãƒãƒ³ãƒªãƒ•ã‚©ãƒ¼ãƒ </option><option value="PRJ-2025-002">å±±ç”°å•†åº—äº‹å‹™æ‰€æ”¹è£…</option></select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="payableCategory">è²»ç›®</label>
                            <select id="payableCategory">
                                <option value="ææ–™è²»">ææ–™è²»</option>
                                <option value="å¤–æ³¨è²»">å¤–æ³¨è²»</option>
                                <option value="è¨­å‚™è²»">è¨­å‚™è²»</option>
                                <option value="é‹é€è²»">é‹é€è²»</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="payableAmount">ç™ºæ³¨é‡‘é¡ï¼ˆå††ï¼‰ *</label>
                            <input type="number" id="payableAmount" min="0" required="">
                        </div>
                        <div class="form-col">
                            <label for="payableDueDate">æ”¯æ‰•äºˆå®šæ—¥</label>
                            <input type="date" id="payableDueDate">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="payableDescription">ç™ºæ³¨å†…å®¹ *</label>
                            <textarea id="payableDescription" rows="2" required=""></textarea>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="addPayable()">âœ… ç™ºæ³¨ã‚’ç™»éŒ²</button>
                </div>

                <h3>ğŸ“‹ è²·æ›é‡‘ä¸€è¦§</h3>
                <div class="summary-grid">
                    <div class="summary-card danger">
                        <h3>ğŸ’° æœªæ‰•ã„åˆè¨ˆ</h3>
                        <div class="summary-value" id="totalUnpaidPayables">Â¥0</div>
                    </div>
                    <div class="summary-card warning">
                        <h3>ğŸ“Š ä¸€éƒ¨æ”¯æ‰•ã„</h3>
                        <div class="summary-value" id="totalPartialPayables">Â¥0</div>
                    </div>
                    <div class="summary-card success">
                        <h3>âœ… æ”¯æ‰•ã„æ¸ˆã¿</h3>
                        <div class="summary-value" id="totalPaidPayables">Â¥0</div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ç™ºæ³¨ç•ªå·</th>
                                <th>ç™ºæ³¨æ—¥</th>
                                <th>ä»•å…¥å…ˆ</th>
                                <th>é–¢é€£å·¥äº‹</th>
                                <th>è²»ç›®</th>
                                <th>ç™ºæ³¨é‡‘é¡</th>
                                <th>æ”¯æ‰•æ¸ˆé¡</th>
                                <th>æ®‹é¡</th>
                                <th>æ”¯æ‰•çŠ¶æ³</th>
                                <th>æ”¯æ‰•äºˆå®šæ—¥</th>
                                <th>ç™ºæ³¨å†…å®¹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="payablesTableBody"></tbody>
                    </table>
                </div>

                <h3>ğŸ’³ æ”¯æ‰•ã„è¨˜éŒ²</h3>
                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="payablePaymentId">ç™ºæ³¨ç•ªå· *</label>
                            <select id="payablePaymentId" required=""><option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option></select>
                        </div>
                        <div class="form-col">
                            <label for="payablePaymentDate">æ”¯æ‰•æ—¥ *</label>
                            <input type="date" id="payablePaymentDate" required="">
                        </div>
                        <div class="form-col">
                            <label for="payablePaymentAmount">æ”¯æ‰•é¡ï¼ˆå††ï¼‰ *</label>
                            <input type="number" id="payablePaymentAmount" min="0" required="">
                        </div>
                        <div class="form-col">
                            <label for="payablePaymentMethod">æ”¯æ‰•æ–¹æ³•</label>
                            <select id="payablePaymentMethod">
                                <option value="éŠ€è¡ŒæŒ¯è¾¼">éŠ€è¡ŒæŒ¯è¾¼</option>
                                <option value="ç¾é‡‘">ç¾é‡‘</option>
                                <option value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</option>
                                <option value="æ‰‹å½¢">æ‰‹å½¢</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="recordPayablePayment()">ğŸ’³ æ”¯æ‰•ã„ã‚’è¨˜éŒ²</button>
                </div>

                <h3>ğŸ“Š æ”¯æ‰•ã„å±¥æ­´</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>æ”¯æ‰•æ—¥</th>
                                <th>ç™ºæ³¨ç•ªå·</th>
                                <th>ä»•å…¥å…ˆ</th>
                                <th>é–¢é€£å·¥äº‹</th>
                                <th>æ”¯æ‰•é¡</th>
                                <th>æ”¯æ‰•æ–¹æ³•</th>
                                <th>æ®‹é¡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="payablePaymentsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- çµŒè²»ç®¡ç† -->
            <div id="expenses-sheet" class="sheet">
                <h2>ğŸ’° çµŒè²»ç®¡ç†</h2>

                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="expenseProject">é–¢é€£å·¥äº‹</label>
                            <select id="expenseProject"><option value="">å·¥äº‹ã‚’é¸æŠ</option><option value="PRJ-2025-001">ç”°ä¸­æ§˜é‚¸ã‚­ãƒƒãƒãƒ³ãƒªãƒ•ã‚©ãƒ¼ãƒ  (ç”°ä¸­å¤ªéƒ)</option><option value="PRJ-2025-002">å±±ç”°å•†åº—äº‹å‹™æ‰€æ”¹è£… (å±±ç”°å•†åº—)</option></select>
                        </div>
                        <div class="form-col">
                            <label for="expenseDate">æ”¯å‡ºæ—¥ *</label>
                            <input type="date" id="expenseDate" required="">
                        </div>
                        <div class="form-col">
                            <label for="expenseCategory">è²»ç›® *</label>
                            <select id="expenseCategory" required="">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="ææ–™è²»">ææ–™è²»</option>
                                <option value="å¤–æ³¨è²»">å¤–æ³¨è²»</option>
                                <option value="äº¤é€šè²»">äº¤é€šè²»</option>
                                <option value="å·¥å…·è³¼å…¥è²»">å·¥å…·è³¼å…¥è²»</option>
                                <option value="æ¶ˆè€—å“è²»">æ¶ˆè€—å“è²»</option>
                                <option value="é€šä¿¡è²»">é€šä¿¡è²»</option>
                                <option value="åºƒå‘Šå®£ä¼è²»">åºƒå‘Šå®£ä¼è²»</option>
                                <option value="æ¥å¾…äº¤éš›è²»">æ¥å¾…äº¤éš›è²»</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="expenseAmount">é‡‘é¡ï¼ˆå††ï¼‰ *</label>
                            <input type="number" id="expenseAmount" min="0" required="">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="expenseSupplier">å–å¼•å…ˆ</label>
                            <input type="text" id="expenseSupplier">
                        </div>
                        <div class="form-col">
                            <label for="expensePayment">æ”¯æ‰•æ–¹æ³•</label>
                            <select id="expensePayment">
                                <option value="ç¾é‡‘">ç¾é‡‘</option>
                                <option value="éŠ€è¡ŒæŒ¯è¾¼">éŠ€è¡ŒæŒ¯è¾¼</option>
                                <option value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</option>
                                <option value="å°åˆ‡æ‰‹">å°åˆ‡æ‰‹</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="expenseReceipt">é ˜åæ›¸ç•ªå·</label>
                            <input type="text" id="expenseReceipt">
                        </div>
                        <div class="form-col">
                            <label for="taxDeductible">ç¨å‹™åŒºåˆ†</label>
                            <select id="taxDeductible">
                                <option value="èª²ç¨">èª²ç¨</option>
                                <option value="éèª²ç¨">éèª²ç¨</option>
                                <option value="ä¸èª²ç¨">ä¸èª²ç¨</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="expenseDescription">æ‘˜è¦ãƒ»è©³ç´°</label>
                        <textarea id="expenseDescription" placeholder="æ”¯å‡ºå†…å®¹ã®è©³ç´°ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="addExpense()">çµŒè²»ã‚’ç™»éŒ²</button>
                    <button class="btn btn-info" onclick="exportExpensesCSV()">CSVå‡ºåŠ›</button>
                </div>

                <div class="summary-grid">
                    <div class="summary-card primary">
                        <h3>ä»Šæœˆã®ç·çµŒè²»</h3>
                        <div class="summary-value" id="monthlyExpenses">Â¥0</div>
                        <p>å‰æœˆæ¯”è¼ƒã‚‚è¡¨ç¤ºäºˆå®š</p>
                    </div>
                    <div class="summary-card warning">
                        <h3>æœ€å¤šè²»ç›®</h3>
                        <div class="summary-value" id="topExpenseCategory">-</div>
                        <p>ä»Šæœˆã®çµŒè²»åˆ†æ</p>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>é–¢é€£å·¥äº‹</th>
                                <th>è²»ç›®</th>
                                <th>é‡‘é¡</th>
                                <th>å–å¼•å…ˆ</th>
                                <th>æ”¯æ‰•æ–¹æ³•</th>
                                <th>æ‘˜è¦</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                    <tr>
                        <td>2025-01-16</td>
                        <td>ç”°ä¸­æ§˜é‚¸ã‚­ãƒƒãƒãƒ³ãƒªãƒ•ã‚©ãƒ¼ãƒ </td>
                        <td>ææ–™è²»</td>
                        <td>Â¥450,000</td>
                        <td>ã‚¿ã‚«ãƒ©ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</td>
                        <td>éŠ€è¡ŒæŒ¯è¾¼</td>
                        <td>ã‚·ã‚¹ãƒ†ãƒ ã‚­ãƒƒãƒãƒ³æœ¬ä½“ãƒ»éƒ¨æ</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editExpense(&#39;EXP-2025-001&#39;)">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteExpense(&#39;EXP-2025-001&#39;)">å‰Šé™¤</button>
                        </td>
                    </tr>
                
                    <tr>
                        <td>2025-01-12</td>
                        <td>å±±ç”°å•†åº—äº‹å‹™æ‰€æ”¹è£…</td>
                        <td>ææ–™è²»</td>
                        <td>Â¥120,000</td>
                        <td>å†…è£…è³‡æå•†äº‹</td>
                        <td>ç¾é‡‘</td>
                        <td>å£ç´™ãƒ»åºŠæ</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editExpense(&#39;EXP-2025-002&#39;)">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteExpense(&#39;EXP-2025-002&#39;)">å‰Šé™¤</button>
                        </td>
                    </tr>
                </tbody>
                    </table>
                </div>
            </div>

            <!-- è«‹æ±‚æ›¸ç®¡ç† -->
            <div id="invoices-sheet" class="sheet">
                <h2>ğŸ“‹ è«‹æ±‚æ›¸ç®¡ç†</h2>

                <div class="form-group">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="invoiceProject">å¯¾è±¡å·¥äº‹ *</label>
                            <select id="invoiceProject" required=""><option value="">å·¥äº‹ã‚’é¸æŠ</option><option value="PRJ-2025-001">ç”°ä¸­æ§˜é‚¸ã‚­ãƒƒãƒãƒ³ãƒªãƒ•ã‚©ãƒ¼ãƒ  (ç”°ä¸­å¤ªéƒ)</option><option value="PRJ-2025-002">å±±ç”°å•†åº—äº‹å‹™æ‰€æ”¹è£… (å±±ç”°å•†åº—)</option></select>
                        </div>
                        <div class="form-col">
                            <label for="invoiceDate">è«‹æ±‚æ›¸ç™ºè¡Œæ—¥ *</label>
                            <input type="date" id="invoiceDate" required="">
                        </div>
                        <div class="form-col">
                            <label for="invoiceDueDate">å…¥é‡‘äºˆå®šæ—¥</label>
                            <input type="date" id="invoiceDueDate">
                        </div>
                        <div class="form-col">
                            <label for="invoiceAmount">è«‹æ±‚é‡‘é¡ï¼ˆå††ï¼‰ *</label>
                            <input type="number" id="invoiceAmount" min="0" required="">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="invoiceNumber">è«‹æ±‚æ›¸ç•ªå·</label>
                            <input type="text" id="invoiceNumber" placeholder="è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™">
                        </div>
                        <div class="form-col">
                            <label for="taxAmount">æ¶ˆè²»ç¨é¡ï¼ˆå††ï¼‰</label>
                            <input type="number" id="taxAmount" min="0">
                        </div>
                        <div class="form-col">
                            <label for="invoiceStatus">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                            <select id="invoiceStatus">
                                <option value="ä¸‹æ›¸ã">ä¸‹æ›¸ã</option>
                                <option value="ç™ºè¡Œæ¸ˆ">ç™ºè¡Œæ¸ˆ</option>
                                <option value="é€ä»˜æ¸ˆ">é€ä»˜æ¸ˆ</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="paymentTerms">æ”¯æ‰•æ¡ä»¶</label>
                            <select id="paymentTerms">
                                <option value="æœˆæœ«ç· ç¿Œæœˆæœ«æ‰•">æœˆæœ«ç· ç¿Œæœˆæœ«æ‰•</option>
                                <option value="å½“æœˆæœ«æ‰•">å½“æœˆæœ«æ‰•</option>
                                <option value="ç¿Œæœˆ20æ—¥æ‰•">ç¿Œæœˆ20æ—¥æ‰•</option>
                                <option value="ç¾é‡‘">ç¾é‡‘</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="invoiceNotes">è«‹æ±‚æ›¸å‚™è€ƒ</label>
                        <textarea id="invoiceNotes" placeholder="è«‹æ±‚æ›¸ã«è¨˜è¼‰ã™ã‚‹ç‰¹è¨˜äº‹é …"></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="addInvoice()">è«‹æ±‚æ›¸ã‚’ç™ºè¡Œ</button>
                    <button class="btn btn-info" onclick="exportInvoicesCSV()">CSVå‡ºåŠ›</button>
                </div>

                <div class="summary-grid">
                    <div class="summary-card success">
                        <h3>ä»Šæœˆã®è«‹æ±‚é¡</h3>
                        <div class="summary-value" id="monthlyInvoices">Â¥0</div>
                        <p>ç™ºè¡Œæ¸ˆã¿è«‹æ±‚æ›¸ã®åˆè¨ˆ</p>
                    </div>
                    <div class="summary-card warning">
                        <h3>æœªå›åè«‹æ±‚é¡</h3>
                        <div class="summary-value" id="unpaidInvoices">Â¥480,000</div>
                        <p>æœªå…¥é‡‘ãƒ»ä¸€éƒ¨å…¥é‡‘ã®åˆè¨ˆ</p>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>è«‹æ±‚æ›¸ç•ªå·</th>
                                <th>å·¥äº‹å</th>
                                <th>é¡§å®¢å</th>
                                <th>ç™ºè¡Œæ—¥</th>
                                <th>è«‹æ±‚é¡</th>
                                <th>å…¥é‡‘çŠ¶æ³</th>
                                <th>å…¥é‡‘é¡/è«‹æ±‚é¡</th>
                                <th>å…¥é‡‘äºˆå®šæ—¥</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                    <tr class="aging-30">
                        <td>INV-2025-001</td>
                        <td>å±±ç”°å•†åº—äº‹å‹™æ‰€æ”¹è£…</td>
                        <td>å±±ç”°å•†åº—</td>
                        <td>2025-01-26</td>
                        <td>Â¥880,000</td>
                        <td><span class="status status-partial">ä¸€éƒ¨å…¥é‡‘</span></td>
                        <td>Â¥400,000 / Â¥880,000</td>
                        <td>2025-02-26 âš ï¸</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="registerPayment(&#39;SEI-2025-001&#39;)">å…¥é‡‘ç™»éŒ²</button>
                            <button class="btn btn-warning btn-sm" onclick="editInvoice(&#39;SEI-2025-001&#39;)">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteInvoice(&#39;SEI-2025-001&#39;)">å‰Šé™¤</button>
                        </td>
                    </tr>
                </tbody>
                    </table>
                </div>
            </div>

            <!-- å…¥é‡‘è¨˜éŒ² -->
            <div id="payments-sheet" class="sheet">
                <h2>ğŸ’³ å…¥é‡‘è¨˜éŒ²ãƒ»ç®¡ç†</h2>

                <div class="payment-form">
                    <h3>ğŸ”¹ å…¥é‡‘ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="paymentInvoice">è«‹æ±‚æ›¸ç•ªå· *</label>
                            <select id="paymentInvoice" required=""><option value="">æœªå…¥é‡‘ãƒ»ä¸€éƒ¨å…¥é‡‘ã®è«‹æ±‚æ›¸ã‚’é¸æŠ</option>
                        <option value="SEI-2025-001">
                            INV-2025-001 - å±±ç”°å•†åº—äº‹å‹™æ‰€æ”¹è£… (å±±ç”°å•†åº—) - æ®‹é¡:Â¥480,000
                        </option>
                    </select>
                        </div>
                        <div class="form-col">
                            <label for="paymentDate">å…¥é‡‘æ—¥ *</label>
                            <input type="date" id="paymentDate" required="">
                        </div>
                        <div class="form-col">
                            <label for="paymentAmount">å…¥é‡‘é¡ï¼ˆå††ï¼‰ *</label>
                            <input type="number" id="paymentAmount" min="1" required="">
                        </div>
                        <div class="form-col">
                            <label for="paymentMethod">å…¥é‡‘æ–¹æ³•</label>
                            <select id="paymentMethod">
                                <option value="æŒ¯è¾¼">æŒ¯è¾¼</option>
                                <option value="ç¾é‡‘">ç¾é‡‘</option>
                                <option value="æ‰‹å½¢">æ‰‹å½¢</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label for="paymentPayer">æŒ¯è¾¼åç¾©äººï¼ˆç•°ãªã‚‹å ´åˆï¼‰</label>
                            <input type="text" id="paymentPayer" placeholder="é¡§å®¢åã¨ç•°ãªã‚‹å ´åˆã®ã¿å…¥åŠ›">
                        </div>
                        <div class="form-col">
                            <label for="paymentMemo">ãƒ¡ãƒ¢æ¬„</label>
                            <textarea id="paymentMemo" placeholder="å…¥é‡‘ã«é–¢ã™ã‚‹ç‰¹è¨˜äº‹é …"></textarea>
                        </div>
                    </div>

                    <button class="btn btn-success" onclick="addPayment()">ğŸ’° å…¥é‡‘ã‚’ç™»éŒ²</button>
                </div>

                <div class="summary-grid">
                    <div class="summary-card success">
                        <h3>ä»Šæœˆã®å…¥é‡‘é¡</h3>
                        <div class="summary-value" id="monthlyPayments">Â¥0</div>
                        <p>å½“æœˆå…¥é‡‘å®Ÿç¸¾</p>
                    </div>
                    <div class="summary-card danger">
                        <h3>æœªå›åé‡‘é¡</h3>
                        <div class="summary-value" id="totalReceivables">Â¥480,000</div>
                        <p>å…¨è«‹æ±‚æ›¸ã®æœªå›ååˆ†</p>
                    </div>
                    <div class="summary-card primary">
                        <h3>å…¥é‡‘äºˆå®šé¡ï¼ˆä»Šæœˆï¼‰</h3>
                        <div class="summary-value" id="expectedPayments">Â¥0</div>
                        <p>ä»Šæœˆå…¥é‡‘äºˆå®šã®é‡‘é¡</p>
                    </div>
                </div>

                <h3>ğŸ“‹ å…¥é‡‘å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>å…¥é‡‘æ—¥</th>
                                <th>è«‹æ±‚æ›¸ç•ªå·</th>
                                <th>å·¥äº‹å</th>
                                <th>é¡§å®¢å</th>
                                <th>å…¥é‡‘é¡</th>
                                <th>å…¥é‡‘æ–¹æ³•</th>
                                <th>æ®‹é¡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsTableBody">
                    <tr>
                        <td>2025-02-20</td>
                        <td>INV-2025-001</td>
                        <td>å±±ç”°å•†åº—äº‹å‹™æ‰€æ”¹è£…</td>
                        <td>å±±ç”°å•†åº—</td>
                        <td>Â¥400,000</td>
                        <td>æŒ¯è¾¼</td>
                        <td>Â¥480,000</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editPayment(&#39;PAY-2025-001&#39;)">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deletePayment(&#39;PAY-2025-001&#39;)">å‰Šé™¤</button>
                        </td>
                    </tr>
                </tbody>
                    </table>
                </div>
            </div>
            <!-- å£²æ›é‡‘ç®¡ç† -->
            <div id="receivables-sheet" class="sheet">
                <h2>ğŸ“Š å£²æ›é‡‘ç®¡ç†</h2>

                <div class="summary-grid">
                    <div class="summary-card danger">
                        <h3>ç·å£²æ›é‡‘æ®‹é«˜</h3>
                        <div class="summary-value" id="totalReceivablesAmount">Â¥480,000</div>
                        <p>å…¨æœªå›åé‡‘é¡ã®åˆè¨ˆ</p>
                    </div>
                    <div class="summary-card warning">
                        <h3>30æ—¥ä»¥ä¸ŠçµŒé</h3>
                        <div class="summary-value" id="overdue30">Â¥480,000</div>
                        <p>å›åè¦æ³¨æ„æ¡ˆä»¶</p>
                    </div>
                </div>

                <h3>ğŸ“‹ æœªå›åè«‹æ±‚æ›¸ä¸€è¦§</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>è«‹æ±‚æ›¸ç•ªå·</th>
                                <th>ç™ºè¡Œæ—¥</th>
                                <th>é¡§å®¢å</th>
                                <th>è«‹æ±‚é¡</th>
                                <th>å…¥é‡‘é¡</th>
                                <th>æ®‹é¡</th>
                                <th>å…¥é‡‘äºˆå®šæ—¥</th>
                                <th>çµŒéæ—¥æ•°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="receivablesTableBody">
                    <tr class="aging-30">
                        <td>INV-2025-001</td>
                        <td>2025-01-26</td>
                        <td>å±±ç”°å•†åº—</td>
                        <td>Â¥880,000</td>
                        <td>Â¥400,000</td>
                        <td>Â¥480,000</td>
                        <td>2025-02-26</td>
                        <td>302æ—¥</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="registerPayment(&#39;SEI-2025-001&#39;)">å…¥é‡‘ç™»éŒ²</button>
                        </td>
                    </tr>
                </tbody>
                    </table>
                </div>

                <h3>ğŸ‘¥ é¡§å®¢åˆ¥å£²æ›é‡‘ã‚µãƒãƒªãƒ¼</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>é¡§å®¢å</th>
                                <th>æœªå›åä»¶æ•°</th>
                                <th>æœªå›åé‡‘é¡</th>
                                <th>æœ€å¤è«‹æ±‚æ—¥</th>
                                <th>é€£çµ¡çŠ¶æ³</th>
                            </tr>
                        </thead>
                        <tbody id="customerReceivablesBody">
                    <tr>
                        <td>å±±ç”°å•†åº—</td>
                        <td>1ä»¶</td>
                        <td>Â¥480,000</td>
                        <td>2025-01-26</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="contactCustomer(&#39;å±±ç”°å•†åº—&#39;)">é€£çµ¡</button>
                        </td>
                    </tr>
                </tbody>
                    </table>
                </div>

                <h3>ğŸ“… å…¥é‡‘äºˆå®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3>
                <div class="alert alert-info">
                    <strong>ä»Šé€±ã®å…¥é‡‘äºˆå®šï¼š</strong> <span id="thisWeekExpected">Â¥480,000</span><br>
                    <strong>æ¥é€±ã®å…¥é‡‘äºˆå®šï¼š</strong> <span id="nextWeekExpected">Â¥0</span><br>
                    <strong>ä»Šæœˆã®å…¥é‡‘äºˆå®šï¼š</strong> <span id="thisMonthExpected">Â¥480,000</span>
                </div>
            </div>

            <!-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ†æ -->
            <div id="cashflow-sheet" class="sheet">
                <h2>ğŸ’¹ æœˆæ¬¡ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ†æ</h2>

                <div class="summary-grid">
                    <div class="summary-card success">
                        <h3>ä»Šæœˆã®å£²ä¸Šï¼ˆè«‹æ±‚é¡ï¼‰</h3>
                        <div class="summary-value" id="monthlySales">Â¥0</div>
                        <p>è«‹æ±‚æ›¸ãƒ™ãƒ¼ã‚¹ã®å£²ä¸Š</p>
                    </div>
                    <div class="summary-card primary">
                        <h3>ä»Šæœˆã®å…¥é‡‘é¡</h3>
                        <div class="summary-value" id="monthlyReceipts">Â¥0</div>
                        <p>å®Ÿéš›ã®å…¥é‡‘ãƒ™ãƒ¼ã‚¹</p>
                    </div>
                    <div class="summary-card warning">
                        <h3>å…¥é‡‘ç‡</h3>
                        <div class="summary-value" id="paymentRate">0%</div>
                        <p>å£²ä¸Šã«å¯¾ã™ã‚‹å…¥é‡‘å‰²åˆ</p>
                    </div>
                    <div class="summary-card danger">
                        <h3>æœªå›åé‡‘é¡</h3>
                        <div class="summary-value" id="outstandingAmount">Â¥0</div>
                        <p>å›åå¾…ã¡ã®ç·é¡</p>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="cashflowChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>å…¥é‡‘äºˆå®š vs å®Ÿç¸¾ã®æ¯”è¼ƒ</h3>
                    <canvas id="forecastChart"></canvas>
                </div>
            </div>

            <!-- æœˆæ¬¡æç›Šè¨ˆç®—æ›¸ -->
            <div id="monthly-sheet" class="sheet">
                <h2>ğŸ“ˆ æœˆæ¬¡æç›Šè¨ˆç®—æ›¸</h2>

                <div class="form-row">
                    <div class="form-col">
                        <label for="monthlyYear">å¹´</label>
                        <select id="monthlyYear">
                            <option value="2025">2025å¹´</option>
                            <option value="2024">2024å¹´</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label for="monthlyMonth">æœˆ</label>
                        <select id="monthlyMonth">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <button class="btn btn-primary" onclick="generateMonthlyReport()">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
                        <button class="btn btn-info" onclick="exportMonthlyCSV()">CSVå‡ºåŠ›</button>
                    </div>
                </div>

                <div id="monthlyReport">
                    <h3>ğŸ“Š ç™ºç”Ÿä¸»ç¾©æç›Š vs ç¾é‡‘ä¸»ç¾©æç›Š</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>é …ç›®</th>
                                    <th>ç™ºç”Ÿä¸»ç¾©ï¼ˆè«‹æ±‚ãƒ™ãƒ¼ã‚¹ï¼‰</th>
                                    <th>ç¾é‡‘ä¸»ç¾©ï¼ˆå…¥é‡‘ãƒ™ãƒ¼ã‚¹ï¼‰</th>
                                    <th>å·®é¡</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyReportBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- å¹´æ¬¡åˆ†æ -->
            <div id="yearly-sheet" class="sheet">
                <h2>ğŸ“… å¹´æ¬¡åˆ†æ</h2>

                <div class="form-row">
                    <div class="form-col">
                        <label for="yearlyAnalysisYear">åˆ†æå¹´åº¦</label>
                        <select id="yearlyAnalysisYear">
                            <option value="2025">2025å¹´</option>
                            <option value="2024">2024å¹´</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <button class="btn btn-primary" onclick="generateYearlyReport()">å¹´æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="yearlyChart"></canvas>
                </div>

                <div id="yearlyReport">
                    <div class="summary-grid">
                        <div class="summary-card primary">
                            <h3>å¹´é–“å£²ä¸Šé«˜</h3>
                            <div class="summary-value" id="yearlySales">Â¥0</div>
                            <p>è«‹æ±‚æ›¸ãƒ™ãƒ¼ã‚¹</p>
                        </div>
                        <div class="summary-card success">
                            <h3>å¹´é–“çµŒè²»</h3>
                            <div class="summary-value" id="yearlyExpenses">Â¥0</div>
                            <p>æ”¯å‡ºãƒ™ãƒ¼ã‚¹</p>
                        </div>
                        <div class="summary-card warning">
                            <h3>å¹´é–“åˆ©ç›Š</h3>
                            <div class="summary-value" id="yearlyProfit">Â¥0</div>
                            <p>å£²ä¸Š - çµŒè²»</p>
                        </div>
                        <div class="summary-card danger">
                            <h3>åˆ©ç›Šç‡</h3>
                            <div class="summary-value" id="yearlyMargin">0%</div>
                            <p>åˆ©ç›Š Ã· å£²ä¸Š</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¨å‹™è³‡æ–™ -->
            <div id="tax-sheet" class="sheet">
                <h2>ğŸ§¾ ç¨å‹™è³‡æ–™ä½œæˆ</h2>

                <div class="alert alert-info">
                    <strong>ğŸ“‹ ç¨ç†å£«æå‡ºç”¨è³‡æ–™ã®æº–å‚™</strong><br>
                    ç¢ºå®šç”³å‘Šã‚„ç¨å‹™èª¿æŸ»ã«å¿…è¦ãªè³‡æ–™ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label for="taxYear">å¯¾è±¡å¹´åº¦</label>
                        <select id="taxYear">
                            <option value="2025">2025å¹´</option>
                            <option value="2024">2024å¹´</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <button class="btn btn-success" onclick="generateTaxReports()">ğŸ“Š ç¨å‹™è³‡æ–™ä¸€æ‹¬ç”Ÿæˆ</button>
                    </div>
                </div>

                <div class="summary-grid">
                    <div class="summary-card primary">
                        <h3>å£²ä¸Šå°å¸³</h3>
                        <div class="summary-value">ğŸ“‹</div>
                        <button class="btn btn-info" onclick="exportSalesLedger()">å£²ä¸Šå°å¸³CSV</button>
                    </div>
                    <div class="summary-card success">
                        <h3>çµŒè²»å°å¸³</h3>
                        <div class="summary-value">ğŸ’°</div>
                        <button class="btn btn-info" onclick="exportExpenseLedger()">çµŒè²»å°å¸³CSV</button>
                    </div>
                    <div class="summary-card warning">
                        <h3>å…¥é‡‘ç®¡ç†å°å¸³</h3>
                        <div class="summary-value">ğŸ’³</div>
                        <button class="btn btn-info" onclick="exportPaymentLedger()">å…¥é‡‘å°å¸³CSV</button>
                    </div>
                    <div class="summary-card danger">
                        <h3>å¹´é–“æç›Šè¨ˆç®—æ›¸</h3>
                        <div class="summary-value">ğŸ“ˆ</div>
                        <button class="btn btn-info" onclick="exportProfitLoss()">æç›Šè¨ˆç®—æ›¸CSV</button>
                    </div>
                </div>

                <div id="taxDocuments">
                    <h3>ğŸ“„ ç”Ÿæˆã•ã‚ŒãŸç¨å‹™æ›¸é¡</h3>
                    <div id="taxDocumentsList">
                        <p>ç¨å‹™è³‡æ–™ã‚’ç”Ÿæˆã™ã‚‹ã¨ã€ã“ã“ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                </div>
            </div>

            <!-- ä½¿ã„æ–¹ãƒãƒ‹ãƒ¥ã‚¢ãƒ« -->
            <div id="manual-sheet" class="sheet">
                <h2>ğŸ“– ã‚¨ãƒ ã‚ºã‚¤ãƒ³ãƒ†ãƒªã‚¢çµŒç†ã‚·ã‚¹ãƒ†ãƒ  ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h2>

                <div class="alert alert-success">
                    <strong>ğŸ‰ ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦</strong><br>
                    å·¥äº‹ç®¡ç†ã‹ã‚‰å…¥é‡‘ç®¡ç†ã¾ã§ã€å»ºè¨­æ¥­ã®çµŒç†æ¥­å‹™ã‚’ä¸€å…ƒç®¡ç†ã§ãã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚
                </div>

                <h3>ğŸš€ åŸºæœ¬çš„ãªä½¿ã„æ–¹ã®æµã‚Œ</h3>

                <div class="summary-grid">
                    <div class="summary-card primary">
                        <h3>1. ğŸ—ï¸ å·¥äº‹å°å¸³</h3>
                        <p><strong>æ–°è¦å·¥äº‹ã®ç™»éŒ²</strong></p>
                        <ul>
                            <li>å·¥äº‹åã€é¡§å®¢åã‚’å…¥åŠ›</li>
                            <li>å¥‘ç´„é‡‘é¡ã¨å·¥æœŸã‚’è¨­å®š</li>
                            <li>æ‹…å½“è€…ã¨å ´æ‰€ã‚’è¨˜éŒ²</li>
                        </ul>
                    </div>

                    <div class="summary-card info">
                        <h3>2. ğŸ‘¥ é¡§å®¢å°å¸³</h3>
                        <p><strong>NEW! é¡§å®¢æƒ…å ±ã®ç®¡ç†</strong></p>
                        <ul>
                            <li>é¡§å®¢ã®åŸºæœ¬æƒ…å ±ã‚’ç™»éŒ²</li>
                            <li>é€£çµ¡å…ˆãƒ»ä½æ‰€ã‚’ä¸€å…ƒç®¡ç†</li>
                            <li>é¡§å®¢åˆ†é¡ã§æ•´ç†</li>
                        </ul>
                    </div>

                    <div class="summary-card info">
                        <h3>3. ğŸ¢ ä»•å…¥å…ˆå°å¸³</h3>
                        <p><strong>NEW! ä»•å…¥å…ˆæƒ…å ±ã®ç®¡ç†</strong></p>
                        <ul>
                            <li>ä»•å…¥å…ˆã®åŸºæœ¬æƒ…å ±ã‚’ç™»éŒ²</li>
                            <li>æ”¯æ‰•æ¡ä»¶ã‚’è¨˜éŒ²</li>
                            <li>ä»•å…¥å…ˆåˆ†é¡ã§æ•´ç†</li>
                        </ul>
                    </div>

                    <div class="summary-card success">
                        <h3>4. ğŸ’° çµŒè²»ç®¡ç†</h3>
                        <p><strong>å·¥äº‹é–¢é€£çµŒè²»ã®è¨˜éŒ²</strong></p>
                        <ul>
                            <li>ææ–™è²»ã€å¤–æ³¨è²»ç­‰ã‚’åˆ†é¡</li>
                            <li>é ˜åæ›¸ç•ªå·ã‚‚ç®¡ç†</li>
                            <li>ç¨å‹™åŒºåˆ†ã‚’æ­£ç¢ºã«è¨­å®š</li>
                        </ul>
                    </div>

                    <div class="summary-card danger">
                        <h3>5. ğŸ“‹ è²·æ›é‡‘ç®¡ç†</h3>
                        <p><strong>NEW! ç™ºæ³¨ãƒ»æ”¯æ‰•ã„ç®¡ç†</strong></p>
                        <ul>
                            <li>ä»•å…¥å…ˆã¸ã®ç™ºæ³¨ã‚’è¨˜éŒ²</li>
                            <li>æ”¯æ‰•çŠ¶æ³ã‚’ç®¡ç†</li>
                            <li>è²·æ›é‡‘ã‚’è‡ªå‹•è¨ˆç®—</li>
                        </ul>
                    </div>

                    <div class="summary-card warning">
                        <h3>6. ğŸ“‹ è«‹æ±‚æ›¸ç™ºè¡Œ</h3>
                        <p><strong>å®Œäº†å·¥äº‹ã®è«‹æ±‚å‡¦ç†</strong></p>
                        <ul>
                            <li>å·¥äº‹å®Œäº†å¾Œã«è«‹æ±‚æ›¸ä½œæˆ</li>
                            <li>å…¥é‡‘äºˆå®šæ—¥ã‚’è¨­å®š</li>
                            <li>æ¶ˆè²»ç¨ã®è‡ªå‹•è¨ˆç®—</li>
                        </ul>
                    </div>

                    <div class="summary-card success">
                        <h3>7. ğŸ’³ å…¥é‡‘ç®¡ç†</h3>
                        <p><strong>å…¥é‡‘ç¢ºèªæ©Ÿèƒ½</strong></p>
                        <ul>
                            <li>è«‹æ±‚æ›¸ã¨å…¥é‡‘ã‚’ç´ä»˜ã‘</li>
                            <li>éƒ¨åˆ†å…¥é‡‘ã«ã‚‚å¯¾å¿œ</li>
                            <li>å£²æ›é‡‘ã‚’è‡ªå‹•è¨ˆç®—</li>
                        </ul>
                    </div>
                </div>


                <h3>ğŸ†• æ–°æ©Ÿèƒ½ã®è©³ç´°</h3>

                <div style="margin: 20px 0;">
                    <h4>ğŸ‘¥ é¡§å®¢å°å¸³</h4>
                    <ul>
                        <li>é¡§å®¢ã‚³ãƒ¼ãƒ‰ã€é¡§å®¢åã€ãƒ•ãƒªã‚¬ãƒŠã®ç®¡ç†</li>
                        <li>éƒµä¾¿ç•ªå·ã€ä½æ‰€ã€é›»è©±ç•ªå·ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®è¨˜éŒ²</li>
                        <li>æ‹…å½“è€…åã¨å–å¼•é–‹å§‹æ—¥ã®ç®¡ç†</li>
                        <li>é¡§å®¢åˆ†é¡ï¼ˆå€‹äººã€æ³•äººã€ä¸å‹•ç”£ä¼šç¤¾ã€å»ºè¨­ä¼šç¤¾ãªã©ï¼‰</li>
                        <li>å‚™è€ƒæ¬„ã§ãƒ¡ãƒ¢ç®¡ç†</li>
                    </ul>
                </div>

                <div style="margin: 20px 0;">
                    <h4>ğŸ¢ ä»•å…¥å…ˆå°å¸³</h4>
                    <ul>
                        <li>ä»•å…¥å…ˆã‚³ãƒ¼ãƒ‰ã€ä»•å…¥å…ˆåã€ãƒ•ãƒªã‚¬ãƒŠã®ç®¡ç†</li>
                        <li>éƒµä¾¿ç•ªå·ã€ä½æ‰€ã€é›»è©±ç•ªå·ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®è¨˜éŒ²</li>
                        <li>æ‹…å½“è€…åã¨å–å¼•é–‹å§‹æ—¥ã®ç®¡ç†</li>
                        <li>ä»•å…¥å…ˆåˆ†é¡ï¼ˆææ–™æ¥­è€…ã€å¤–æ³¨æ¥­è€…ã€è¨­å‚™æ¥­è€…ãªã©ï¼‰</li>
                        <li>æ”¯æ‰•æ¡ä»¶ã®è¨˜éŒ²ï¼ˆä¾‹: æœˆæœ«ç· ã‚ç¿Œæœˆæœ«æ‰•ã„ï¼‰</li>
                        <li>å‚™è€ƒæ¬„ã§ãƒ¡ãƒ¢ç®¡ç†</li>
                    </ul>
                </div>

                <div style="margin: 20px 0;">
                    <h4>ğŸ“‹ è²·æ›é‡‘ç®¡ç†</h4>
                    <ul>
                        <li>ç™ºæ³¨æ—¥ã€ä»•å…¥å…ˆã€é–¢é€£å·¥äº‹ã®è¨˜éŒ²</li>
                        <li>è²»ç›®ï¼ˆææ–™è²»ã€å¤–æ³¨è²»ã€è¨­å‚™è²»ãªã©ï¼‰ã¨ç™ºæ³¨é‡‘é¡ã®ç®¡ç†</li>
                        <li>æ”¯æ‰•äºˆå®šæ—¥ã®è¨­å®š</li>
                        <li>æ”¯æ‰•ã„è¨˜éŒ²ï¼ˆæ”¯æ‰•æ—¥ã€æ”¯æ‰•é¡ã€æ”¯æ‰•æ–¹æ³•ï¼‰</li>
                        <li>éƒ¨åˆ†æ”¯æ‰•ã„ã«ã‚‚å¯¾å¿œ</li>
                        <li>è²·æ›é‡‘ã®è‡ªå‹•è¨ˆç®—ï¼ˆç™ºæ³¨é‡‘é¡ - æ”¯æ‰•æ¸ˆé¡ï¼‰</li>
                        <li>æ”¯æ‰•çŠ¶æ³ã®è‡ªå‹•æ›´æ–°ï¼ˆæœªæ‰•ã„ã€ä¸€éƒ¨æ”¯æ‰•ã„ã€æ”¯æ‰•æ¸ˆï¼‰</li>
                        <li>æ”¯æ‰•ã„å±¥æ­´ã®ä¸€è¦§è¡¨ç¤º</li>
                    </ul>
                </div>

                <h3>ğŸ“Š æ–°æ©Ÿèƒ½ï¼šå…¥é‡‘ç®¡ç†ã®è©³ç´°</h3>
                <div class="alert alert-warning">
                    <strong>ğŸ’¡ å…¥é‡‘ç®¡ç†æ©Ÿèƒ½ã®ãƒã‚¤ãƒ³ãƒˆ</strong>
                    <ul>
                        <li><strong>è‡ªå‹•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼š</strong> å…¥é‡‘ç™»éŒ²ã§è«‹æ±‚æ›¸çŠ¶æ³ãŒè‡ªå‹•æ›´æ–°</li>
                        <li><strong>éƒ¨åˆ†å…¥é‡‘å¯¾å¿œï¼š</strong> è¤‡æ•°å›ã«åˆ†ã‘ãŸå…¥é‡‘ã‚‚æ­£ç¢ºã«ç®¡ç†</li>
                        <li><strong>å£²æ›é‡‘ç®¡ç†ï¼š</strong> æœªå›åé‡‘é¡ã‚’è‡ªå‹•è¨ˆç®—ãƒ»è¡¨ç¤º</li>
                        <li><strong>å…¥é‡‘é…å»¶ã‚¢ãƒ©ãƒ¼ãƒˆï¼š</strong> å…¥é‡‘äºˆå®šæ—¥ã‚’éããŸæ¡ˆä»¶ã‚’å¼·èª¿è¡¨ç¤º</li>
                        <li><strong>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ†æï¼š</strong> å£²ä¸Šã¨å…¥é‡‘ã®å·®ã‚’å¯è¦–åŒ–</li>
                    </ul>
                </div>

                <h3>ğŸ” å„ã‚¿ãƒ–ã®æ©Ÿèƒ½è©³ç´°</h3>

                <div style="margin: 20px 0;">
                    <h4>ğŸ“Š å£²æ›é‡‘ç®¡ç†ã‚¿ãƒ–</h4>
                    <ul>
                        <li>æœªå›åè«‹æ±‚æ›¸ã‚’ä¸€è¦§è¡¨ç¤º</li>
                        <li>çµŒéæ—¥æ•°ã«ã‚ˆã‚‹è‰²åˆ†ã‘ï¼ˆ30æ—¥ä»¥ä¸Š=èµ¤ã€15-29æ—¥=é»„ã€14æ—¥ä»¥å†…=ç·‘ï¼‰</li>
                        <li>é¡§å®¢åˆ¥ã®å£²æ›é‡‘ã‚µãƒãƒªãƒ¼</li>
                        <li>å…¥é‡‘äºˆå®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½</li>
                    </ul>
                </div>

                <div style="margin: 20px 0;">
                    <h4>ğŸ’¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã‚¿ãƒ–</h4>
                    <ul>
                        <li>æœˆåˆ¥å…¥é‡‘å®Ÿç¸¾ã‚’ã‚°ãƒ©ãƒ•è¡¨ç¤º</li>
                        <li>å…¥é‡‘äºˆå®š vs å®Ÿç¸¾ã®æ¯”è¼ƒåˆ†æ</li>
                        <li>å£²ä¸Šï¼ˆè«‹æ±‚ãƒ™ãƒ¼ã‚¹ï¼‰ã¨å…¥é‡‘ï¼ˆç¾é‡‘ãƒ™ãƒ¼ã‚¹ï¼‰ã®å·®ç•°åˆ†æ</li>
                    </ul>
                </div>

                <div style="margin: 20px 0;">
                    <h4>ğŸ“ˆ æœˆæ¬¡æç›Šè¨ˆç®—æ›¸ã®æ”¹è‰¯</h4>
                    <ul>
                        <li>ç™ºç”Ÿä¸»ç¾©ï¼ˆè«‹æ±‚ãƒ™ãƒ¼ã‚¹ï¼‰ã®æç›Š</li>
                        <li>ç¾é‡‘ä¸»ç¾©ï¼ˆå…¥é‡‘ãƒ™ãƒ¼ã‚¹ï¼‰ã®æç›Š</li>
                        <li>ä¸¡è€…ã®å·®é¡åˆ†æã§è³‡é‡‘ç¹°ã‚ŠçŠ¶æ³ã‚’æŠŠæ¡</li>
                    </ul>
                </div>

                <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«ã¤ã„ã¦</h3>
                <div class="alert alert-info">
                    <ul>
                        <li><strong>è‡ªå‹•ä¿å­˜ï¼š</strong> å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™</li>
                        <li><strong>ãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼š</strong> CSVå‡ºåŠ›æ©Ÿèƒ½ã§ä»–ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚‚å¯èƒ½</li>
                        <li><strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼š</strong> å®šæœŸçš„ãªCSVå‡ºåŠ›ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ¨å¥¨</li>
                    </ul>
                </div>

                <h3>ğŸ“± ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ</h3>
                <p>iPhoneãƒ»iPadç­‰ã®ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã‚‚ä½¿ã„ã‚„ã™ã„ã‚ˆã†æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚ç¾å ´ã§ã®çµŒè²»å…¥åŠ›ã‚„å…¥é‡‘ç¢ºèªã‚‚ç°¡å˜ã«è¡Œãˆã¾ã™ã€‚</p>

                <div class="alert alert-success">
                    <strong>ğŸ¯ ãŠã™ã™ã‚é‹ç”¨ãƒ•ãƒ­ãƒ¼</strong><br>
                    <ol>
                        <li>å·¥äº‹å—æ³¨æ™‚ã«ã€Œå·¥äº‹å°å¸³ã€ã§ç™»éŒ²</li>
                        <li>ææ–™è³¼å…¥ç­‰ã®éƒ½åº¦ã€ŒçµŒè²»ç®¡ç†ã€ã§è¨˜éŒ²</li>
                        <li>å·¥äº‹å®Œäº†æ™‚ã«ã€Œè«‹æ±‚æ›¸ç®¡ç†ã€ã§è«‹æ±‚æ›¸ç™ºè¡Œ</li>
                        <li>å…¥é‡‘ç¢ºèªæ™‚ã«ã€Œå…¥é‡‘è¨˜éŒ²ã€ã§å…¥é‡‘ç™»éŒ²</li>
                        <li>æœˆæœ«ã«ã€Œå£²æ›é‡‘ç®¡ç†ã€ã§æœªå›åã‚’ãƒã‚§ãƒƒã‚¯</li>
                        <li>å››åŠæœŸã”ã¨ã«ã€Œç¨å‹™è³‡æ–™ã€ã§CSVå‡ºåŠ›ã—ç¨ç†å£«ã«æå‡º</li>
                    </ol>
                </div>
            </div>
        </div>
    <script>
        // Global Data Storage
        let projects = JSON.parse(localStorage.getItem('msinterior_projects') || '[]');
        let clients = JSON.parse(localStorage.getItem('msinterior_clients') || '[]');
        let suppliers = JSON.parse(localStorage.getItem('msinterior_suppliers') || '[]');
        let expenses = JSON.parse(localStorage.getItem('msinterior_expenses') || '[]');
        let payables = JSON.parse(localStorage.getItem('msinterior_payables') || '[]');
        let invoices = JSON.parse(localStorage.getItem('msinterior_invoices') || '[]');
        let payments = JSON.parse(localStorage.getItem('msinterior_payments') || '[]');

        // Initialize system on load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        function initializeSystem() {
            // Set current date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('projectDate').value = today;
            document.getElementById('expenseDate').value = today;
            document.getElementById('invoiceDate').value = today;
            document.getElementById('paymentDate').value = today;

            // Set current month in monthly report
            const currentDate = new Date();
            document.getElementById('monthlyMonth').value = currentDate.getMonth() + 1;
            document.getElementById('monthlyYear').value = currentDate.getFullYear();
            document.getElementById('yearlyAnalysisYear').value = currentDate.getFullYear();
            document.getElementById('taxYear').value = currentDate.getFullYear();

            // Load sample data if no data exists
            if (projects.length === 0) {
                loadSampleData();
            }

            // Refresh all displays
            refreshAllDisplays();
        }

        function loadSampleData() {
            const sampleProjects = [
                {
                    id: 'PRJ-2025-001',
                    name: 'ç”°ä¸­æ§˜é‚¸ã‚­ãƒƒãƒãƒ³ãƒªãƒ•ã‚©ãƒ¼ãƒ ',
                    client: 'ç”°ä¸­å¤ªéƒ',
                    startDate: '2025-01-15',
                    completionDate: '2025-02-15',
                    contractAmount: 1200000,
                    status: 'é€²è¡Œä¸­',
                    location: 'æ±äº¬éƒ½å“å·åŒº',
                    manager: 'ä½è—¤',
                    notes: 'ã‚·ã‚¹ãƒ†ãƒ ã‚­ãƒƒãƒãƒ³äº¤æ›ãƒ»å†…è£…å·¥äº‹',
                    timestamp: new Date().toISOString()
                },
                {
                    id: 'PRJ-2025-002',
                    name: 'å±±ç”°å•†åº—äº‹å‹™æ‰€æ”¹è£…',
                    client: 'å±±ç”°å•†åº—',
                    startDate: '2025-01-10',
                    completionDate: '2025-01-25',
                    contractAmount: 800000,
                    status: 'å®Œäº†',
                    location: 'æ±äº¬éƒ½æ¸‹è°·åŒº',
                    manager: 'éˆ´æœ¨',
                    notes: 'ã‚ªãƒ•ã‚£ã‚¹å†…è£…ãƒ»é›»æ°—å·¥äº‹',
                    timestamp: new Date().toISOString()
                }
            ];

            const sampleExpenses = [
                {
                    id: 'EXP-2025-001',
                    projectId: 'PRJ-2025-001',
                    date: '2025-01-16',
                    category: 'ææ–™è²»',
                    amount: 450000,
                    supplier: 'ã‚¿ã‚«ãƒ©ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰',
                    paymentMethod: 'éŠ€è¡ŒæŒ¯è¾¼',
                    receiptNumber: 'R-20250116-001',
                    taxType: 'èª²ç¨',
                    description: 'ã‚·ã‚¹ãƒ†ãƒ ã‚­ãƒƒãƒãƒ³æœ¬ä½“ãƒ»éƒ¨æ',
                    timestamp: new Date().toISOString()
                },
                {
                    id: 'EXP-2025-002',
                    projectId: 'PRJ-2025-002',
                    date: '2025-01-12',
                    category: 'ææ–™è²»',
                    amount: 120000,
                    supplier: 'å†…è£…è³‡æå•†äº‹',
                    paymentMethod: 'ç¾é‡‘',
                    receiptNumber: 'R-20250112-001',
                    taxType: 'èª²ç¨',
                    description: 'å£ç´™ãƒ»åºŠæ',
                    timestamp: new Date().toISOString()
                }
            ];

            const sampleInvoices = [
                {
                    id: 'SEI-2025-001',
                    invoiceNumber: 'INV-2025-001',
                    projectId: 'PRJ-2025-002',
                    issueDate: '2025-01-26',
                    dueDate: '2025-02-26',
                    totalAmount: 880000,
                    taxAmount: 80000,
                    status: 'ç™ºè¡Œæ¸ˆ',
                    paymentTerms: 'æœˆæœ«ç· ç¿Œæœˆæœ«æ‰•',
                    notes: 'å±±ç”°å•†åº—æ§˜äº‹å‹™æ‰€æ”¹è£…å·¥äº‹ä¸€å¼',
                    timestamp: new Date().toISOString()
                }
            ];

            const samplePayments = [
                {
                    id: 'PAY-2025-001',
                    invoiceId: 'SEI-2025-001',
                    paymentDate: '2025-02-20',
                    amount: 400000,
                    method: 'æŒ¯è¾¼',
                    payer: '',
                    memo: 'éƒ¨åˆ†å…¥é‡‘',
                    timestamp: new Date().toISOString()
                }
            ];

            projects = sampleProjects;
            expenses = sampleExpenses;
            invoices = sampleInvoices;
            payments = samplePayments;

            saveAllData();
        }

        // Data Management Functions
        function saveAllData() {
            localStorage.setItem('msinterior_projects', JSON.stringify(projects));
            localStorage.setItem('msinterior_expenses', JSON.stringify(expenses));
            localStorage.setItem('msinterior_invoices', JSON.stringify(invoices));
            localStorage.setItem('msinterior_payments', JSON.stringify(payments));
        }

        function generateId(prefix) {
            const year = new Date().getFullYear();
            const count = (prefix === 'PRJ' ? projects.length : 
                          prefix === 'EXP' ? expenses.length : 
                          prefix === 'SEI' ? invoices.length :
                          prefix === 'PAY' ? payments.length : 0) + 1;
            return `${prefix}-${year}-${String(count).padStart(3, '0')}`;
        }

        // Payment Status Calculation
        function calculatePaymentStatus(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return { status: 'æœªè«‹æ±‚', paidAmount: 0, remainingAmount: 0 };

            const relatedPayments = payments.filter(pay => pay.invoiceId === invoiceId);
            const paidAmount = relatedPayments.reduce((sum, pay) => sum + Number(pay.amount), 0);
            const invoiceAmount = Number(invoice.totalAmount);
            const remainingAmount = invoiceAmount - paidAmount;

            let status;
            if (paidAmount === 0) {
                status = 'æœªå…¥é‡‘';
            } else if (remainingAmount <= 0) {
                status = 'å…¥é‡‘æ¸ˆ';
            } else {
                status = 'ä¸€éƒ¨å…¥é‡‘';
            }

            return { status, paidAmount, remainingAmount };
        }

        // Tab Navigation
        function showSheet(sheetName) {
            // Hide all sheets
            const sheets = document.querySelectorAll('.sheet');
            sheets.forEach(sheet => sheet.classList.remove('active'));

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected sheet
            const selectedSheet = document.getElementById(sheetName + '-sheet');
            if (selectedSheet) {
                selectedSheet.classList.add('active');
            }

            // Add active class to clicked tab
            event.target.classList.add('active');

            // Refresh data for the selected sheet
            refreshSheetData(sheetName);
        }

        function refreshSheetData(sheetName) {
            switch(sheetName) {
                case 'construction':
                    displayProjects();
                    updateProjectDropdowns();
                    break;
                case 'expenses':
                    displayExpenses();
                    updateExpenseSummary();
                    break;
                case 'invoices':
                    displayInvoices();
                    updateInvoiceSummary();
                    break;
                case 'payments':
                    displayPayments();
                    updatePaymentSummary();
                    updatePaymentInvoiceDropdown();
                    break;
                case 'receivables':
                    displayReceivables();
                    updateReceivableSummary();
                    break;
                case 'cashflow':
                    updateCashflowAnalysis();
                    break;
            }
        }

        function refreshAllDisplays() {
            displayProjects();
            displayClients();
            displaySuppliers();
            displayExpenses();
            displayPayables();
            displayPayablePayments();
            displayInvoices();
            displayPayments();
            displayReceivables();
            updateAllSummaries();
            updateAllDropdowns();
        }

        function updateAllSummaries() {
            updateExpenseSummary();
            updateInvoiceSummary();
            updatePaymentSummary();
            updateReceivableSummary();
        }

        function updateAllDropdowns() {
            updateProjectDropdowns();
            updatePayableSupplierOptions();
            updatePayableProjectOptions();
            updatePayablePaymentOptions();
            updatePaymentInvoiceDropdown();
        }

        // Project Management
        function addProject() {
            const name = document.getElementById('projectName').value.trim();
            const client = document.getElementById('clientName').value.trim();

            if (!name || !client) {
                alert('å·¥äº‹åã¨é¡§å®¢åã¯å¿…é ˆé …ç›®ã§ã™ã€‚');
                return;
            }

            const project = {
                id: generateId('PRJ'),
                name: name,
                client: client,
                startDate: document.getElementById('projectDate').value,
                completionDate: document.getElementById('completionDate').value,
                contractAmount: Number(document.getElementById('contractAmount').value) || 0,
                status: document.getElementById('projectStatus').value,
                location: document.getElementById('projectLocation').value,
                manager: document.getElementById('projectManager').value,
                notes: document.getElementById('projectNotes').value,
                timestamp: new Date().toISOString()
            };

            projects.push(project);
            saveAllData();
            clearProjectForm();
            refreshAllDisplays();
            alert('å·¥äº‹ãŒæ­£å¸¸ã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸã€‚');
        }

        function clearProjectForm() {
            document.getElementById('projectName').value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('projectDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('completionDate').value = '';
            document.getElementById('contractAmount').value = '';
            document.getElementById('projectStatus').value = 'è¨ˆç”»ä¸­';
            document.getElementById('projectLocation').value = '';
            document.getElementById('projectManager').value = '';
            document.getElementById('projectNotes').value = '';
        }

        function displayProjects() {
            const tbody = document.getElementById('projectsTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            projects.forEach(project => {
                const paymentStatus = getProjectPaymentStatus(project.id);
                const row = `
                    <tr>
                        <td>${project.name}</td>
                        <td>${project.client}</td>
                        <td>Â¥${project.contractAmount.toLocaleString()}</td>
                        <td>${project.startDate || '-'}</td>
                        <td>${project.completionDate || '-'}</td>
                        <td><span class="status status-${project.status}">${project.status}</span></td>
                        <td><span class="status status-${paymentStatus.statusClass}">${paymentStatus.status}</span></td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editProject('${project.id}')">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProject('${project.id}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function getProjectPaymentStatus(projectId) {
            const projectInvoices = invoices.filter(inv => inv.projectId === projectId);
            if (projectInvoices.length === 0) {
                return { status: 'æœªè«‹æ±‚', statusClass: 'not-invoiced' };
            }

            let totalInvoiceAmount = 0;
            let totalPaidAmount = 0;

            projectInvoices.forEach(invoice => {
                totalInvoiceAmount += Number(invoice.totalAmount);
                const paymentStatus = calculatePaymentStatus(invoice.id);
                totalPaidAmount += paymentStatus.paidAmount;
            });

            if (totalPaidAmount === 0) {
                return { status: 'æœªå…¥é‡‘', statusClass: 'unpaid' };
            } else if (totalPaidAmount >= totalInvoiceAmount) {
                return { status: 'å…¥é‡‘æ¸ˆ', statusClass: 'paid' };
            } else {
                return { status: 'ä¸€éƒ¨å…¥é‡‘', statusClass: 'partial' };
            }
        }

        function updateProjectDropdowns() {
            const expenseProject = document.getElementById('expenseProject');
            const invoiceProject = document.getElementById('invoiceProject');

            if (expenseProject) {
                expenseProject.innerHTML = '<option value="">å·¥äº‹ã‚’é¸æŠ</option>';
                projects.forEach(project => {
                    expenseProject.innerHTML += `<option value="${project.id}">${project.name} (${project.client})</option>`;
                });
            }

            if (invoiceProject) {
                invoiceProject.innerHTML = '<option value="">å·¥äº‹ã‚’é¸æŠ</option>';
                projects.forEach(project => {
                    invoiceProject.innerHTML += `<option value="${project.id}">${project.name} (${project.client})</option>`;
                });
            }
        }

        // Expense Management  
        function addExpense() {
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const amount = document.getElementById('expenseAmount').value;

            if (!date || !category || !amount) {
                alert('æ”¯å‡ºæ—¥ã€è²»ç›®ã€é‡‘é¡ã¯å¿…é ˆé …ç›®ã§ã™ã€‚');
                return;
            }

            const expense = {
                id: generateId('EXP'),
                projectId: document.getElementById('expenseProject').value,
                date: date,
                category: category,
                amount: Number(amount),
                supplier: document.getElementById('expenseSupplier').value,
                paymentMethod: document.getElementById('expensePayment').value,
                receiptNumber: document.getElementById('expenseReceipt').value,
                taxType: document.getElementById('taxDeductible').value,
                description: document.getElementById('expenseDescription').value,
                timestamp: new Date().toISOString()
            };

            expenses.push(expense);
            saveAllData();
            clearExpenseForm();
            refreshAllDisplays();
            alert('çµŒè²»ãŒæ­£å¸¸ã«ç™»éŒ²ã•ã‚Œã¾ã—ãŸã€‚');
        }

        function clearExpenseForm() {
            document.getElementById('expenseProject').value = '';
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expenseCategory').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseSupplier').value = '';
            document.getElementById('expensePayment').value = 'ç¾é‡‘';
            document.getElementById('expenseReceipt').value = '';
            document.getElementById('taxDeductible').value = 'èª²ç¨';
            document.getElementById('expenseDescription').value = '';
        }

        function displayExpenses() {
            const tbody = document.getElementById('expensesTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            expenses.forEach(expense => {
                const project = projects.find(p => p.id === expense.projectId);
                const projectName = project ? project.name : 'ä¸€èˆ¬çµŒè²»';

                const row = `
                    <tr>
                        <td>${expense.date}</td>
                        <td>${projectName}</td>
                        <td>${expense.category}</td>
                        <td>Â¥${expense.amount.toLocaleString()}</td>
                        <td>${expense.supplier || '-'}</td>
                        <td>${expense.paymentMethod}</td>
                        <td>${expense.description || '-'}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editExpense('${expense.id}')">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteExpense('${expense.id}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateExpenseSummary() {
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            const monthlyExpenseTotal = expenses
                .filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate.getMonth() + 1 === currentMonth && expDate.getFullYear() === currentYear;
                })
                .reduce((sum, exp) => sum + Number(exp.amount), 0);

            const monthlyExpenseElement = document.getElementById('monthlyExpenses');
            if (monthlyExpenseElement) {
                monthlyExpenseElement.textContent = `Â¥${monthlyExpenseTotal.toLocaleString()}`;
            }

            // Calculate top expense category
            const categoryTotals = {};
            expenses.forEach(exp => {
                const expDate = new Date(exp.date);
                if (expDate.getMonth() + 1 === currentMonth && expDate.getFullYear() === currentYear) {
                    categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + Number(exp.amount);
                }
            });

            let topCategory = '-';
            let maxAmount = 0;
            Object.entries(categoryTotals).forEach(([category, total]) => {
                if (total > maxAmount) {
                    maxAmount = total;
                    topCategory = category;
                }
            });

            const topCategoryElement = document.getElementById('topExpenseCategory');
            if (topCategoryElement) {
                topCategoryElement.textContent = topCategory;
            }
        }
        // Invoice Management
        function addInvoice() {
            const projectId = document.getElementById('invoiceProject').value;
            const issueDate = document.getElementById('invoiceDate').value;
            const totalAmount = document.getElementById('invoiceAmount').value;

            if (!projectId || !issueDate || !totalAmount) {
                alert('å¯¾è±¡å·¥äº‹ã€ç™ºè¡Œæ—¥ã€è«‹æ±‚é‡‘é¡ã¯å¿…é ˆé …ç›®ã§ã™ã€‚');
                return;
            }

            const invoiceNumber = document.getElementById('invoiceNumber').value || generateInvoiceNumber();

            const invoice = {
                id: generateId('SEI'),
                invoiceNumber: invoiceNumber,
                projectId: projectId,
                issueDate: issueDate,
                dueDate: document.getElementById('invoiceDueDate').value,
                totalAmount: Number(totalAmount),
                taxAmount: Number(document.getElementById('taxAmount').value) || 0,
                status: document.getElementById('invoiceStatus').value,
                paymentTerms: document.getElementById('paymentTerms').value,
                notes: document.getElementById('invoiceNotes').value,
                timestamp: new Date().toISOString()
            };

            invoices.push(invoice);
            saveAllData();
            clearInvoiceForm();
            refreshAllDisplays();
            alert('è«‹æ±‚æ›¸ãŒæ­£å¸¸ã«ç™ºè¡Œã•ã‚Œã¾ã—ãŸã€‚');
        }

        function generateInvoiceNumber() {
            const year = new Date().getFullYear();
            const month = String(new Date().getMonth() + 1).padStart(2, '0');
            const count = invoices.length + 1;
            return `INV-${year}${month}-${String(count).padStart(3, '0')}`;
        }

        function clearInvoiceForm() {
            document.getElementById('invoiceProject').value = '';
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDueDate').value = '';
            document.getElementById('invoiceAmount').value = '';
            document.getElementById('invoiceNumber').value = '';
            document.getElementById('taxAmount').value = '';
            document.getElementById('invoiceStatus').value = 'ä¸‹æ›¸ã';
            document.getElementById('paymentTerms').value = 'æœˆæœ«ç· ç¿Œæœˆæœ«æ‰•';
            document.getElementById('invoiceNotes').value = '';
        }

        function displayInvoices() {
            const tbody = document.getElementById('invoicesTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            invoices.forEach(invoice => {
                const project = projects.find(p => p.id === invoice.projectId);
                const paymentStatus = calculatePaymentStatus(invoice.id);
                const statusClass = paymentStatus.status === 'å…¥é‡‘æ¸ˆ' ? 'paid' : 
                                   paymentStatus.status === 'ä¸€éƒ¨å…¥é‡‘' ? 'partial' : 'unpaid';

                // Check for overdue
                const today = new Date();
                const dueDate = new Date(invoice.dueDate);
                const isOverdue = invoice.dueDate && dueDate < today && paymentStatus.status !== 'å…¥é‡‘æ¸ˆ';

                const row = `
                    <tr ${isOverdue ? 'class="aging-30"' : ''}>
                        <td>${invoice.invoiceNumber}</td>
                        <td>${project ? project.name : 'ä¸æ˜ãªå·¥äº‹'}</td>
                        <td>${project ? project.client : 'ä¸æ˜ãªé¡§å®¢'}</td>
                        <td>${invoice.issueDate}</td>
                        <td>Â¥${invoice.totalAmount.toLocaleString()}</td>
                        <td><span class="status status-${statusClass}">${paymentStatus.status}</span></td>
                        <td>Â¥${paymentStatus.paidAmount.toLocaleString()} / Â¥${invoice.totalAmount.toLocaleString()}</td>
                        <td>${invoice.dueDate || '-'}${isOverdue ? ' âš ï¸' : ''}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="registerPayment('${invoice.id}')">å…¥é‡‘ç™»éŒ²</button>
                            <button class="btn btn-warning btn-sm" onclick="editInvoice('${invoice.id}')">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice.id}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateInvoiceSummary() {
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            // Monthly invoices
            const monthlyInvoiceTotal = invoices
                .filter(inv => {
                    const invDate = new Date(inv.issueDate);
                    return invDate.getMonth() + 1 === currentMonth && invDate.getFullYear() === currentYear;
                })
                .reduce((sum, inv) => sum + Number(inv.totalAmount), 0);

            const monthlyInvoicesElement = document.getElementById('monthlyInvoices');
            if (monthlyInvoicesElement) {
                monthlyInvoicesElement.textContent = `Â¥${monthlyInvoiceTotal.toLocaleString()}`;
            }

            // Unpaid invoices
            let unpaidTotal = 0;
            invoices.forEach(invoice => {
                const paymentStatus = calculatePaymentStatus(invoice.id);
                unpaidTotal += paymentStatus.remainingAmount;
            });

            const unpaidInvoicesElement = document.getElementById('unpaidInvoices');
            if (unpaidInvoicesElement) {
                unpaidInvoicesElement.textContent = `Â¥${unpaidTotal.toLocaleString()}`;
            }
        }

        // Payment Management
        function addPayment() {
            const invoiceId = document.getElementById('paymentInvoice').value;
            const paymentDate = document.getElementById('paymentDate').value;
            const amount = document.getElementById('paymentAmount').value;

            if (!invoiceId || !paymentDate || !amount) {
                alert('è«‹æ±‚æ›¸ç•ªå·ã€å…¥é‡‘æ—¥ã€å…¥é‡‘é¡ã¯å¿…é ˆé …ç›®ã§ã™ã€‚');
                return;
            }

            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) {
                alert('é¸æŠã•ã‚ŒãŸè«‹æ±‚æ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const currentPaymentStatus = calculatePaymentStatus(invoiceId);
            const remainingAmount = currentPaymentStatus.remainingAmount;

            if (Number(amount) > remainingAmount) {
                alert(`å…¥é‡‘é¡ãŒæ®‹é¡ï¼ˆÂ¥${remainingAmount.toLocaleString()}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
                return;
            }

            const payment = {
                id: generateId('PAY'),
                invoiceId: invoiceId,
                paymentDate: paymentDate,
                amount: Number(amount),
                method: document.getElementById('paymentMethod').value,
                payer: document.getElementById('paymentPayer').value,
                memo: document.getElementById('paymentMemo').value,
                timestamp: new Date().toISOString()
            };

            payments.push(payment);
            saveAllData();
            clearPaymentForm();
            refreshAllDisplays();

            const newPaymentStatus = calculatePaymentStatus(invoiceId);
            const statusMessage = newPaymentStatus.status === 'å…¥é‡‘æ¸ˆ' ? 
                'å…¥é‡‘ãŒå®Œäº†ã—ã¾ã—ãŸã€‚' : `éƒ¨åˆ†å…¥é‡‘ãŒç™»éŒ²ã•ã‚Œã¾ã—ãŸã€‚æ®‹é¡ï¼šÂ¥${newPaymentStatus.remainingAmount.toLocaleString()}`;
            alert(statusMessage);
        }

        function clearPaymentForm() {
            document.getElementById('paymentInvoice').value = '';
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentMethod').value = 'æŒ¯è¾¼';
            document.getElementById('paymentPayer').value = '';
            document.getElementById('paymentMemo').value = '';
        }

        function displayPayments() {
            const tbody = document.getElementById('paymentsTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            payments.forEach(payment => {
                const invoice = invoices.find(inv => inv.id === payment.invoiceId);
                const project = invoice ? projects.find(p => p.id === invoice.projectId) : null;
                const paymentStatus = calculatePaymentStatus(payment.invoiceId);

                const row = `
                    <tr>
                        <td>${payment.paymentDate}</td>
                        <td>${invoice ? invoice.invoiceNumber : 'ä¸æ˜'}</td>
                        <td>${project ? project.name : 'ä¸æ˜ãªå·¥äº‹'}</td>
                        <td>${project ? project.client : 'ä¸æ˜ãªé¡§å®¢'}</td>
                        <td>Â¥${payment.amount.toLocaleString()}</td>
                        <td>${payment.method}</td>
                        <td>Â¥${paymentStatus.remainingAmount.toLocaleString()}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editPayment('${payment.id}')">ç·¨é›†</button>
                            <button class="btn btn-danger btn-sm" onclick="deletePayment('${payment.id}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updatePaymentSummary() {
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            // Monthly payments
            const monthlyPaymentTotal = payments
                .filter(pay => {
                    const payDate = new Date(pay.paymentDate);
                    return payDate.getMonth() + 1 === currentMonth && payDate.getFullYear() === currentYear;
                })
                .reduce((sum, pay) => sum + Number(pay.amount), 0);

            const monthlyPaymentsElement = document.getElementById('monthlyPayments');
            if (monthlyPaymentsElement) {
                monthlyPaymentsElement.textContent = `Â¥${monthlyPaymentTotal.toLocaleString()}`;
            }

            // Total receivables
            let totalReceivables = 0;
            invoices.forEach(invoice => {
                const paymentStatus = calculatePaymentStatus(invoice.id);
                totalReceivables += paymentStatus.remainingAmount;
            });

            const totalReceivablesElement = document.getElementById('totalReceivables');
            if (totalReceivablesElement) {
                totalReceivablesElement.textContent = `Â¥${totalReceivables.toLocaleString()}`;
            }

            // Expected payments (current month)
            const expectedPayments = invoices
                .filter(inv => {
                    if (!inv.dueDate) return false;
                    const dueDate = new Date(inv.dueDate);
                    return dueDate.getMonth() + 1 === currentMonth && dueDate.getFullYear() === currentYear;
                })
                .reduce((sum, inv) => {
                    const paymentStatus = calculatePaymentStatus(inv.id);
                    return sum + paymentStatus.remainingAmount;
                }, 0);

            const expectedPaymentsElement = document.getElementById('expectedPayments');
            if (expectedPaymentsElement) {
                expectedPaymentsElement.textContent = `Â¥${expectedPayments.toLocaleString()}`;
            }
        }

        function updatePaymentInvoiceDropdown() {
            const paymentInvoice = document.getElementById('paymentInvoice');
            if (!paymentInvoice) return;

            paymentInvoice.innerHTML = '<option value="">æœªå…¥é‡‘ãƒ»ä¸€éƒ¨å…¥é‡‘ã®è«‹æ±‚æ›¸ã‚’é¸æŠ</option>';

            invoices.forEach(invoice => {
                const paymentStatus = calculatePaymentStatus(invoice.id);
                if (paymentStatus.status !== 'å…¥é‡‘æ¸ˆ') {
                    const project = projects.find(p => p.id === invoice.projectId);
                    const projectName = project ? project.name : 'ä¸æ˜ãªå·¥äº‹';
                    const clientName = project ? project.client : 'ä¸æ˜ãªé¡§å®¢';
                    const remainingAmount = paymentStatus.remainingAmount;

                    paymentInvoice.innerHTML += `
                        <option value="${invoice.id}">
                            ${invoice.invoiceNumber} - ${projectName} (${clientName}) - æ®‹é¡:Â¥${remainingAmount.toLocaleString()}
                        </option>
                    `;
                }
            });
        }

        function registerPayment(invoiceId) {
            document.getElementById('paymentInvoice').value = invoiceId;
            showSheet('payments');
        }

        // Receivables Management
        function displayReceivables() {
            const tbody = document.getElementById('receivablesTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            const unpaidInvoices = invoices.filter(invoice => {
                const paymentStatus = calculatePaymentStatus(invoice.id);
                return paymentStatus.remainingAmount > 0;
            });

            unpaidInvoices.forEach(invoice => {
                const project = projects.find(p => p.id === invoice.projectId);
                const paymentStatus = calculatePaymentStatus(invoice.id);

                // Calculate aging
                const today = new Date();
                const issueDate = new Date(invoice.issueDate);
                const daysPassed = Math.floor((today - issueDate) / (1000 * 60 * 60 * 24));

                let agingClass = '';
                if (daysPassed >= 30) agingClass = 'aging-30';
                else if (daysPassed >= 15) agingClass = 'aging-15';
                else agingClass = 'aging-current';

                const row = `
                    <tr class="${agingClass}">
                        <td>${invoice.invoiceNumber}</td>
                        <td>${invoice.issueDate}</td>
                        <td>${project ? project.client : 'ä¸æ˜ãªé¡§å®¢'}</td>
                        <td>Â¥${invoice.totalAmount.toLocaleString()}</td>
                        <td>Â¥${paymentStatus.paidAmount.toLocaleString()}</td>
                        <td>Â¥${paymentStatus.remainingAmount.toLocaleString()}</td>
                        <td>${invoice.dueDate || '-'}</td>
                        <td>${daysPassed}æ—¥</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="registerPayment('${invoice.id}')">å…¥é‡‘ç™»éŒ²</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Update customer receivables summary
            updateCustomerReceivables();
        }

        function updateCustomerReceivables() {
            const tbody = document.getElementById('customerReceivablesBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            const customerSummary = {};

            invoices.forEach(invoice => {
                const project = projects.find(p => p.id === invoice.projectId);
                const clientName = project ? project.client : 'ä¸æ˜ãªé¡§å®¢';
                const paymentStatus = calculatePaymentStatus(invoice.id);

                if (paymentStatus.remainingAmount > 0) {
                    if (!customerSummary[clientName]) {
                        customerSummary[clientName] = {
                            count: 0,
                            amount: 0,
                            oldestDate: invoice.issueDate
                        };
                    }

                    customerSummary[clientName].count++;
                    customerSummary[clientName].amount += paymentStatus.remainingAmount;

                    if (new Date(invoice.issueDate) < new Date(customerSummary[clientName].oldestDate)) {
                        customerSummary[clientName].oldestDate = invoice.issueDate;
                    }
                }
            });

            Object.entries(customerSummary).forEach(([client, summary]) => {
                const row = `
                    <tr>
                        <td>${client}</td>
                        <td>${summary.count}ä»¶</td>
                        <td>Â¥${summary.amount.toLocaleString()}</td>
                        <td>${summary.oldestDate}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="contactCustomer('${client}')">é€£çµ¡</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateReceivableSummary() {
            // Total receivables amount
            let totalReceivablesAmount = 0;
            let overdue30Amount = 0;

            invoices.forEach(invoice => {
                const paymentStatus = calculatePaymentStatus(invoice.id);
                totalReceivablesAmount += paymentStatus.remainingAmount;

                const today = new Date();
                const issueDate = new Date(invoice.issueDate);
                const daysPassed = Math.floor((today - issueDate) / (1000 * 60 * 60 * 24));

                if (daysPassed >= 30 && paymentStatus.remainingAmount > 0) {
                    overdue30Amount += paymentStatus.remainingAmount;
                }
            });

            const totalReceivablesAmountElement = document.getElementById('totalReceivablesAmount');
            if (totalReceivablesAmountElement) {
                totalReceivablesAmountElement.textContent = `Â¥${totalReceivablesAmount.toLocaleString()}`;
            }

            const overdue30Element = document.getElementById('overdue30');
            if (overdue30Element) {
                overdue30Element.textContent = `Â¥${overdue30Amount.toLocaleString()}`;
            }

            // Update expected payments calendar
            updateExpectedPaymentsCalendar();
        }

        function updateExpectedPaymentsCalendar() {
            const today = new Date();
            const thisWeekEnd = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            const nextWeekEnd = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000);
            const thisMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            let thisWeekExpected = 0;
            let nextWeekExpected = 0;
            let thisMonthExpected = 0;

            invoices.forEach(invoice => {
                if (!invoice.dueDate) return;

                const dueDate = new Date(invoice.dueDate);
                const paymentStatus = calculatePaymentStatus(invoice.id);
                const remaining = paymentStatus.remainingAmount;

                if (remaining > 0) {
                    if (dueDate <= thisWeekEnd) {
                        thisWeekExpected += remaining;
                    } else if (dueDate <= nextWeekEnd) {
                        nextWeekExpected += remaining;
                    }

                    if (dueDate <= thisMonthEnd) {
                        thisMonthExpected += remaining;
                    }
                }
            });

            const thisWeekElement = document.getElementById('thisWeekExpected');
            const nextWeekElement = document.getElementById('nextWeekExpected');
            const thisMonthElement = document.getElementById('thisMonthExpected');

            if (thisWeekElement) thisWeekElement.textContent = `Â¥${thisWeekExpected.toLocaleString()}`;
            if (nextWeekElement) nextWeekElement.textContent = `Â¥${nextWeekExpected.toLocaleString()}`;
            if (thisMonthElement) thisMonthElement.textContent = `Â¥${thisMonthExpected.toLocaleString()}`;
        }
        // Cash Flow Analysis
        function updateCashflowAnalysis() {
            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            // Calculate current month data
            const monthlySales = invoices
                .filter(inv => {
                    const invDate = new Date(inv.issueDate);
                    return invDate.getMonth() + 1 === currentMonth && invDate.getFullYear() === currentYear;
                })
                .reduce((sum, inv) => sum + Number(inv.totalAmount), 0);

            const monthlyReceipts = payments
                .filter(pay => {
                    const payDate = new Date(pay.paymentDate);
                    return payDate.getMonth() + 1 === currentMonth && payDate.getFullYear() === currentYear;
                })
                .reduce((sum, pay) => sum + Number(pay.amount), 0);

            const paymentRate = monthlySales > 0 ? Math.round((monthlyReceipts / monthlySales) * 100) : 0;

            let outstandingAmount = 0;
            invoices.forEach(invoice => {
                const paymentStatus = calculatePaymentStatus(invoice.id);
                outstandingAmount += paymentStatus.remainingAmount;
            });

            // Update summary cards
            updateElement('monthlySales', `Â¥${monthlySales.toLocaleString()}`);
            updateElement('monthlyReceipts', `Â¥${monthlyReceipts.toLocaleString()}`);
            updateElement('paymentRate', `${paymentRate}%`);
            updateElement('outstandingAmount', `Â¥${outstandingAmount.toLocaleString()}`);

            // Generate charts
            generateCashflowChart();
            generateForecastChart();
        }

        function generateCashflowChart() {
            const ctx = document.getElementById('cashflowChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (window.cashflowChartInstance) {
                window.cashflowChartInstance.destroy();
            }

            // Get monthly data for the past 12 months
            const monthlyData = getMonthlyAnalysisData();

            window.cashflowChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.labels,
                    datasets: [
                        {
                            label: 'è«‹æ±‚é¡ï¼ˆå£²ä¸Šï¼‰',
                            data: monthlyData.invoiceAmounts,
                            backgroundColor: 'rgba(102, 126, 234, 0.6)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'å…¥é‡‘é¡',
                            data: monthlyData.paymentAmounts,
                            backgroundColor: 'rgba(86, 171, 47, 0.6)',
                            borderColor: 'rgba(86, 171, 47, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æœˆåˆ¥å…¥é‡‘å®Ÿç¸¾ã‚°ãƒ©ãƒ•ï¼ˆéå»12ãƒ¶æœˆï¼‰'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateForecastChart() {
            const ctx = document.getElementById('forecastChart');
            if (!ctx) return;

            // Destroy existing chart if it exists
            if (window.forecastChartInstance) {
                window.forecastChartInstance.destroy();
            }

            const forecastData = getForecastData();

            window.forecastChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: forecastData.labels,
                    datasets: [
                        {
                            label: 'å…¥é‡‘äºˆå®š',
                            data: forecastData.expected,
                            borderColor: 'rgba(240, 147, 251, 1)',
                            backgroundColor: 'rgba(240, 147, 251, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'å…¥é‡‘å®Ÿç¸¾',
                            data: forecastData.actual,
                            borderColor: 'rgba(79, 172, 254, 1)',
                            backgroundColor: 'rgba(79, 172, 254, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'å…¥é‡‘äºˆå®š vs å®Ÿç¸¾ã®æ¯”è¼ƒ'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function getMonthlyAnalysisData() {
            const data = {
                labels: [],
                invoiceAmounts: [],
                paymentAmounts: []
            };

            const now = new Date();

            for (let i = 11; i >= 0; i--) {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const month = targetDate.getMonth() + 1;
                const year = targetDate.getFullYear();

                data.labels.push(`${year}/${month}`);

                // Calculate invoice amounts for this month
                const monthlyInvoices = invoices
                    .filter(inv => {
                        const invDate = new Date(inv.issueDate);
                        return invDate.getMonth() + 1 === month && invDate.getFullYear() === year;
                    })
                    .reduce((sum, inv) => sum + Number(inv.totalAmount), 0);

                // Calculate payment amounts for this month
                const monthlyPayments = payments
                    .filter(pay => {
                        const payDate = new Date(pay.paymentDate);
                        return payDate.getMonth() + 1 === month && payDate.getFullYear() === year;
                    })
                    .reduce((sum, pay) => sum + Number(pay.amount), 0);

                data.invoiceAmounts.push(monthlyInvoices);
                data.paymentAmounts.push(monthlyPayments);
            }

            return data;
        }

        function getForecastData() {
            const data = {
                labels: [],
                expected: [],
                actual: []
            };

            const now = new Date();

            for (let i = 5; i >= 0; i--) {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const month = targetDate.getMonth() + 1;
                const year = targetDate.getFullYear();

                data.labels.push(`${year}/${month}`);

                // Calculate expected payments (due dates in this month)
                const expectedAmount = invoices
                    .filter(inv => {
                        if (!inv.dueDate) return false;
                        const dueDate = new Date(inv.dueDate);
                        return dueDate.getMonth() + 1 === month && dueDate.getFullYear() === year;
                    })
                    .reduce((sum, inv) => {
                        const paymentStatus = calculatePaymentStatus(inv.id);
                        return sum + paymentStatus.remainingAmount;
                    }, 0);

                // Calculate actual payments
                const actualAmount = payments
                    .filter(pay => {
                        const payDate = new Date(pay.paymentDate);
                        return payDate.getMonth() + 1 === month && payDate.getFullYear() === year;
                    })
                    .reduce((sum, pay) => sum + Number(pay.amount), 0);

                data.expected.push(expectedAmount);
                data.actual.push(actualAmount);
            }

            return data;
        }

        // Monthly Report Generation
        function generateMonthlyReport() {
            const year = Number(document.getElementById('monthlyYear').value);
            const month = Number(document.getElementById('monthlyMonth').value);

            const monthlyData = calculateMonthlyData(year, month);
            displayMonthlyReport(monthlyData);
        }

        function calculateMonthlyData(year, month) {
            // Accrual basis (invoice-based)
            const accrualRevenue = invoices
                .filter(inv => {
                    const invDate = new Date(inv.issueDate);
                    return invDate.getMonth() + 1 === month && invDate.getFullYear() === year;
                })
                .reduce((sum, inv) => sum + Number(inv.totalAmount), 0);

            const accrualExpenses = expenses
                .filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate.getMonth() + 1 === month && expDate.getFullYear() === year;
                })
                .reduce((sum, exp) => sum + Number(exp.amount), 0);

            // Cash basis (payment-based)
            const cashRevenue = payments
                .filter(pay => {
                    const payDate = new Date(pay.paymentDate);
                    return payDate.getMonth() + 1 === month && payDate.getFullYear() === year;
                })
                .reduce((sum, pay) => sum + Number(pay.amount), 0);

            const cashExpenses = accrualExpenses; // Assuming expenses are paid when recorded

            return {
                accrualRevenue,
                accrualExpenses,
                accrualProfit: accrualRevenue - accrualExpenses,
                cashRevenue,
                cashExpenses,
                cashProfit: cashRevenue - cashExpenses
            };
        }

        function displayMonthlyReport(data) {
            const tbody = document.getElementById('monthlyReportBody');
            if (!tbody) return;

            tbody.innerHTML = `
                <tr>
                    <td><strong>å£²ä¸Š</strong></td>
                    <td>Â¥${data.accrualRevenue.toLocaleString()}</td>
                    <td>Â¥${data.cashRevenue.toLocaleString()}</td>
                    <td>Â¥${(data.cashRevenue - data.accrualRevenue).toLocaleString()}</td>
                </tr>
                <tr>
                    <td><strong>çµŒè²»</strong></td>
                    <td>Â¥${data.accrualExpenses.toLocaleString()}</td>
                    <td>Â¥${data.cashExpenses.toLocaleString()}</td>
                    <td>Â¥${(data.cashExpenses - data.accrualExpenses).toLocaleString()}</td>
                </tr>
                <tr>
                    <td><strong>åˆ©ç›Š</strong></td>
                    <td>Â¥${data.accrualProfit.toLocaleString()}</td>
                    <td>Â¥${data.cashProfit.toLocaleString()}</td>
                    <td>Â¥${(data.cashProfit - data.accrualProfit).toLocaleString()}</td>
                </tr>
            `;
        }

        // Yearly Report Generation
        function generateYearlyReport() {
            const year = Number(document.getElementById('yearlyAnalysisYear').value);
            const yearlyData = calculateYearlyData(year);
            displayYearlyReport(yearlyData);
            generateYearlyChart(year);
        }

        function calculateYearlyData(year) {
            const yearlySales = invoices
                .filter(inv => new Date(inv.issueDate).getFullYear() === year)
                .reduce((sum, inv) => sum + Number(inv.totalAmount), 0);

            const yearlyExpenses = expenses
                .filter(exp => new Date(exp.date).getFullYear() === year)
                .reduce((sum, exp) => sum + Number(exp.amount), 0);

            const yearlyProfit = yearlySales - yearlyExpenses;
            const yearlyMargin = yearlySales > 0 ? Math.round((yearlyProfit / yearlySales) * 100) : 0;

            return { yearlySales, yearlyExpenses, yearlyProfit, yearlyMargin };
        }

        function displayYearlyReport(data) {
            updateElement('yearlySales', `Â¥${data.yearlySales.toLocaleString()}`);
            updateElement('yearlyExpenses', `Â¥${data.yearlyExpenses.toLocaleString()}`);
            updateElement('yearlyProfit', `Â¥${data.yearlyProfit.toLocaleString()}`);
            updateElement('yearlyMargin', `${data.yearlyMargin}%`);
        }

        function generateYearlyChart(year) {
            const ctx = document.getElementById('yearlyChart');
            if (!ctx) return;

            if (window.yearlyChartInstance) {
                window.yearlyChartInstance.destroy();
            }

            const monthlyData = [];
            const labels = [];

            for (let month = 1; month <= 12; month++) {
                labels.push(`${month}æœˆ`);
                const monthlyProfit = calculateMonthlyData(year, month);
                monthlyData.push(monthlyProfit.accrualProfit);
            }

            window.yearlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æœˆæ¬¡åˆ©ç›Š',
                        data: monthlyData,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `${year}å¹´ æœˆæ¬¡åˆ©ç›Šæ¨ç§»`
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Tax Report Functions
        function generateTaxReports() {
            alert('ç¨å‹™è³‡æ–™ã®ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™ã€‚å„ç¨®å°å¸³ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã§ãã¾ã™ã€‚');
        }

        // CSV Export Functions
        function exportProjectsCSV() {
            const headers = ['å·¥äº‹ID', 'å·¥äº‹å', 'é¡§å®¢å', 'å¥‘ç´„é‡‘é¡', 'é–‹å§‹æ—¥', 'å®Œäº†äºˆå®šæ—¥', 'çŠ¶æ³', 'å ´æ‰€', 'æ‹…å½“è€…', 'å‚™è€ƒ'];
            const rows = projects.map(p => [
                p.id, p.name, p.client, p.contractAmount, p.startDate || '', 
                p.completionDate || '', p.status, p.location || '', p.manager || '', p.notes || ''
            ]);
            downloadCSV(headers, rows, 'projects.csv');
        }

        function exportExpensesCSV() {
            const headers = ['çµŒè²»ID', 'é–¢é€£å·¥äº‹', 'æ—¥ä»˜', 'è²»ç›®', 'é‡‘é¡', 'å–å¼•å…ˆ', 'æ”¯æ‰•æ–¹æ³•', 'é ˜åæ›¸ç•ªå·', 'ç¨å‹™åŒºåˆ†', 'æ‘˜è¦'];
            const rows = expenses.map(e => {
                const project = projects.find(p => p.id === e.projectId);
                return [
                    e.id, project ? project.name : 'ä¸€èˆ¬çµŒè²»', e.date, e.category, e.amount,
                    e.supplier || '', e.paymentMethod, e.receiptNumber || '', e.taxType, e.description || ''
                ];
            });
            downloadCSV(headers, rows, 'expenses.csv');
        }

        function exportInvoicesCSV() {
            const headers = ['è«‹æ±‚æ›¸ID', 'è«‹æ±‚æ›¸ç•ªå·', 'å·¥äº‹å', 'é¡§å®¢å', 'ç™ºè¡Œæ—¥', 'è«‹æ±‚é‡‘é¡', 'æ¶ˆè²»ç¨', 'å…¥é‡‘äºˆå®šæ—¥', 'çŠ¶æ³', 'å‚™è€ƒ'];
            const rows = invoices.map(i => {
                const project = projects.find(p => p.id === i.projectId);
                return [
                    i.id, i.invoiceNumber, project ? project.name : 'ä¸æ˜', project ? project.client : 'ä¸æ˜',
                    i.issueDate, i.totalAmount, i.taxAmount, i.dueDate || '', i.status, i.notes || ''
                ];
            });
            downloadCSV(headers, rows, 'invoices.csv');
        }

        function exportPaymentLedger() {
            const headers = ['å…¥é‡‘ID', 'è«‹æ±‚æ›¸ç•ªå·', 'å·¥äº‹å', 'é¡§å®¢å', 'å…¥é‡‘æ—¥', 'å…¥é‡‘é¡', 'å…¥é‡‘æ–¹æ³•', 'åç¾©äºº', 'ãƒ¡ãƒ¢'];
            const rows = payments.map(p => {
                const invoice = invoices.find(i => i.id === p.invoiceId);
                const project = invoice ? projects.find(pr => pr.id === invoice.projectId) : null;
                return [
                    p.id, invoice ? invoice.invoiceNumber : 'ä¸æ˜', 
                    project ? project.name : 'ä¸æ˜', project ? project.client : 'ä¸æ˜',
                    p.paymentDate, p.amount, p.method, p.payer || '', p.memo || ''
                ];
            });
            downloadCSV(headers, rows, 'payments.csv');
        }

        function exportSalesLedger() {
            const headers = ['è«‹æ±‚æ›¸ç•ªå·', 'ç™ºè¡Œæ—¥', 'é¡§å®¢å', 'å·¥äº‹å', 'è«‹æ±‚é¡', 'å…¥é‡‘é¡', 'æ®‹é¡', 'å…¥é‡‘çŠ¶æ³'];
            const rows = invoices.map(i => {
                const project = projects.find(p => p.id === i.projectId);
                const paymentStatus = calculatePaymentStatus(i.id);
                return [
                    i.invoiceNumber, i.issueDate, project ? project.client : 'ä¸æ˜',
                    project ? project.name : 'ä¸æ˜', i.totalAmount,
                    paymentStatus.paidAmount, paymentStatus.remainingAmount, paymentStatus.status
                ];
            });
            downloadCSV(headers, rows, 'sales_ledger.csv');
        }

        function exportExpenseLedger() {
            exportExpensesCSV(); // Same as expense export
        }

        function exportProfitLoss() {
            const currentYear = new Date().getFullYear();
            const headers = ['æœˆ', 'å£²ä¸Šï¼ˆè«‹æ±‚ãƒ™ãƒ¼ã‚¹ï¼‰', 'å£²ä¸Šï¼ˆå…¥é‡‘ãƒ™ãƒ¼ã‚¹ï¼‰', 'çµŒè²»', 'åˆ©ç›Šï¼ˆè«‹æ±‚ãƒ™ãƒ¼ã‚¹ï¼‰', 'åˆ©ç›Šï¼ˆå…¥é‡‘ãƒ™ãƒ¼ã‚¹ï¼‰'];
            const rows = [];

            for (let month = 1; month <= 12; month++) {
                const monthlyData = calculateMonthlyData(currentYear, month);
                rows.push([
                    `${month}æœˆ`, monthlyData.accrualRevenue, monthlyData.cashRevenue,
                    monthlyData.accrualExpenses, monthlyData.accrualProfit, monthlyData.cashProfit
                ]);
            }
            downloadCSV(headers, rows, 'profit_loss.csv');
        }

        function exportMonthlyCSV() {
            const year = Number(document.getElementById('monthlyYear').value);
            const month = Number(document.getElementById('monthlyMonth').value);
            const monthlyData = calculateMonthlyData(year, month);

            const headers = ['é …ç›®', 'ç™ºç”Ÿä¸»ç¾©', 'ç¾é‡‘ä¸»ç¾©', 'å·®é¡'];
            const rows = [
                ['å£²ä¸Š', monthlyData.accrualRevenue, monthlyData.cashRevenue, monthlyData.cashRevenue - monthlyData.accrualRevenue],
                ['çµŒè²»', monthlyData.accrualExpenses, monthlyData.cashExpenses, monthlyData.cashExpenses - monthlyData.accrualExpenses],
                ['åˆ©ç›Š', monthlyData.accrualProfit, monthlyData.cashProfit, monthlyData.cashProfit - monthlyData.accrualProfit]
            ];
            downloadCSV(headers, rows, `monthly_report_${year}_${month}.csv`);
        }

        // Utility Functions
        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        }

        function downloadCSV(headers, rows, filename) {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += headers.join(",") + "\n";
            rows.forEach(row => {
                csvContent += row.map(field => `"${field}"`).join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function contactCustomer(customerName) {
            alert(`${customerName}æ§˜ã¸ã®é€£çµ¡æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™ã€‚`);
        }

        // Placeholder edit/delete functions
        function editProject(id) { alert('ç·¨é›†æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™ã€‚'); }
        function deleteProject(id) { 
            if (confirm('ã“ã®å·¥äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                projects = projects.filter(p => p.id !== id);
                saveAllData();
                refreshAllDisplays();
            }
        }
        function editExpense(id) { alert('ç·¨é›†æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™ã€‚'); }
        function deleteExpense(id) { 
            if (confirm('ã“ã®çµŒè²»ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                expenses = expenses.filter(e => e.id !== id);
                saveAllData();
                refreshAllDisplays();
            }
        }
        function editInvoice(id) { alert('ç·¨é›†æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™ã€‚'); }
        function deleteInvoice(id) { 
            if (confirm('ã“ã®è«‹æ±‚æ›¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                invoices = invoices.filter(i => i.id !== id);
                payments = payments.filter(p => p.invoiceId !== id);
                saveAllData();
                refreshAllDisplays();
            }
        }
        function editPayment(id) { alert('ç·¨é›†æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™ã€‚'); }
        function deletePayment(id) { 
            if (confirm('ã“ã®å…¥é‡‘è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                payments = payments.filter(p => p.id !== id);
                saveAllData();
                refreshAllDisplays();
            }
        }

        // ===== é¡§å®¢å°å¸³ç®¡ç† =====
        function addClient() {
            const clientData = {
                id: 'CLI-' + new Date().getFullYear() + '-' + String(clients.length + 1).padStart(3, '0'),
                code: document.getElementById('clientCode').value || 'CLI-' + String(clients.length + 1).padStart(4, '0'),
                name: document.getElementById('clientRegName').value,
                kana: document.getElementById('clientKana').value,
                postal: document.getElementById('clientPostal').value,
                address: document.getElementById('clientAddress').value,
                phone: document.getElementById('clientPhone').value,
                email: document.getElementById('clientEmail').value,
                contact: document.getElementById('clientContact').value,
                startDate: document.getElementById('clientStartDate').value,
                category: document.getElementById('clientCategory').value,
                notes: document.getElementById('clientNotes').value,
                timestamp: new Date().toISOString()
            };

            if (!clientData.name) {
                alert('é¡§å®¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            clients.push(clientData);
            localStorage.setItem('msinterior_clients', JSON.stringify(clients));
            
            alert('âœ… é¡§å®¢ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
            clearClientForm();
            displayClients();
        }

        function clearClientForm() {
            document.getElementById('clientCode').value = '';
            document.getElementById('clientRegName').value = '';
            document.getElementById('clientKana').value = '';
            document.getElementById('clientPostal').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientContact').value = '';
            document.getElementById('clientStartDate').value = '';
            document.getElementById('clientCategory').value = 'å€‹äºº';
            document.getElementById('clientNotes').value = '';
        }

        function displayClients() {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';

            clients.forEach(client => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${client.code}</td>
                    <td><strong>${client.name}</strong></td>
                    <td>${client.kana || '-'}</td>
                    <td>${client.phone || '-'}</td>
                    <td>${client.email || '-'}</td>
                    <td>${client.address || '-'}</td>
                    <td>${client.contact || '-'}</td>
                    <td><span class="status">${client.category}</span></td>
                    <td>${client.startDate || '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editClient('${client.id}')">âœï¸ ç·¨é›†</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteClient('${client.id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </td>
                `;
            });
        }

        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            document.getElementById('clientCode').value = client.code;
            document.getElementById('clientRegName').value = client.name;
            document.getElementById('clientKana').value = client.kana || '';
            document.getElementById('clientPostal').value = client.postal || '';
            document.getElementById('clientAddress').value = client.address || '';
            document.getElementById('clientPhone').value = client.phone || '';
            document.getElementById('clientEmail').value = client.email || '';
            document.getElementById('clientContact').value = client.contact || '';
            document.getElementById('clientStartDate').value = client.startDate || '';
            document.getElementById('clientCategory').value = client.category;
            document.getElementById('clientNotes').value = client.notes || '';

            deleteClient(id, true);
        }

        function deleteClient(id, skipConfirm = false) {
            if (!skipConfirm && !confirm('ã“ã®é¡§å®¢ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

            clients = clients.filter(c => c.id !== id);
            localStorage.setItem('msinterior_clients', JSON.stringify(clients));
            displayClients();
        }

        // ===== ä»•å…¥å…ˆå°å¸³ç®¡ç† =====
        function addSupplier() {
            const supplierData = {
                id: 'SUP-' + new Date().getFullYear() + '-' + String(suppliers.length + 1).padStart(3, '0'),
                code: document.getElementById('supplierCode').value || 'SUP-' + String(suppliers.length + 1).padStart(4, '0'),
                name: document.getElementById('supplierRegName').value,
                kana: document.getElementById('supplierKana').value,
                postal: document.getElementById('supplierPostal').value,
                address: document.getElementById('supplierAddress').value,
                phone: document.getElementById('supplierPhone').value,
                email: document.getElementById('supplierEmail').value,
                contact: document.getElementById('supplierContact').value,
                startDate: document.getElementById('supplierStartDate').value,
                category: document.getElementById('supplierCategory').value,
                paymentTerms: document.getElementById('supplierPaymentTerms').value,
                notes: document.getElementById('supplierNotes').value,
                timestamp: new Date().toISOString()
            };

            if (!supplierData.name) {
                alert('ä»•å…¥å…ˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            suppliers.push(supplierData);
            localStorage.setItem('msinterior_suppliers', JSON.stringify(suppliers));
            
            alert('âœ… ä»•å…¥å…ˆã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
            clearSupplierForm();
            displaySuppliers();
            updatePayableSupplierOptions();
        }

        function clearSupplierForm() {
            document.getElementById('supplierCode').value = '';
            document.getElementById('supplierRegName').value = '';
            document.getElementById('supplierKana').value = '';
            document.getElementById('supplierPostal').value = '';
            document.getElementById('supplierAddress').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierContact').value = '';
            document.getElementById('supplierStartDate').value = '';
            document.getElementById('supplierCategory').value = 'ææ–™æ¥­è€…';
            document.getElementById('supplierPaymentTerms').value = '';
            document.getElementById('supplierNotes').value = '';
        }

        function displaySuppliers() {
            const tbody = document.getElementById('suppliersTableBody');
            tbody.innerHTML = '';

            suppliers.forEach(supplier => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${supplier.code}</td>
                    <td><strong>${supplier.name}</strong></td>
                    <td>${supplier.kana || '-'}</td>
                    <td>${supplier.phone || '-'}</td>
                    <td>${supplier.email || '-'}</td>
                    <td>${supplier.address || '-'}</td>
                    <td>${supplier.contact || '-'}</td>
                    <td><span class="status">${supplier.category}</span></td>
                    <td>${supplier.paymentTerms || '-'}</td>
                    <td>${supplier.startDate || '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editSupplier('${supplier.id}')">âœï¸ ç·¨é›†</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSupplier('${supplier.id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </td>
                `;
            });
        }

        function editSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (!supplier) return;

            document.getElementById('supplierCode').value = supplier.code;
            document.getElementById('supplierRegName').value = supplier.name;
            document.getElementById('supplierKana').value = supplier.kana || '';
            document.getElementById('supplierPostal').value = supplier.postal || '';
            document.getElementById('supplierAddress').value = supplier.address || '';
            document.getElementById('supplierPhone').value = supplier.phone || '';
            document.getElementById('supplierEmail').value = supplier.email || '';
            document.getElementById('supplierContact').value = supplier.contact || '';
            document.getElementById('supplierStartDate').value = supplier.startDate || '';
            document.getElementById('supplierCategory').value = supplier.category;
            document.getElementById('supplierPaymentTerms').value = supplier.paymentTerms || '';
            document.getElementById('supplierNotes').value = supplier.notes || '';

            deleteSupplier(id, true);
        }

        function deleteSupplier(id, skipConfirm = false) {
            if (!skipConfirm && !confirm('ã“ã®ä»•å…¥å…ˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

            suppliers = suppliers.filter(s => s.id !== id);
            localStorage.setItem('msinterior_suppliers', JSON.stringify(suppliers));
            displaySuppliers();
            updatePayableSupplierOptions();
        }

        // ===== è²·æ›é‡‘ç®¡ç† =====
        function addPayable() {
            const payableData = {
                id: 'PAY-' + new Date().getFullYear() + '-' + String(payables.length + 1).padStart(3, '0'),
                date: document.getElementById('payableDate').value,
                supplierId: document.getElementById('payableSupplier').value,
                projectId: document.getElementById('payableProject').value,
                category: document.getElementById('payableCategory').value,
                amount: parseFloat(document.getElementById('payableAmount').value) || 0,
                paidAmount: 0,
                dueDate: document.getElementById('payableDueDate').value,
                description: document.getElementById('payableDescription').value,
                status: 'æœªæ‰•ã„',
                payments: [],
                timestamp: new Date().toISOString()
            };

            if (!payableData.date || !payableData.supplierId || !payableData.description || payableData.amount <= 0) {
                alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç™ºæ³¨æ—¥ã€ä»•å…¥å…ˆã€ç™ºæ³¨å†…å®¹ã€ç™ºæ³¨é‡‘é¡ï¼‰');
                return;
            }

            payables.push(payableData);
            localStorage.setItem('msinterior_payables', JSON.stringify(payables));
            
            alert('âœ… ç™ºæ³¨ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
            clearPayableForm();
            displayPayables();
            updatePayablePaymentOptions();
        }

        function clearPayableForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payableDate').value = today;
            document.getElementById('payableSupplier').value = '';
            document.getElementById('payableProject').value = '';
            document.getElementById('payableCategory').value = 'ææ–™è²»';
            document.getElementById('payableAmount').value = '';
            document.getElementById('payableDueDate').value = '';
            document.getElementById('payableDescription').value = '';
        }

        function displayPayables() {
            const tbody = document.getElementById('payablesTableBody');
            tbody.innerHTML = '';

            let totalUnpaid = 0;
            let totalPartial = 0;
            let totalPaid = 0;

            payables.forEach(payable => {
                const supplier = suppliers.find(s => s.id === payable.supplierId);
                const project = projects.find(p => p.id === payable.projectId);
                const balance = payable.amount - payable.paidAmount;

                let statusClass = 'status-unpaid';
                let statusText = 'æœªæ‰•ã„';
                if (payable.paidAmount === 0) {
                    totalUnpaid += balance;
                } else if (payable.paidAmount < payable.amount) {
                    statusClass = 'status-partial';
                    statusText = 'ä¸€éƒ¨æ”¯æ‰•ã„';
                    totalPartial += balance;
                } else {
                    statusClass = 'status-paid';
                    statusText = 'æ”¯æ‰•æ¸ˆ';
                    totalPaid += payable.amount;
                }

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${payable.id}</strong></td>
                    <td>${payable.date}</td>
                    <td>${supplier ? supplier.name : '-'}</td>
                    <td>${project ? project.name : '-'}</td>
                    <td>${payable.category}</td>
                    <td>Â¥${payable.amount.toLocaleString()}</td>
                    <td>Â¥${payable.paidAmount.toLocaleString()}</td>
                    <td><strong>Â¥${balance.toLocaleString()}</strong></td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>${payable.dueDate || '-'}</td>
                    <td>${payable.description}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editPayable('${payable.id}')">âœï¸ ç·¨é›†</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePayable('${payable.id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </td>
                `;
            });

            document.getElementById('totalUnpaidPayables').textContent = 'Â¥' + totalUnpaid.toLocaleString();
            document.getElementById('totalPartialPayables').textContent = 'Â¥' + totalPartial.toLocaleString();
            document.getElementById('totalPaidPayables').textContent = 'Â¥' + totalPaid.toLocaleString();
        }

        function editPayable(id) {
            const payable = payables.find(p => p.id === id);
            if (!payable) return;

            document.getElementById('payableDate').value = payable.date;
            document.getElementById('payableSupplier').value = payable.supplierId;
            document.getElementById('payableProject').value = payable.projectId || '';
            document.getElementById('payableCategory').value = payable.category;
            document.getElementById('payableAmount').value = payable.amount;
            document.getElementById('payableDueDate').value = payable.dueDate || '';
            document.getElementById('payableDescription').value = payable.description;

            deletePayable(id, true);
        }

        function deletePayable(id, skipConfirm = false) {
            if (!skipConfirm && !confirm('ã“ã®ç™ºæ³¨ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

            payables = payables.filter(p => p.id !== id);
            localStorage.setItem('msinterior_payables', JSON.stringify(payables));
            displayPayables();
            displayPayablePayments();
            updatePayablePaymentOptions();
        }

        function recordPayablePayment() {
            const payableId = document.getElementById('payablePaymentId').value;
            const paymentDate = document.getElementById('payablePaymentDate').value;
            const paymentAmount = parseFloat(document.getElementById('payablePaymentAmount').value) || 0;
            const paymentMethod = document.getElementById('payablePaymentMethod').value;

            if (!payableId || !paymentDate || paymentAmount <= 0) {
                alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const payable = payables.find(p => p.id === payableId);
            if (!payable) {
                alert('ç™ºæ³¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const balance = payable.amount - payable.paidAmount;
            if (paymentAmount > balance) {
                alert(`æ”¯æ‰•é¡ãŒæ®‹é¡ï¼ˆÂ¥${balance.toLocaleString()}ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™`);
                return;
            }

            const paymentRecord = {
                id: 'PAYPMT-' + Date.now(),
                payableId: payableId,
                date: paymentDate,
                amount: paymentAmount,
                method: paymentMethod,
                timestamp: new Date().toISOString()
            };

            payable.paidAmount += paymentAmount;
            if (!payable.payments) payable.payments = [];
            payable.payments.push(paymentRecord);

            if (payable.paidAmount >= payable.amount) {
                payable.status = 'æ”¯æ‰•æ¸ˆ';
            } else if (payable.paidAmount > 0) {
                payable.status = 'ä¸€éƒ¨æ”¯æ‰•ã„';
            }

            localStorage.setItem('msinterior_payables', JSON.stringify(payables));

            alert('âœ… æ”¯æ‰•ã„ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼');
            clearPayablePaymentForm();
            displayPayables();
            displayPayablePayments();
        }

        function clearPayablePaymentForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payablePaymentId').value = '';
            document.getElementById('payablePaymentDate').value = today;
            document.getElementById('payablePaymentAmount').value = '';
            document.getElementById('payablePaymentMethod').value = 'éŠ€è¡ŒæŒ¯è¾¼';
        }

        function displayPayablePayments() {
            const tbody = document.getElementById('payablePaymentsTableBody');
            tbody.innerHTML = '';

            const allPayments = [];
            payables.forEach(payable => {
                if (payable.payments && payable.payments.length > 0) {
                    payable.payments.forEach(payment => {
                        allPayments.push({
                            ...payment,
                            payable: payable
                        });
                    });
                }
            });

            allPayments.sort((a, b) => new Date(b.date) - new Date(a.date));

            allPayments.forEach(payment => {
                const supplier = suppliers.find(s => s.id === payment.payable.supplierId);
                const project = projects.find(p => p.id === payment.payable.projectId);
                const balance = payment.payable.amount - payment.payable.paidAmount;

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${payment.date}</td>
                    <td>${payment.payableId}</td>
                    <td>${supplier ? supplier.name : '-'}</td>
                    <td>${project ? project.name : '-'}</td>
                    <td>Â¥${payment.amount.toLocaleString()}</td>
                    <td>${payment.method}</td>
                    <td><strong>Â¥${balance.toLocaleString()}</strong></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deletePayablePayment('${payment.payableId}', '${payment.id}')">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </td>
                `;
            });
        }

        function deletePayablePayment(payableId, paymentId) {
            if (!confirm('ã“ã®æ”¯æ‰•ã„è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;

            const payable = payables.find(p => p.id === payableId);
            if (!payable) return;

            const payment = payable.payments.find(p => p.id === paymentId);
            if (!payment) return;

            payable.paidAmount -= payment.amount;
            payable.payments = payable.payments.filter(p => p.id !== paymentId);

            if (payable.paidAmount === 0) {
                payable.status = 'æœªæ‰•ã„';
            } else if (payable.paidAmount < payable.amount) {
                payable.status = 'ä¸€éƒ¨æ”¯æ‰•ã„';
            }

            localStorage.setItem('msinterior_payables', JSON.stringify(payables));
            displayPayables();
            displayPayablePayments();
        }

        function updatePayableSupplierOptions() {
            const select = document.getElementById('payableSupplier');
            select.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
            
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                select.appendChild(option);
            });
        }

        function updatePayableProjectOptions() {
            const select = document.getElementById('payableProject');
            select.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                select.appendChild(option);
            });
        }

        function updatePayablePaymentOptions() {
            const select = document.getElementById('payablePaymentId');
            select.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
            
            payables.filter(p => p.paidAmount < p.amount).forEach(payable => {
                const supplier = suppliers.find(s => s.id === payable.supplierId);
                const balance = payable.amount - payable.paidAmount;
                const option = document.createElement('option');
                option.value = payable.id;
                option.textContent = `${payable.id} - ${supplier ? supplier.name : 'ä¸æ˜'} (æ®‹é¡: Â¥${balance.toLocaleString()})`;
                select.appendChild(option);
            });
        }

    </script>
<script defer="" src="./index_files/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon="{&quot;version&quot;:&quot;2024.11.0&quot;,&quot;token&quot;:&quot;4edd5f8ec12a48cfa682ab8261b80a79&quot;,&quot;server_timing&quot;:{&quot;name&quot;:{&quot;cfCacheStatus&quot;:true,&quot;cfEdge&quot;:true,&quot;cfExtPri&quot;:true,&quot;cfL4&quot;:true,&quot;cfOrigin&quot;:true,&quot;cfSpeedBrain&quot;:true},&quot;location_startswith&quot;:null}}" crossorigin="anonymous"></script>

</div></body></html>