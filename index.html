<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¨ãƒ ã‚ºã‚¤ãƒ³ãƒ†ãƒªã‚¢çµŒç†ã‚·ã‚¹ãƒ†ãƒ  - è«‹æ±‚æ›¸æ©Ÿèƒ½ä»˜ã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans CJK JP', sans-serif;
            line-height: 1.6;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #2c5282;
        }
        
        .header h1 {
            color: #2c5282;
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .tab-button {
            padding: 12px 20px;
            background-color: #e2e8f0;
            color: #4a5568;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            background-color: #cbd5e0;
        }
        
        .tab-button.active {
            background-color: #2c5282;
            color: white;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .btn {
            background-color: #3182ce;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background-color: #2c5282;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background-color: #718096;
        }
        
        .btn-secondary:hover {
            background-color: #4a5568;
        }
        
        .btn-danger {
            background-color: #e53e3e;
        }
        
        .btn-danger:hover {
            background-color: #c53030;
        }
        
        .btn-success {
            background-color: #38a169;
        }
        
        .btn-success:hover {
            background-color: #2f855a;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        th {
            background-color: #4299e1;
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: bold;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        tr:nth-child(even) {
            background-color: #f7fafc;
        }
        
        tr:hover {
            background-color: #edf2f7;
        }
        
        .status-completed { color: #38a169; font-weight: bold; }
        .status-progress { color: #d69e2e; font-weight: bold; }
        .status-planning { color: #3182ce; font-weight: bold; }
        .status-paid { color: #38a169; font-weight: bold; }
        .status-unpaid { color: #e53e3e; font-weight: bold; }
        .status-partial { color: #d69e2e; font-weight: bold; }
        
        .info-box {
            background-color: #e6fffa;
            border-left: 4px solid #38b2ac;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .info-box h3 {
            color: #285e61;
            margin-bottom: 10px;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: bold;
        }
        
        .alert-success {
            background-color: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .alert-error {
            background-color: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .required {
            color: #e53e3e;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-button {
                margin-bottom: 5px;
                border-radius: 8px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px 5px;
            }
        }

        /* è«‹æ±‚æ›¸é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .invoice-container {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
            padding: 20mm;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
        }

        .company-info {
            font-size: 12px;
            line-height: 1.5;
        }

        .invoice-title {
            text-align: center;
            flex-grow: 1;
        }

        .invoice-title h1 {
            font-size: 36px;
            color: #2c5282;
            margin-bottom: 10px;
        }

        .invoice-details {
            text-align: right;
        }

        .company-seal {
            width: 60px;
            height: 60px;
            border: 2px solid #e53e3e;
            color: #e53e3e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-left: 20px;
        }

        .customer-info {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e2e8f0;
        }

        .total-amount {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #f7fafc;
            border: 2px solid #4299e1;
        }

        .total-amount h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .total-amount .amount {
            font-size: 32px;
            font-weight: bold;
            color: #2c5282;
        }

        .invoice-table {
            margin: 20px 0;
        }

        .invoice-table th {
            background-color: #bee3f8;
            color: #2c5282;
            text-align: center;
            padding: 10px 5px;
            font-size: 14px;
        }

        .invoice-table td {
            text-align: center;
            padding: 8px 5px;
            font-size: 13px;
        }

        .invoice-table .description {
            text-align: left;
        }

        .invoice-table .amount {
            text-align: right;
        }

        .bank-info {
            margin-top: 30px;
            padding: 15px;
            background-color: #f7fafc;
            border-radius: 8px;
        }

        .print-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
                padding: 0;
            }
            
            .tabs, .print-button {
                display: none;
            }
            
            .invoice-container {
                box-shadow: none;
                margin: 0;
            }
        }

        /* è¨­å®šç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .settings-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .settings-section h3 {
            color: #2c5282;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .file-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-top: 10px;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: #4299e1;
        }

        .file-upload-area.dragover {
            border-color: #3182ce;
            background-color: #f7fafc;
        }

        .seal-preview {
            max-width: 100px;
            max-height: 100px;
            margin: 10px auto;
            display: block;
        }

        .project-checkbox {
            cursor: pointer;
        }

        .project-selection-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            background: #f7fafc;
            transition: background-color 0.2s ease;
        }

        .project-selection-item:hover {
            background-color: #edf2f7;
        }

        .project-selection-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin-bottom: 0;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ ã‚¨ãƒ ã‚ºã‚¤ãƒ³ãƒ†ãƒªã‚¢çµŒç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <div class="subtitle">å·¥äº‹ç®¡ç†ãƒ»çµŒç†æ¥­å‹™ã®çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
        </div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('projects')">ğŸ—ï¸ å·¥äº‹å°å¸³</button>
            <button class="tab-button" onclick="showTab('expenses')">ğŸ’° çµŒè²»ç®¡ç†</button>
            <button class="tab-button" onclick="showTab('purchases')">ğŸ›’ ä»•å…¥ã‚Œç®¡ç†</button>
            <button class="tab-button" onclick="showTab('invoices')">ğŸ“‹ è«‹æ±‚æ›¸ç®¡ç†</button>
            <button class="tab-button" onclick="showTab('payments')">ğŸ’³ å…¥é‡‘ç®¡ç†</button>
            <button class="tab-button" onclick="showTab('customers')">ğŸ‘¥ é¡§å®¢ç®¡ç†</button>
            <button class="tab-button" onclick="showTab('monthly-invoice')">ğŸ“„ æœˆæ¬¡è«‹æ±‚æ›¸</button>
            <button class="tab-button" onclick="showTab('settings')">âš™ï¸ è¨­å®š</button>
            <button class="tab-button" onclick="showTab('receivables')">ğŸ“Š å£²æ›é‡‘ç®¡ç†</button>
            <button class="tab-button" onclick="showTab('cashflow')">ğŸ’¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼</button>
            <button class="tab-button" onclick="showTab('tax-docs')">ğŸ§¾ ç¨å‹™è³‡æ–™</button>
            <button class="tab-button" onclick="showTab('guide')">ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</button>
        </div>

        <!-- é¡§å®¢ç®¡ç†ã‚¿ãƒ– -->
        <div id="customers" class="tab-content">
            <h2>ğŸ‘¥ é¡§å®¢ç®¡ç†</h2>
            
            <div class="info-box">
                <h3>ğŸ’¡ é¡§å®¢ç®¡ç†ã«ã¤ã„ã¦</h3>
                <p>è«‹æ±‚æ›¸ç™ºè¡Œæ™‚ã«ä½¿ç”¨ã™ã‚‹é¡§å®¢æƒ…å ±ã‚’ç®¡ç†ã—ã¾ã™ã€‚ä¼šç¤¾åã€ä½æ‰€ã€æ‹…å½“è€…ãªã©ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚</p>
            </div>

            <div class="form-group">
                <label for="customerCompany">ä¼šç¤¾å <span class="required">*</span></label>
                <input type="text" id="customerCompany" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="customerZip">éƒµä¾¿ç•ªå·</label>
                    <input type="text" id="customerZip" placeholder="123-4567">
                </div>
                <div class="form-group">
                    <label for="customerAddress">ä½æ‰€</label>
                    <input type="text" id="customerAddress">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="customerPhone">é›»è©±ç•ªå·</label>
                    <input type="text" id="customerPhone">
                </div>
                <div class="form-group">
                    <label for="customerEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="customerEmail">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="customerContact">æ‹…å½“è€…å</label>
                    <input type="text" id="customerContact">
                </div>
                <div class="form-group">
                    <label for="customerDepartment">éƒ¨ç½²</label>
                    <input type="text" id="customerDepartment">
                </div>
            </div>
            
            <button class="btn" onclick="addCustomer()">é¡§å®¢è¿½åŠ </button>
            <button class="btn btn-secondary" onclick="clearCustomerForm()">ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢</button>
            
            <h3>ğŸ“‹ é¡§å®¢ä¸€è¦§</h3>
            <table id="customersTable">
                <thead>
                    <tr>
                        <th>ä¼šç¤¾å</th>
                        <th>ä½æ‰€</th>
                        <th>é›»è©±ç•ªå·</th>
                        <th>æ‹…å½“è€…</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- æœˆæ¬¡è«‹æ±‚æ›¸ã‚¿ãƒ– -->
        <div id="monthly-invoice" class="tab-content">
            <h2>ğŸ“„ æœˆæ¬¡è«‹æ±‚æ›¸ä½œæˆ</h2>
            
            <div class="info-box">
                <h3>ğŸ’¡ æœˆæ¬¡è«‹æ±‚æ›¸ã«ã¤ã„ã¦</h3>
                <p>é¡§å®¢ã¨å¹´æœˆã‚’æŒ‡å®šã™ã‚‹ã¨ã€è©²å½“ã™ã‚‹å·¥äº‹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚è«‹æ±‚ã—ãŸã„å·¥äº‹ã‚’ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é¸æŠã—ã¦è«‹æ±‚æ›¸ã‚’ä½œæˆã§ãã¾ã™ã€‚</p>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="invoiceCustomer">è«‹æ±‚å…ˆé¡§å®¢ <span class="required">*</span></label>
                    <select id="invoiceCustomer" required onchange="loadProjectsForInvoice()">
                        <option value="">é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="invoiceMonth">å¯¾è±¡å¹´æœˆ <span class="required">*</span></label>
                    <input type="month" id="invoiceMonth" required onchange="loadProjectsForInvoice()">
                </div>
            </div>
            
            <div id="projectSelectionArea" style="display: none; margin: 20px 0;">
                <h3>ğŸ“‹ è«‹æ±‚ã™ã‚‹å·¥äº‹ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
                <div class="info-box">
                    <p>ğŸ’¡ è¤‡æ•°ã®å·¥äº‹ã‚’é¸æŠã§ãã¾ã™ã€‚æœˆã‚’ã¾ãŸãå·¥äº‹ã‚‚è‡ªç”±ã«é¸æŠå¯èƒ½ã§ã™ã€‚</p>
                </div>
                <div id="projectCheckboxList" style="margin: 15px 0;"></div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="invoiceDate">è«‹æ±‚æ›¸ç™ºè¡Œæ—¥ <span class="required">*</span></label>
                    <input type="date" id="invoiceDate" required>
                </div>
                <div class="form-group">
                    <label for="invoiceNumber">è«‹æ±‚æ›¸ç•ªå·</label>
                    <input type="text" id="invoiceNumber" placeholder="è‡ªå‹•æ¡ç•ªã•ã‚Œã¾ã™">
                </div>
            </div>
            
            <button class="btn" onclick="generateInvoicePreview()" id="generateInvoiceBtn" disabled>è«‹æ±‚æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆ</button>
            
            <div id="invoicePreview" style="display: none;">
                <div class="print-button">
                    <button class="btn btn-success" onclick="generateInvoicePDF()">ğŸ“„ PDFå‡ºåŠ›</button>
                </div>
                
                <div class="invoice-container">
                    <div class="invoice-header">
                        <div class="company-info">
                            <div id="invoiceCompanyInfo"></div>
                        </div>
                        <div class="invoice-title">
                            <h1>è«‹æ±‚æ›¸</h1>
                        </div>
                        <div class="invoice-details">
                            <div>No. <span id="displayInvoiceNumber"></span></div>
                            <div id="displayInvoiceDate"></div>
                            <div class="company-seal" id="companySeal">å°</div>
                        </div>
                    </div>
                    
                    <div class="customer-info">
                        <div id="displayCustomerInfo"></div>
                    </div>
                    
                    <div class="total-amount">
                        <h2>ä»Šå›å¾¡è«‹æ±‚é¡</h2>
                        <div class="amount">Â¥<span id="displayTotalAmount">0</span></div>
                        <div style="font-size: 14px; margin-top: 10px;">
                            <span id="displaySubtotal">0</span> | <span id="displayTax">0</span>
                        </div>
                    </div>
                    
                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">æ‘˜è¦å</th>
                                <th style="width: 10%;">æ•°é‡</th>
                                <th style="width: 10%;">å˜ä½</th>
                                <th style="width: 15%;">å˜ä¾¡</th>
                                <th style="width: 15%;">é‡‘é¡</th>
                                <th style="width: 10%;">å‚™è€ƒ</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceItemsTable">
                        </tbody>
                    </table>
                    
                    <div class="bank-info">
                        <div id="displayBankInfo"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¨­å®šã‚¿ãƒ– -->
        <div id="settings" class="tab-content">
            <h2>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h2>
            
            <div class="settings-section">
                <h3>ğŸ¢ è‡ªç¤¾æƒ…å ±</h3>
                
                <div class="form-group">
                    <label for="companyName">ä¼šç¤¾å <span class="required">*</span></label>
                    <input type="text" id="companyName" placeholder="æœ‰é™ä¼šç¤¾ã‚¨ãƒ ã‚ºã‚¤ãƒ³ãƒ†ãƒªã‚¢">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="companyZip">éƒµä¾¿ç•ªå·</label>
                        <input type="text" id="companyZip" placeholder="144-0052">
                    </div>
                    <div class="form-group">
                        <label for="companyAddress">ä½æ‰€</label>
                        <input type="text" id="companyAddress" placeholder="æ±äº¬éƒ½å¤§ç”°åŒºå—éŒç”°1-26-7">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="companyPhone">é›»è©±ç•ªå·</label>
                        <input type="text" id="companyPhone" placeholder="03-3939-7057">
                    </div>
                    <div class="form-group">
                        <label for="companyFax">FAXç•ªå·</label>
                        <input type="text" id="companyFax" placeholder="03-3939-7657">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="companyEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" id="companyEmail">
                    </div>
                    <div class="form-group">
                        <label for="invoiceNumber">ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç•ªå·</label>
                        <input type="text" id="companyInvoiceNumber" placeholder="T1234567890123">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="companyRepresentative">ä»£è¡¨è€…å</label>
                    <input type="text" id="companyRepresentative">
                </div>
            </div>
            
            <div class="settings-section">
                <h3>ğŸ¦ æŒ¯è¾¼å…ˆæƒ…å ±</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="bankName">éŠ€è¡Œå</label>
                        <input type="text" id="bankName" placeholder="GMOã‚ãŠãã‚‰éŠ€è¡Œ">
                    </div>
                    <div class="form-group">
                        <label for="branchName">æ”¯åº—å</label>
                        <input type="text" id="branchName" placeholder="ãã˜æ”¯åº—">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="accountType">å£åº§ç¨®åˆ¥</label>
                        <select id="accountType">
                            <option value="æ™®é€š">æ™®é€š</option>
                            <option value="å½“åº§">å½“åº§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="accountNumber">å£åº§ç•ªå·</label>
                        <input type="text" id="accountNumber" placeholder="2057300">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="accountHolder">å£åº§åç¾©</label>
                    <input type="text" id="accountHolder" placeholder="ãƒ¦ï¼‰ã‚¨ãƒ ã‚ºã‚¤ãƒ³ãƒ†ãƒªã‚¢">
                </div>
            </div>
            
            <div class="settings-section">
                <h3>ğŸ”– ç¤¾å°è¨­å®š</h3>
                
                <div class="form-group">
                    <label for="companySeal">ç¤¾å°ç”»åƒ</label>
                    <div class="file-upload-area" onclick="document.getElementById('sealFile').click()">
                        <input type="file" id="sealFile" style="display: none;" accept="image/*" onchange="handleSealUpload(event)">
                        <div id="sealUploadText">
                            <p>ğŸ“· ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç¤¾å°ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                            <p style="font-size: 12px; color: #666;">PNGã€JPGå½¢å¼å¯¾å¿œ</p>
                        </div>
                        <img id="sealPreview" class="seal-preview" style="display: none;">
                    </div>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜</button>
            <button class="btn btn-secondary" onclick="loadSettings()">è¨­å®šã‚’èª­ã¿è¾¼ã¿</button>
        </div>

        <!-- æ—¢å­˜ã®ã‚¿ãƒ–ï¼ˆå·¥äº‹å°å¸³ç®¡ç†ï¼‰ -->
        <div id="projects" class="tab-content active">
            <h2>ğŸ—ï¸ å·¥äº‹å°å¸³ç®¡ç†</h2>
            
            <div class="form-group">
                <label for="projectName">å·¥äº‹å <span class="required">*</span></label>
                <input type="text" id="projectName" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="customerName">é¡§å®¢å <span class="required">*</span></label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label for="contractAmount">å¥‘ç´„é‡‘é¡ï¼ˆå††ï¼‰ <span class="required">*</span></label>
                    <input type="number" id="contractAmount" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="startDate">é–‹å§‹æ—¥ <span class="required">*</span></label>
                    <input type="date" id="startDate" required>
                </div>
                <div class="form-group">
                    <label for="expectedEndDate">å®Œäº†äºˆå®šæ—¥</label>
                    <input type="date" id="expectedEndDate">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="projectStatus">çŠ¶æ³</label>
                    <select id="projectStatus">
                        <option value="è¨ˆç”»ä¸­">è¨ˆç”»ä¸­</option>
                        <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
                        <option value="å®Œäº†">å®Œäº†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="paymentStatus">å…¥é‡‘çŠ¶æ³</label>
                    <select id="paymentStatus">
                        <option value="æœªå…¥é‡‘">æœªå…¥é‡‘</option>
                        <option value="éƒ¨åˆ†å…¥é‡‘">éƒ¨åˆ†å…¥é‡‘</option>
                        <option value="å®Œäº†">å®Œäº†</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="projectManager">æ‹…å½“è€…</label>
                    <input type="text" id="projectManager">
                </div>
                <div class="form-group">
                    <label for="projectLocation">å·¥äº‹å ´æ‰€</label>
                    <input type="text" id="projectLocation">
                </div>
            </div>
            
            <div class="form-group">
                <label for="projectNotes">å‚™è€ƒ</label>
                <textarea id="projectNotes" rows="3"></textarea>
            </div>
            
            <button class="btn" onclick="addProject()" id="projectSubmitBtn">å·¥äº‹è¿½åŠ </button>
            <button class="btn btn-secondary" onclick="clearProjectForm()">ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢</button>
            
            <table id="projectsTable">
                <thead>
                    <tr>
                        <th>å·¥äº‹å</th>
                        <th>é¡§å®¢å</th>
                        <th>å¥‘ç´„é‡‘é¡</th>
                        <th>é–‹å§‹æ—¥</th>
                        <th>å®Œäº†äºˆå®š</th>
                        <th>çŠ¶æ³</th>
                        <th>å…¥é‡‘çŠ¶æ³</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- æ—¢å­˜ã®ã‚¿ãƒ–ï¼ˆçµŒè²»ç®¡ç†ï¼‰ -->
        <div id="expenses" class="tab-content">
            <h2>ğŸ’° çµŒè²»ç®¡ç†</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="expenseDate">æ—¥ä»˜ <span class="required">*</span></label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="form-group">
                    <label for="relatedProject">é–¢é€£å·¥äº‹</label>
                    <select id="relatedProject">
                        <option value="">é–¢é€£å·¥äº‹ã‚’é¸æŠ</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="expenseCategory">è²»ç›® <span class="required">*</span></label>
                    <select id="expenseCategory" required>
                        <option value="">è²»ç›®ã‚’é¸æŠ</option>
                        <option value="ææ–™è²»">ææ–™è²»</option>
                        <option value="å¤–æ³¨è²»">å¤–æ³¨è²»</option>
                        <option value="äº¤é€šè²»">äº¤é€šè²»</option>
                        <option value="å·¥å…·è²»">å·¥å…·è²»</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="expenseAmount">é‡‘é¡ï¼ˆå††ï¼‰ <span class="required">*</span></label>
                    <input type="number" id="expenseAmount" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="vendor">å–å¼•å…ˆ</label>
                    <input type="text" id="vendor">
                </div>
                <div class="form-group">
                    <label for="paymentMethod">æ”¯æ‰•æ–¹æ³•</label>
                    <select id="paymentMethod">
                        <option value="ç¾é‡‘">ç¾é‡‘</option>
                        <option value="éŠ€è¡ŒæŒ¯è¾¼">éŠ€è¡ŒæŒ¯è¾¼</option>
                        <option value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</option>
                        <option value="é›»å­ãƒãƒãƒ¼">é›»å­ãƒãƒãƒ¼</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="expenseDescription">æ‘˜è¦</label>
                <input type="text" id="expenseDescription">
            </div>
            
            <button class="btn" onclick="addExpense()" id="expenseSubmitBtn">çµŒè²»è¿½åŠ </button>
            <button class="btn btn-secondary" onclick="clearExpenseForm()">ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢</button>
            
            <table id="expensesTable">
                <thead>
                    <tr>
                        <th>æ—¥ä»˜</th>
                        <th>é–¢é€£å·¥äº‹</th>
                        <th>è²»ç›®</th>
                        <th>é‡‘é¡</th>
                        <th>å–å¼•å…ˆ</th>
                        <th>æ”¯æ‰•æ–¹æ³•</th>
                        <th>æ‘˜è¦</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- æ—¢å­˜ã®ã‚¿ãƒ–ï¼ˆä»•å…¥ã‚Œç®¡ç†ï¼‰ -->
        <div id="purchases" class="tab-content">
            <h2>ğŸ›’ ä»•å…¥ã‚Œç®¡ç†</h2>
            
            <div class="info-box">
                <h3>ğŸ’¡ ä»•å…¥ã‚Œç®¡ç†ã®æµã‚Œ</h3>
                <p>â‘  ç¾å ´ã”ã¨ã«ç™ºæ³¨ã—ãŸä»•å…¥ã‚Œã‚’è¨˜éŒ² â†’ â‘¡ æœˆæœ«ã«ä»•å…¥å…ˆã‹ã‚‰è«‹æ±‚æ›¸ãŒå±Šã â†’ â‘¢ ç¿Œæœˆã«æ”¯æ‰•ã†<br>
                ã€Œè«‹æ±‚æœˆã€ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€æœˆã”ã¨ã®æ”¯æ‰•äºˆå®šã‚’ç®¡ç†ã§ãã¾ã™ã€‚</p>
            </div>

            <div class="form-group">
                <label for="purchaseProject">é–¢é€£å·¥äº‹</label>
                <select id="purchaseProject">
                    <option value="">å·¥äº‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="purchaseDate">ä»•å…¥æ—¥ <span class="required">*</span></label>
                    <input type="date" id="purchaseDate" required>
                </div>
                <div class="form-group">
                    <label for="purchaseType">ä»•å…¥ã‚Œç¨®åˆ¥ <span class="required">*</span></label>
                    <select id="purchaseType" required>
                        <option value="">ç¨®åˆ¥ã‚’é¸æŠ</option>
                        <option value="ææ–™">ææ–™</option>
                        <option value="è¨­å‚™">è¨­å‚™</option>
                        <option value="å·¥å…·">å·¥å…·</option>
                        <option value="å¤–æ³¨">å¤–æ³¨</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="purchaseAmount">ä»•å…¥ã‚Œé‡‘é¡ï¼ˆå††ï¼‰ <span class="required">*</span></label>
                    <input type="number" id="purchaseAmount" required>
                </div>
                <div class="form-group">
                    <label for="purchaseVendor">ä»•å…¥ã‚Œå…ˆ <span class="required">*</span></label>
                    <input type="text" id="purchaseVendor" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="billingMonth">è«‹æ±‚æœˆï¼ˆæœˆæœ«ç· ã‚ï¼‰</label>
                    <input type="month" id="billingMonth" title="ä»•å…¥å…ˆã‹ã‚‰è«‹æ±‚ãŒæ¥ã‚‹æœˆã‚’æŒ‡å®š">
                </div>
                <div class="form-group">
                    <label for="paymentDueMonth">æ”¯æ‰•äºˆå®šæœˆï¼ˆç¿Œæœˆæ‰•ã„ï¼‰</label>
                    <input type="month" id="paymentDueMonth" title="å®Ÿéš›ã«æ”¯æ‰•ã†æœˆã‚’æŒ‡å®š">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="purchasePaymentStatus">æ”¯æ‰•çŠ¶æ³</label>
                    <select id="purchasePaymentStatus">
                        <option value="æœªæ‰•ã„">æœªæ‰•ã„</option>
                        <option value="æ”¯æ‰•æ¸ˆã¿">æ”¯æ‰•æ¸ˆã¿</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="purchasePaymentMethod">æ”¯æ‰•æ–¹æ³•</label>
                    <select id="purchasePaymentMethod">
                        <option value="éŠ€è¡ŒæŒ¯è¾¼">éŠ€è¡ŒæŒ¯è¾¼</option>
                        <option value="ç¾é‡‘">ç¾é‡‘</option>
                        <option value="ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</option>
                        <option value="æ‰‹å½¢">æ‰‹å½¢</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="actualPaymentDate">å®Ÿéš›ã®æ”¯æ‰•æ—¥</label>
                    <input type="date" id="actualPaymentDate" title="æ”¯æ‰•ã„å®Œäº†å¾Œã«è¨˜éŒ²">
                </div>
                <div class="form-group">
                    <label for="vendorInvoiceNumber">ä»•å…¥å…ˆä¼ç¥¨ç•ªå·</label>
                    <input type="text" id="vendorInvoiceNumber">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="taxCategory">ç¨å‹™åŒºåˆ†</label>
                    <select id="taxCategory">
                        <option value="èª²ç¨">èª²ç¨</option>
                        <option value="éèª²ç¨">éèª²ç¨</option>
                        <option value="ä¸èª²ç¨">ä¸èª²ç¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="productDetails">å•†å“åãƒ»è©³ç´°</label>
                    <input type="text" id="productDetails">
                </div>
            </div>
            
            <button class="btn" onclick="addPurchase()" id="purchaseSubmitBtn">ä»•å…¥ã‚Œè¿½åŠ </button>
            <button class="btn btn-secondary" onclick="clearPurchaseForm()">ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢</button>
            
            <table id="purchasesTable">
                <thead>
                    <tr>
                        <th>ä»•å…¥æ—¥</th>
                        <th>é–¢é€£å·¥äº‹</th>
                        <th>ä»•å…¥ã‚Œç¨®åˆ¥</th>
                        <th>å•†å“åãƒ»è©³ç´°</th>
                        <th>ä»•å…¥ã‚Œå…ˆ</th>
                        <th>é‡‘é¡</th>
                        <th>è«‹æ±‚æœˆ</th>
                        <th>æ”¯æ‰•äºˆå®šæœˆ</th>
                        <th>æ”¯æ‰•çŠ¶æ³</th>
                        <th>å®Ÿæ”¯æ‰•æ—¥</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- æ®‹ã‚Šã®ã‚¿ãƒ–ã¯æ—¢å­˜ã®ã‚‚ã®ã‚’ãã®ã¾ã¾ç¶­æŒ... -->
        <!-- çœç•¥ï¼ˆå®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã§ã¯å…¨ã¦å«ã¾ã‚Œã¾ã™ï¼‰ -->

    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let projects = JSON.parse(localStorage.getItem('projects')) || [];
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let purchases = JSON.parse(localStorage.getItem('purchases')) || [];
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let payments = JSON.parse(localStorage.getItem('payments')) || [];
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let companySettings = JSON.parse(localStorage.getItem('companySettings')) || {};

        let editingProjectId = null;
        let editingExpenseId = null;
        let editingPurchaseId = null;
        let editingInvoiceId = null;
        let editingPaymentId = null;
        let editingCustomerId = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            updateProjectDropdowns();
            updateCustomerDropdowns();
            displayProjects();
            displayExpenses();
            displayPurchases();
            displayInvoices();
            displayPayments();
            displayCustomers();
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            buttons.forEach(button => {
                button.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        // é¡§å®¢ç®¡ç†æ©Ÿèƒ½
        function addCustomer() {
            const company = document.getElementById('customerCompany').value;
            const zip = document.getElementById('customerZip').value;
            const address = document.getElementById('customerAddress').value;
            const phone = document.getElementById('customerPhone').value;
            const email = document.getElementById('customerEmail').value;
            const contact = document.getElementById('customerContact').value;
            const department = document.getElementById('customerDepartment').value;

            if (!company) {
                alert('ä¼šç¤¾åã¯å¿…é ˆã§ã™ã€‚');
                return;
            }

            const customer = {
                id: editingCustomerId || Date.now(),
                company,
                zip,
                address,
                phone,
                email,
                contact,
                department
            };

            if (editingCustomerId) {
                const index = customers.findIndex(c => c.id === editingCustomerId);
                customers[index] = customer;
                editingCustomerId = null;
                document.getElementById('customerSubmitBtn').textContent = 'é¡§å®¢è¿½åŠ ';
            } else {
                customers.push(customer);
            }

            localStorage.setItem('customers', JSON.stringify(customers));
            displayCustomers();
            updateCustomerDropdowns();
            clearCustomerForm();
        }

        function displayCustomers() {
            const tbody = document.querySelector('#customersTable tbody');
            tbody.innerHTML = '';

            customers.forEach(customer => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${customer.company}</td>
                    <td>${customer.address}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.contact}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editCustomer(${customer.id})">ç·¨é›†</button>
                        <button class="btn btn-danger" onclick="deleteCustomer(${customer.id})">å‰Šé™¤</button>
                    </td>
                `;
            });
        }

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;

            document.getElementById('customerCompany').value = customer.company;
            document.getElementById('customerZip').value = customer.zip || '';
            document.getElementById('customerAddress').value = customer.address || '';
            document.getElementById('customerPhone').value = customer.phone || '';
            document.getElementById('customerEmail').value = customer.email || '';
            document.getElementById('customerContact').value = customer.contact || '';
            document.getElementById('customerDepartment').value = customer.department || '';

            editingCustomerId = id;
        }

        function deleteCustomer(id) {
            if (confirm('ã“ã®é¡§å®¢ã‚’å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                customers = customers.filter(c => c.id !== id);
                localStorage.setItem('customers', JSON.stringify(customers));
                displayCustomers();
                updateCustomerDropdowns();
            }
        }

        function clearCustomerForm() {
            document.getElementById('customerCompany').value = '';
            document.getElementById('customerZip').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerContact').value = '';
            document.getElementById('customerDepartment').value = '';
            editingCustomerId = null;
        }

        // é¡§å®¢ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ›´æ–°
        function updateCustomerDropdowns() {
            const dropdown = document.getElementById('invoiceCustomer');
            dropdown.innerHTML = '<option value="">é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.company;
                dropdown.appendChild(option);
            });
        }

        // è¨­å®šç®¡ç†æ©Ÿèƒ½
        function saveSettings() {
            const settings = {
                companyName: document.getElementById('companyName').value,
                companyZip: document.getElementById('companyZip').value,
                companyAddress: document.getElementById('companyAddress').value,
                companyPhone: document.getElementById('companyPhone').value,
                companyFax: document.getElementById('companyFax').value,
                companyEmail: document.getElementById('companyEmail').value,
                companyInvoiceNumber: document.getElementById('companyInvoiceNumber').value,
                companyRepresentative: document.getElementById('companyRepresentative').value,
                bankName: document.getElementById('bankName').value,
                branchName: document.getElementById('branchName').value,
                accountType: document.getElementById('accountType').value,
                accountNumber: document.getElementById('accountNumber').value,
                accountHolder: document.getElementById('accountHolder').value,
                companySeal: document.getElementById('sealPreview').src || ''
            };

            localStorage.setItem('companySettings', JSON.stringify(settings));
            companySettings = settings;
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('companySettings')) || {};
            companySettings = settings;

            document.getElementById('companyName').value = settings.companyName || '';
            document.getElementById('companyZip').value = settings.companyZip || '';
            document.getElementById('companyAddress').value = settings.companyAddress || '';
            document.getElementById('companyPhone').value = settings.companyPhone || '';
            document.getElementById('companyFax').value = settings.companyFax || '';
            document.getElementById('companyEmail').value = settings.companyEmail || '';
            document.getElementById('companyInvoiceNumber').value = settings.companyInvoiceNumber || '';
            document.getElementById('companyRepresentative').value = settings.companyRepresentative || '';
            document.getElementById('bankName').value = settings.bankName || '';
            document.getElementById('branchName').value = settings.branchName || '';
            document.getElementById('accountType').value = settings.accountType || '';
            document.getElementById('accountNumber').value = settings.accountNumber || '';
            document.getElementById('accountHolder').value = settings.accountHolder || '';

            if (settings.companySeal) {
                document.getElementById('sealPreview').src = settings.companySeal;
                document.getElementById('sealPreview').style.display = 'block';
            }
        }

        function handleSealUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('sealPreview').src = e.target.result;
                    document.getElementById('sealPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // æœˆæ¬¡è«‹æ±‚æ›¸æ©Ÿèƒ½ - å·¥äº‹é¸æŠãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
        function loadProjectsForInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            const month = document.getElementById('invoiceMonth').value;

            if (!customerId || !month) {
                document.getElementById('projectSelectionArea').style.display = 'none';
                document.getElementById('generateInvoiceBtn').disabled = true;
                return;
            }

            const customer = customers.find(c => c.id == customerId);
            if (!customer) return;

            // è©²å½“æœˆã®å·¥äº‹ã‚’å–å¾—ï¼ˆå‰å¾Œ1ãƒ¶æœˆã‚‚å«ã‚€ï¼‰
            const targetDate = new Date(month);
            const candidateProjects = projects.filter(project => {
                if (project.customerName !== customer.company) return false;
                
                const projectDate = new Date(project.startDate);
                const monthDiff = (targetDate.getFullYear() - projectDate.getFullYear()) * 12 + 
                                 (targetDate.getMonth() - projectDate.getMonth());
                
                // å‰å¾Œ1ãƒ¶æœˆã®å·¥äº‹ã‚‚è¡¨ç¤º
                return Math.abs(monthDiff) <= 1;
            });

            if (candidateProjects.length === 0) {
                document.getElementById('projectSelectionArea').style.display = 'none';
                document.getElementById('generateInvoiceBtn').disabled = true;
                alert('è©²å½“ã™ã‚‹å·¥äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
            const listHtml = candidateProjects.map(project => `
                <div style="padding: 10px; margin: 5px 0; border: 1px solid #e2e8f0; border-radius: 5px; background: #f7fafc;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" 
                               class="project-checkbox" 
                               value="${project.id}" 
                               onchange="updateInvoiceButtonState()" 
                               style="margin-right: 10px; width: 20px; height: 20px;">
                        <div style="flex-grow: 1;">
                            <strong>${project.projectName}</strong><br>
                            <span style="font-size: 13px; color: #666;">
                                é–‹å§‹æ—¥: ${project.startDate} | é‡‘é¡: Â¥${project.contractAmount.toLocaleString()}
                            </span>
                        </div>
                    </label>
                </div>
            `).join('');

            document.getElementById('projectCheckboxList').innerHTML = listHtml;
            document.getElementById('projectSelectionArea').style.display = 'block';
            document.getElementById('generateInvoiceBtn').disabled = true;
        }

        function updateInvoiceButtonState() {
            const checkedBoxes = document.querySelectorAll('.project-checkbox:checked');
            document.getElementById('generateInvoiceBtn').disabled = checkedBoxes.length === 0;
        }

        function generateInvoicePreview() {
            const customerId = document.getElementById('invoiceCustomer').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            let invoiceNumber = document.getElementById('invoiceNumber').value;

            if (!customerId || !invoiceDate) {
                alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // é¸æŠã•ã‚ŒãŸå·¥äº‹ã‚’å–å¾—
            const checkedBoxes = document.querySelectorAll('.project-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('è«‹æ±‚ã™ã‚‹å·¥äº‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const selectedProjectIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
            const selectedProjects = projects.filter(p => selectedProjectIds.includes(p.id));

            const customer = customers.find(c => c.id == customerId);
            if (!customer) {
                alert('é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            // è«‹æ±‚æ›¸ç•ªå·ã®è‡ªå‹•ç”Ÿæˆ
            if (!invoiceNumber) {
                const existingNumbers = invoices.map(inv => inv.number).filter(n => n);
                let maxNumber = 500000; // é–‹å§‹ç•ªå·
                existingNumbers.forEach(num => {
                    const parsed = parseInt(num.replace(/[^0-9]/g, ''));
                    if (parsed > maxNumber) maxNumber = parsed;
                });
                invoiceNumber = (maxNumber + 1).toString();
                document.getElementById('invoiceNumber').value = invoiceNumber;
            }

            // è«‹æ±‚æ›¸å†…å®¹ã®ç”Ÿæˆ
            displayInvoicePreview(customer, selectedProjects, invoiceNumber, invoiceDate);
        }

        function displayInvoicePreview(customer, projects, invoiceNumber, invoiceDate) {
            // è‡ªç¤¾æƒ…å ±è¡¨ç¤º
            document.getElementById('invoiceCompanyInfo').innerHTML = `
                ã€’${companySettings.companyZip || ''}<br>
                ${companySettings.companyAddress || ''}<br>
                ${companySettings.companyName || ''}<br>
                TEL. ${companySettings.companyPhone || ''} FAX. ${companySettings.companyFax || ''}<br>
                æ‹…å½“è€…ï¼š${companySettings.companyRepresentative || ''}
            `;

            // é¡§å®¢æƒ…å ±è¡¨ç¤º
            document.getElementById('displayCustomerInfo').innerHTML = `
                ${customer.company} å¾¡ä¸­
            `;

            // è«‹æ±‚æ›¸è©³ç´°
            document.getElementById('displayInvoiceNumber').textContent = invoiceNumber;
            document.getElementById('displayInvoiceDate').textContent = new Date(invoiceDate).toLocaleDateString('ja-JP', {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            // ç¤¾å°è¡¨ç¤º
            const sealElement = document.getElementById('companySeal');
            if (companySettings.companySeal) {
                sealElement.innerHTML = `<img src="${companySettings.companySeal}" style="width: 100%; height: 100%; object-fit: contain;">`;
            } else {
                sealElement.textContent = 'å°';
            }

            // æ˜ç´°ä½œæˆ
            const tbody = document.getElementById('invoiceItemsTable');
            tbody.innerHTML = '';
            
            let subtotal = 0;
            
            projects.forEach(project => {
                const row = tbody.insertRow();
                const amount = parseInt(project.contractAmount);
                subtotal += amount;
                
                row.innerHTML = `
                    <td class="description">${project.projectName}</td>
                    <td>1</td>
                    <td>å¼</td>
                    <td class="amount">${amount.toLocaleString()}</td>
                    <td class="amount">${amount.toLocaleString()}</td>
                    <td></td>
                `;
            });

            // ç©ºè¡Œã‚’è¿½åŠ ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ï¼‰
            for (let i = projects.length; i < 15; i++) {
                const row = tbody.insertRow();
                row.innerHTML = '<td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td>';
            }

            // åˆè¨ˆè¨ˆç®—
            const tax = Math.floor(subtotal * 0.1);
            const total = subtotal + tax;

            document.getElementById('displaySubtotal').textContent = subtotal.toLocaleString();
            document.getElementById('displayTax').textContent = tax.toLocaleString();
            document.getElementById('displayTotalAmount').textContent = total.toLocaleString();

            // æŒ¯è¾¼å…ˆæƒ…å ±
            document.getElementById('displayBankInfo').innerHTML = `
                <strong>ãŠæŒ¯è¾¼å…ˆï¼š</strong><br>
                ${companySettings.bankName || ''} ${companySettings.branchName || ''}<br>
                ${companySettings.accountType || ''}é é‡‘ ${companySettings.accountNumber || ''}<br>
                ${companySettings.accountHolder || ''}
            `;

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            document.getElementById('invoicePreview').style.display = 'block';
        }

        function generateInvoicePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // PDFç”Ÿæˆã®å®Ÿè£…ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            doc.setFont('helvetica');
            doc.setFontSize(20);
            doc.text('è«‹æ±‚æ›¸', 105, 30, { align: 'center' });

            // è©³ç´°ãª PDF ç”Ÿæˆã¯ã‚ˆã‚Šè¤‡é›‘ãªå®Ÿè£…ãŒå¿…è¦
            // ã“ã“ã§ã¯åŸºæœ¬çš„ãªä¿å­˜æ©Ÿèƒ½ã®ã¿å®Ÿè£…
            doc.save('invoice.pdf');
            
            alert('PDFå‡ºåŠ›æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚ç¾åœ¨ã¯å°åˆ·æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
        }

        // æ—¢å­˜ã®å·¥äº‹ç®¡ç†æ©Ÿèƒ½
        function addProject() {
            const projectName = document.getElementById('projectName').value;
            const customerName = document.getElementById('customerName').value;
            const contractAmount = document.getElementById('contractAmount').value;
            const startDate = document.getElementById('startDate').value;
            const expectedEndDate = document.getElementById('expectedEndDate').value;
            const projectStatus = document.getElementById('projectStatus').value;
            const paymentStatus = document.getElementById('paymentStatus').value;
            const projectManager = document.getElementById('projectManager').value;
            const projectLocation = document.getElementById('projectLocation').value;
            const projectNotes = document.getElementById('projectNotes').value;

            if (!projectName || !customerName || !contractAmount || !startDate) {
                alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const project = {
                id: editingProjectId || Date.now(),
                projectName,
                customerName,
                contractAmount: parseInt(contractAmount),
                startDate,
                expectedEndDate,
                projectStatus,
                paymentStatus,
                projectManager,
                projectLocation,
                projectNotes
            };

            if (editingProjectId) {
                const index = projects.findIndex(p => p.id === editingProjectId);
                projects[index] = project;
                editingProjectId = null;
                document.getElementById('projectSubmitBtn').textContent = 'å·¥äº‹è¿½åŠ ';
            } else {
                projects.push(project);
            }

            localStorage.setItem('projects', JSON.stringify(projects));
            displayProjects();
            updateProjectDropdowns();
            clearProjectForm();
        }

        function displayProjects() {
            const tbody = document.querySelector('#projectsTable tbody');
            tbody.innerHTML = '';

            projects.forEach(project => {
                const row = tbody.insertRow();
                const statusClass = project.projectStatus === 'å®Œäº†' ? 'status-completed' : 
                                  project.projectStatus === 'é€²è¡Œä¸­' ? 'status-progress' : 'status-planning';
                const paymentClass = project.paymentStatus === 'å®Œäº†' ? 'status-paid' : 
                                   project.paymentStatus === 'éƒ¨åˆ†å…¥é‡‘' ? 'status-partial' : 'status-unpaid';
                
                row.innerHTML = `
                    <td>${project.projectName}</td>
                    <td>${project.customerName}</td>
                    <td>Â¥${project.contractAmount.toLocaleString()}</td>
                    <td>${project.startDate}</td>
                    <td>${project.expectedEndDate || '-'}</td>
                    <td class="${statusClass}">${project.projectStatus}</td>
                    <td class="${paymentClass}">${project.paymentStatus}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editProject(${project.id})">ç·¨é›†</button>
                        <button class="btn btn-danger" onclick="deleteProject(${project.id})">å‰Šé™¤</button>
                    </td>
                `;
            });
        }

        function editProject(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;

            document.getElementById('projectName').value = project.projectName;
            document.getElementById('customerName').value = project.customerName;
            document.getElementById('contractAmount').value = project.contractAmount;
            document.getElementById('startDate').value = project.startDate;
            document.getElementById('expectedEndDate').value = project.expectedEndDate;
            document.getElementById('projectStatus').value = project.projectStatus;
            document.getElementById('paymentStatus').value = project.paymentStatus;
            document.getElementById('projectManager').value = project.projectManager || '';
            document.getElementById('projectLocation').value = project.projectLocation || '';
            document.getElementById('projectNotes').value = project.projectNotes || '';

            editingProjectId = id;
            document.getElementById('projectSubmitBtn').textContent = 'æ›´æ–°';
        }

        function deleteProject(id) {
            if (confirm('ã“ã®å·¥äº‹ã‚’å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                projects = projects.filter(p => p.id !== id);
                localStorage.setItem('projects', JSON.stringify(projects));
                displayProjects();
                updateProjectDropdowns();
            }
        }

        function clearProjectForm() {
            document.getElementById('projectName').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('contractAmount').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('expectedEndDate').value = '';
            document.getElementById('projectStatus').value = 'è¨ˆç”»ä¸­';
            document.getElementById('paymentStatus').value = 'æœªå…¥é‡‘';
            document.getElementById('projectManager').value = '';
            document.getElementById('projectLocation').value = '';
            document.getElementById('projectNotes').value = '';
            editingProjectId = null;
            document.getElementById('projectSubmitBtn').textContent = 'å·¥äº‹è¿½åŠ ';
        }

        function updateProjectDropdowns() {
            const dropdowns = [
                document.getElementById('relatedProject'),
                document.getElementById('purchaseProject')
            ];

            dropdowns.forEach(dropdown => {
                if (!dropdown) return;
                
                const currentValue = dropdown.value;
                dropdown.innerHTML = '<option value="">å·¥äº‹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `${project.projectName} (${project.customerName})`;
                    dropdown.appendChild(option);
                });

                if (currentValue) {
                    dropdown.value = currentValue;
                }
            });

            // å·¥äº‹ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
            if (projects.length === 0) {
                dropdowns.forEach(dropdown => {
                    if (dropdown) {
                        dropdown.innerHTML = '<option value="">ã¾ãšå·¥äº‹å°å¸³ã§å·¥äº‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</option>';
                    }
                });
            }
        }

        // çµŒè²»ç®¡ç†æ©Ÿèƒ½ï¼ˆç°¡ç•¥ç‰ˆï¼‰
        function addExpense() {
            // å®Ÿè£…ã¯æ—¢å­˜ã¨åŒæ§˜
            alert('çµŒè²»ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚');
        }

        function displayExpenses() {
            // å®Ÿè£…ã¯æ—¢å­˜ã¨åŒæ§˜
        }

        function clearExpenseForm() {
            // å®Ÿè£…ã¯æ—¢å­˜ã¨åŒæ§˜
        }

        // ä»•å…¥ã‚Œç®¡ç†æ©Ÿèƒ½ï¼ˆç°¡ç•¥ç‰ˆï¼‰
        function addPurchase() {
            // å®Ÿè£…ã¯æ—¢å­˜ã¨åŒæ§˜
            alert('ä»•å…¥ã‚ŒãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚');
        }

        function displayPurchases() {
            // å®Ÿè£…ã¯æ—¢å­˜ã¨åŒæ§˜
        }

        function clearPurchaseForm() {
            // å®Ÿè£…ã¯æ—¢å­˜ã¨åŒæ§˜
        }

        // ãã®ä»–ã®æ—¢å­˜æ©Ÿèƒ½ã‚‚åŒæ§˜ã«å®Ÿè£…
        function displayInvoices() {}
        function displayPayments() {}

    </script>
</body>
</html>